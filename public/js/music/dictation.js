/*! For license information please see dictation.js.LICENSE.txt */
(()=>{"use strict";var t=["music-font__sharp","music-font__doublesharp","music-font__flat","music-font__doubleflat","music-font__natural"],e={treble:{"--clef-width":"140px","--clef-height":"calc(var(--staff-line-gap) * 6)","--clef-top":"54px","--clef-left-nudge":"28px"},bass:{"--clef-width":"76px","--clef-height":"calc(var(--staff-line-gap) * 6)","--clef-top":"35px","--clef-left-nudge":"-12px"},alto:{"--clef-width":"88px","--clef-height":"calc(var(--staff-line-gap) * 6)","--clef-top":"47.5px","--clef-left-nudge":"-10px"},tenor:{"--clef-width":"88px","--clef-height":"calc(var(--staff-line-gap) * 6)","--clef-top":"22.5px","--clef-left-nudge":"-10px"}};function n(t,e,n){var i=t.getPropertyValue(e),a=parseFloat(i);return Number.isFinite(a)?a:n}function i(t){var e=t.originalEvent||t;return e.touches&&e.touches.length?{x:e.touches[0].pageX,y:e.touches[0].pageY}:e.changedTouches&&e.changedTouches.length?{x:e.changedTouches[0].pageX,y:e.changedTouches[0].pageY}:{x:e.pageX,y:e.pageY}}function a(t){var e=t.originalEvent||t;return e&&null!=e.pointerId?e.pointerId:null}function r(t){return Array.isArray(t)&&t.length?t[Math.floor(Math.random()*t.length)]:null}function o(t){if(null==t)return null;var e=String(t||"treble").toLowerCase();return"bass"===e?"bass":"alto"===e?"alto":"tenor"===e?"tenor":"treble"}function s(t){return t.hasClass("music-font__sharp")?"sharp":t.hasClass("music-font__flat")?"flat":t.hasClass("music-font__natural")?"natural":null}function l(t,e){return"sharp"===e?"music-font__doublesharp"===t||"music-font__sharp"===t?"music-font__doublesharp":"music-font__sharp":"flat"===e?"music-font__doubleflat"===t||"music-font__flat"===t?"music-font__doubleflat":"music-font__flat":"natural"===e?"music-font__natural":t||null}function c(t,e){return"sharp"===e&&"music-font__doublesharp"===t||"flat"===e&&"music-font__doubleflat"===t}function u(t,e,n){var i,a=function(t,e){var n,i;switch(t.getClef()){case"bass":n=36,i=4;break;case"alto":n=48,i=3;break;case"tenor":n=48,i=1;break;default:n=60,i=2}var a=i+e,r=Math.floor(a/7),o=(a%7+7)%7,s=Math.floor(n/12)-1;return{letter:["C","D","E","F","G","A","B"][o],octave:s+r}}(t,e),r=a.letter,o=a.octave,s=(i=n)?i.includes("music-font__doublesharp")?"##":i.includes("music-font__sharp")?"#":i.includes("music-font__doubleflat")?"bb":i.includes("music-font__flat")?"b":"":"";return"".concat(r).concat(s).concat(o)}function f(t){return f="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},f(t)}function h(){var t,e,n="function"==typeof Symbol?Symbol:{},i=n.iterator||"@@iterator",a=n.toStringTag||"@@toStringTag";function r(n,i,a,r){var l=i&&i.prototype instanceof s?i:s,c=Object.create(l.prototype);return d(c,"_invoke",function(n,i,a){var r,s,l,c=0,u=a||[],f=!1,h={p:0,n:0,v:t,a:d,f:d.bind(t,4),d:function(e,n){return r=e,s=0,l=t,h.n=n,o}};function d(n,i){for(s=n,l=i,e=0;!f&&c&&!a&&e<u.length;e++){var a,r=u[e],d=h.p,p=r[2];n>3?(a=p===i)&&(l=r[(s=r[4])?5:(s=3,3)],r[4]=r[5]=t):r[0]<=d&&((a=n<2&&d<r[1])?(s=0,h.v=i,h.n=r[1]):d<p&&(a=n<3||r[0]>i||i>p)&&(r[4]=n,r[5]=i,h.n=p,s=0))}if(a||n>1)return o;throw f=!0,i}return function(a,u,p){if(c>1)throw TypeError("Generator is already running");for(f&&1===u&&d(u,p),s=u,l=p;(e=s<2?t:l)||!f;){r||(s?s<3?(s>1&&(h.n=-1),d(s,l)):h.n=l:h.v=l);try{if(c=2,r){if(s||(a="next"),e=r[a]){if(!(e=e.call(r,l)))throw TypeError("iterator result is not an object");if(!e.done)return e;l=e.value,s<2&&(s=0)}else 1===s&&(e=r.return)&&e.call(r),s<2&&(l=TypeError("The iterator does not provide a '"+a+"' method"),s=1);r=t}else if((e=(f=h.n<0)?l:n.call(i,h))!==o)break}catch(e){r=t,s=1,l=e}finally{c=1}}return{value:e,done:f}}}(n,a,r),!0),c}var o={};function s(){}function l(){}function c(){}e=Object.getPrototypeOf;var u=[][i]?e(e([][i]())):(d(e={},i,function(){return this}),e),f=c.prototype=s.prototype=Object.create(u);function p(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,c):(t.__proto__=c,d(t,a,"GeneratorFunction")),t.prototype=Object.create(f),t}return l.prototype=c,d(f,"constructor",c),d(c,"constructor",l),l.displayName="GeneratorFunction",d(c,a,"GeneratorFunction"),d(f),d(f,a,"Generator"),d(f,i,function(){return this}),d(f,"toString",function(){return"[object Generator]"}),(h=function(){return{w:r,m:p}})()}function d(t,e,n,i){var a=Object.defineProperty;try{a({},"",{})}catch(t){a=0}d=function(t,e,n,i){function r(e,n){d(t,e,function(t){return this._invoke(e,n,t)})}e?a?a(t,e,{value:n,enumerable:!i,configurable:!i,writable:!i}):t[e]=n:(r("next",0),r("throw",1),r("return",2))},d(t,e,n,i)}function p(t,e,n,i,a,r,o){try{var s=t[r](o),l=s.value}catch(t){return void n(t)}s.done?e(l):Promise.resolve(l).then(i,a)}function v(t){return function(){var e=this,n=arguments;return new Promise(function(i,a){var r=t.apply(e,n);function o(t){p(r,i,a,o,s,"next",t)}function s(t){p(r,i,a,o,s,"throw",t)}o(void 0)})}}function _(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,m(i.key),i)}}function m(t){var e=function(t,e){if("object"!=f(t)||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var i=n.call(t,e||"default");if("object"!=f(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==f(e)?e:e+""}var y=function(){return r=function t(e,i){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.$el=e;var a=getComputedStyle(e[0]);this.opts=$.extend({paddingX:n(a,"--staff-padding-x",20),lineGap:n(a,"--staff-line-gap",16),lineThickness:n(a,"--staff-line-thickness",3),noteOverlapGap:n(a,"--note-overlap-gap",-6),noteIdPrefix:"n",clefUrls:null,clef:null,clefUrl:null,autoClef:!0,maxLedgerAbove:2,maxLedgerBelow:2,accidentalTopPx:20,accidentalGapPx:16,getMaxUserNotes:function(){return 1/0},sound:!0,accSnapMaxPx:1.2*n(a,"--staff-line-gap",25)},i||{}),this.opts.clef=null==this.opts.clef?null:o(this.opts.clef),this.opts.clef&&!this.opts.clefUrl&&(this.opts.clefUrl=this._clefUrlFor(this.opts.clef)),this.opts.stepSize=this.opts.lineGap/2,this.$el.css("position","relative"),this._idCounter=1,this._drag={isDragging:!1,movedPx:0,startPageY:0,noteId:null,thresholdPx:5,swallowClick:!1,startStep:null,lastTargetStep:null,lastSoundStep:null,dropOnOccupied:!1,outOfRange:!1},this._previewState={active:!1,step:null},this._preview=null,this._previewStep=null,this._audioReady=!1,this._synth=null,this._fxNoise=null,this._accDragSound={noteId:null,step:null,toolType:null,prospectiveCls:null},this._accSnap={noteId:null,dist:null,localY:null},this._suppressNextClick={noteId:null,until:0},this._applyClefCssVars(this.opts.clef),this._computeLayout(),this._drawLines(),this.opts.autoClef&&!this.opts.clef?this.setClef("treble"):this.opts.clef&&(this._applyClefCssVars(this.opts.clef),this.relayout())},u=[{key:"_clefUrlFor",value:function(t){var e=o(t);if(!e)return null;var n=this.opts.clefUrls||{};return n[e]||n.treble||null}},{key:"setSoundEnabled",value:function(t){if(this.opts.sound=!!t,!this.opts.sound&&window.Tone){try{Tone.Transport&&Tone.Transport.stop()}catch(t){}try{Tone.context&&Tone.context.suspend&&Tone.context.suspend()}catch(t){}try{this._synth&&this._synth.releaseAll&&this._synth.releaseAll()}catch(t){}try{this._fxNoise&&this._fxNoise.dispose&&this._fxNoise.dispose()}catch(t){}this._fxNoise=null,this._audioReady=!1}}},{key:"isSoundEnabled",value:function(){return!!this.opts.sound}},{key:"_soundEnabled",value:function(){return!!this.opts.sound}},{key:"_applyClefCssVars",value:function(t){var n=o(t),i=e[n]||e.treble,a=this.$el[0];Object.keys(i).forEach(function(t){return a.style.setProperty(t,i[t])})}},{key:"setClef",value:function(t){this.opts.clef=o(t),this.opts.clefUrl=this._clefUrlFor(this.opts.clef),this._applyClefCssVars(this.opts.clef),this.relayout()}},{key:"getClef",value:function(){return this.opts.clef||"treble"}},{key:"_maxUserNotes",value:function(){var t=this.opts.getMaxUserNotes?this.opts.getMaxUserNotes():1/0;return Number.isFinite(t)?t:1/0}},{key:"_userNoteCount",value:function(){return this.$el.find(".note").not(".fixed").not(".preview").not(".hint").length}},{key:"_computeLayout",value:function(){var t=this.$el.height(),e=4*this.opts.lineGap,n=Math.round((t-e)/2);this.opts.bottomLineY=n+e}},{key:"_drawLines",value:function(){this.$el.find(".staff-line, .staff-clef").remove();for(var t=0;t<5;t++){var e=this.opts.bottomLineY-(4-t)*this.opts.lineGap;$('<div class="staff-line"></div>').css({top:"".concat(e,"px")}).appendTo(this.$el)}this._drawClef()}},{key:"_drawClef",value:function(){if(this.opts.clefUrl){var t=o(this.opts.clef);$('<img alt="">').addClass("staff-clef").addClass("".concat(t,"-clef")).attr("src",this.opts.clefUrl).appendTo(this.$el)}}},{key:"relayout",value:function(){this._computeLayout(),this._drawLines(),this._resolveNoteOverlaps(),this._repositionAllAccidentals()}},{key:"centerX",value:function(){return this.$el.width()/2}},{key:"stepToY",value:function(t){return this.opts.bottomLineY-t*this.opts.stepSize}},{key:"yToStep",value:function(t){return Math.round((this.opts.bottomLineY-t)/this.opts.stepSize)}},{key:"_pageYToLocalY",value:function(t){return t-this.$el.offset().top}},{key:"minStepAllowed",value:function(){return 0-2*this.opts.maxLedgerBelow}},{key:"maxStepAllowed",value:function(){return 8+2*this.opts.maxLedgerAbove}},{key:"_isStepAllowed",value:function(t){return t>=this.minStepAllowed()&&t<=this.maxStepAllowed()}},{key:"_ledgerStepsFor",value:function(t){var e=[],n=8+2*this.opts.maxLedgerAbove,i=0-2*this.opts.maxLedgerBelow;if(t>8)for(var a=Math.min(t,n),r=10;r<=a;r+=2)e.push(r);else if(t<0)for(var o=Math.max(t,i),s=-2;s>=o;s-=2)e.push(s);return e}},{key:"_renderLedgers",value:function(t,e,n){this.$el.find('.ledger[data-for-note-id="'.concat(t,'"]')).remove();for(var i=this.$el.find('.note[data-note-id="'.concat(t,'"]')).hasClass("dragging"),a=this._ledgerStepsFor(n),r=0;r<a.length;r++){var o=$('<div class="ledger"></div>').attr("data-for-note-id",t).css({left:"".concat(e,"px"),top:"".concat(this.stepToY(a[r]),"px")});i&&o.addClass("dragging"),o.appendTo(this.$el)}}},{key:"_previewLedgersClear",value:function(){this.$el.find(".ledger.preview").remove()}},{key:"_previewLedgersSet",value:function(t){this._previewLedgersClear();for(var e=this.centerX(),n=this._ledgerStepsFor(t),i=0;i<n.length;i++)$('<div class="ledger preview"></div>').css({left:"".concat(e,"px"),top:"".concat(this.stepToY(n[i]),"px")}).appendTo(this.$el)}},{key:"_stepOfNoteEl",value:function(t){var e=t.style.top||window.getComputedStyle(t).top;return this.yToStep(parseFloat(e))}},{key:"_isStepOccupied",value:function(t,e){for(var n=this.$el.find(".note").toArray(),i=0;i<n.length;i++){var a=n[i];if(a){var r=a.getAttribute("data-note-id");if((!e||r!==e)&&this._stepOfNoteEl(a)===t)return!0}}return!1}},{key:"_getNoteIdAtStep",value:function(t,e){for(var n=this.$el.find(".note").toArray(),i=0;i<n.length;i++){var a=n[i];if(a){var r=a.getAttribute("data-note-id");if((!e||r!==e)&&this._stepOfNoteEl(a)===t)return r}}return null}},{key:"_isCenteredX",value:function(t){var e=this.$el.find('.note[data-note-id="'.concat(t,'"]'));return!e.length||Math.abs(parseFloat(e.css("left"))-this.centerX())<=.5}},{key:"isNoteFixed",value:function(t){var e=this.$el.find('.note[data-note-id="'.concat(t,'"]'));return!!e.length&&e.hasClass("fixed")}},{key:"_nearestEditableNoteByLocalY",value:function(t){for(var e=Number.isFinite(this.opts.accSnapMaxPx)?this.opts.accSnapMaxPx:1.2*this.opts.lineGap,n=null,i=this.$el.find(".note").not(".preview").toArray(),a=0;a<i.length;a++){var r=i[a],o=r.getAttribute("data-note-id");if(o&&!$(r).hasClass("fixed")){var s=parseFloat(r.style.top||window.getComputedStyle(r).top),l=Math.abs(s-t);(null==n||l<n.dist)&&(n={noteId:o,dist:l})}}return!n||n.dist>e?null:n}},{key:"_removeAccidentalForNote",value:function(t){this.$el.find('.accidental[data-for-note-id="'.concat(t,'"]')).remove()}},{key:"_accidentalAnchorXForNote",value:function(t){var e=this.centerX();return Number.isFinite(t)&&t>e+.5?e:t}},{key:"_positionAccidentalForNote",value:function(t){var e=this.$el.find('.note[data-note-id="'.concat(t,'"]')),n=this.$el.find('.accidental[data-for-note-id="'.concat(t,'"]'));if(e.length&&n.length){var i=parseFloat(e.css("left")),a=parseFloat(e.css("top")),r=this._accidentalAnchorXForNote(i);n.css({left:"".concat(r-this.opts.accidentalGapPx,"px"),top:"".concat(a-this.opts.accidentalTopPx,"px")})}}},{key:"_rectsOverlap",value:function(t,e){return!(t.right<=e.left||t.left>=e.right||t.bottom<=e.top||t.top>=e.bottom)}},{key:"_repositionAllAccidentals",value:function(){var t=this;this.$el.find(".accidental").each(function(e,n){var i=n.getAttribute("data-for-note-id");i&&t._positionAccidentalForNote(i)});for(var e=this.$el.find(".note").not(".preview").toArray(),n={},i=0;i<e.length;i++){var a=e[i],r=a.getAttribute("data-note-id");r&&(n[this._stepOfNoteEl(a)]=r)}for(var o=Object.keys(n).map(function(t){return parseInt(t,10)}).sort(function(t,e){return t-e}),s=0;s<o.length;s++){var l=o[s],c=l+1,u=n[l],f=n[c];if(u&&f){var h=this.$el.find('.accidental[data-for-note-id="'.concat(u,'"]')),d=this.$el.find('.accidental[data-for-note-id="'.concat(f,'"]'));if(h.length&&d.length){var p=h[0].getBoundingClientRect(),v=d[0].getBoundingClientRect();if(this._rectsOverlap(p,v)){var _=Math.max(0,v.right-p.left),m=parseFloat(d.css("left"));Number.isFinite(m)&&d.css("left","".concat(m-(_+-6),"px"))}}}}}},{key:"_getAttachedAccidentalClass",value:function(e){var n=this.$el.find('.accidental[data-for-note-id="'.concat(e,'"]'));if(!n.length)return null;for(var i=0;i<t.length;i++){var a=t[i];if(n.hasClass(a))return a}return null}},{key:"attachAccidentalToNote",value:function(t,e){if(t&&!this.isNoteFixed(t)){this._removeAccidentalForNote(t);var n=$('<div class="accidental music-font"></div>').addClass(e).attr("data-for-note-id",t);this.$el.append(n),this._repositionAllAccidentals()}}},{key:"_hintIgnoredAccidental",value:function(t){var e=this.$el.find('.note[data-note-id="'.concat(t,'"]'));e.length&&(e.removeClass("animate__animated animate__headShake"),e[0].offsetWidth,e.addClass("animate__animated animate__headShake"),e.off("animationend._hint webkitAnimationEnd._hint oAnimationEnd._hint MSAnimationEnd._hint").one("animationend._hint webkitAnimationEnd._hint oAnimationEnd._hint MSAnimationEnd._hint",function(){e.removeClass("animate__animated animate__headShake")}))}},{key:"applyAccidentalToolToNote",value:function(t,e){if(!t||this.isNoteFixed(t))return!1;var n=this._getAttachedAccidentalClass(t);if(c(n,e))return this._hintIgnoredAccidental(t),!1;var i=l(n,e);return("natural"!==e||"music-font__natural"!==n)&&i!==n&&(this.attachAccidentalToNote(t,i),this._emitNoteState(t,"user"),!0)}},{key:"_ensureAudio",value:(p=v(h().m(function t(){return h().w(function(t){for(;;)switch(t.n){case 0:if(this._soundEnabled()){t.n=1;break}return t.a(2);case 1:if(!this._audioReady){t.n=2;break}return t.a(2);case 2:if(window.Tone){t.n=3;break}return t.a(2);case 3:return t.n=4,Tone.start();case 4:this._synth=new Tone.Synth({oscillator:{type:"sine"},envelope:{attack:.01,decay:.08,sustain:.6,release:.12}}).toDestination(),this._fxNoise=new Tone.NoiseSynth({noise:{type:"white"},envelope:{attack:.001,decay:.03,sustain:0,release:.02}}).toDestination(),this._audioReady=!0;case 5:return t.a(2)}},t,this)})),function(){return p.apply(this,arguments)})},{key:"_playAccidentalGrabSfx",value:function(){var t=this;this._soundEnabled()&&window.Tone&&this._ensureAudio().then(function(){t._fxNoise&&t._fxNoise.triggerAttackRelease(.03,Tone.now(),.16)})}},{key:"_stepToMidi",value:function(t){var e,n;switch(this.opts.clef){case"bass":e=36,n=4;break;case"alto":e=48,n=3;break;case"tenor":e=48,n=1;break;default:e=60,n=2}var i=n+t,a=Math.floor(i/7);return e+[0,2,4,5,7,9,11][(i%7+7)%7]+12*a}},{key:"_accidentalClassToOffset",value:function(t){return t?t.includes("music-font__doublesharp")?2:t.includes("music-font__sharp")?1:t.includes("music-font__doubleflat")?-2:t.includes("music-font__flat")?-1:0:0}},{key:"_emitNoteState",value:function(t,e){var n=this.$el.find('.note[data-note-id="'.concat(t,'"]'));if(n.length){var i=this.yToStep(parseFloat(n.css("top"))),a=this._getAttachedAccidentalClass(t),r=this._accidentalClassToOffset(a),o=this._stepToMidi(i)+r;this.$el.trigger("staff:noteState",{noteId:t,step:i,accidentalClass:a,midi:o,source:e||"unknown"})}}},{key:"_playStep",value:(d=v(h().m(function t(e,n){var i;return h().w(function(t){for(;;)switch(t.n){case 0:if(this._soundEnabled()&&Number.isFinite(e)){t.n=1;break}return t.a(2);case 1:return t.n=2,this._ensureAudio();case 2:if(this._synth){t.n=3;break}return t.a(2);case 3:i=this._stepToMidi(e)+(n||0),this._synth.triggerRelease&&this._synth.triggerRelease(),this._synth.triggerAttackRelease(Tone.Frequency(i,"midi"),.5);case 4:return t.a(2)}},t,this)})),function(t,e){return d.apply(this,arguments)})},{key:"setNoteFixed",value:function(t,e){var n=!!e;this.$el.find('.note[data-note-id="'.concat(t,'"]')).toggleClass("fixed",n),this.$el.find('.ledger[data-for-note-id="'.concat(t,'"]')).toggleClass("fixed",n),this.$el.find('.accidental[data-for-note-id="'.concat(t,'"]')).toggleClass("fixed",n)}},{key:"addFixedNote",value:function(t){var e=t||{},n=this.addNote({step:e.step,y:e.y,x:e.x,id:e.id,ledger:e.ledger,className:e.className||""});return n?(e.accidentalClass&&this.attachAccidentalToNote(n,e.accidentalClass),this.setNoteFixed(n,!0),n):null}},{key:"clearNotes",value:function(){this.$el.find(".note, .ledger, .accidental").remove(),this._previewClear()}},{key:"removeNote",value:function(t){this.$el.find('.note[data-note-id="'.concat(t,'"]')).remove(),this.$el.find('.ledger[data-for-note-id="'.concat(t,'"]')).remove(),this._removeAccidentalForNote(t),this._resolveNoteOverlaps()}},{key:"addNote",value:function(t){var e=t||{},n=Number.isFinite(e.step)?Number(e.step):null;if(Number.isFinite(n)&&!this._isStepAllowed(n))return null;if(Number.isFinite(n)&&!e.allowOccupied&&this._isStepOccupied(n,null))return null;var i=Number.isFinite(e.y)?Number(e.y):Number.isFinite(n)?this.stepToY(n):null;if(!Number.isFinite(i))throw new Error("addNote: provide either y or step");var a=Number.isFinite(e.x)?Number(e.x):this.centerX(),r=e.id||"".concat(this.opts.noteIdPrefix).concat(this._idCounter++),o=$('<div class="note"><span class="lettername"></span></div>').attr("data-note-id",r).css({left:"".concat(a,"px"),top:"".concat(i,"px")});return e.className&&o.addClass(e.className),this.$el.append(o),(!0===e.ledger||!1!==e.ledger&&Number.isFinite(n))&&this._renderLedgers(r,a,n),e.skipResolve?this._repositionAllAccidentals():this._resolveNoteOverlaps(),r}},{key:"moveNote",value:function(t,e){var n=e||{},i=this.$el.find('.note[data-note-id="'.concat(t,'"]'));if(i.length){var a=Number.isFinite(n.x)?Number(n.x):null,r=Number.isFinite(n.step)?Number(n.step):null;if(!Number.isFinite(r)||this._isStepAllowed(r)){var o=Number.isFinite(n.y)?Number(n.y):Number.isFinite(r)?this.stepToY(r):null;if(Number.isFinite(a)&&i.css("left","".concat(a,"px")),Number.isFinite(o)&&i.css("top","".concat(o,"px")),Number.isFinite(r)){var s=Number.isFinite(a)?a:parseFloat(i.css("left"));this._renderLedgers(t,s,r)}this._repositionAllAccidentals()}}}},{key:"_previewSet",value:function(t){this._preview||(this._preview=$('<div class="note preview"></div>').appendTo(this.$el)),this._preview.css({left:"".concat(this.centerX(),"px"),top:"".concat(this.stepToY(t),"px")}),this._previewStep=t,this._previewLedgersSet(t)}},{key:"_previewClear",value:function(){this._preview&&(this._preview.remove(),this._preview=null,this._previewStep=null),this._previewLedgersClear()}},{key:"_resolveNoteOverlaps",value:function(){var t=this,e=this.opts.noteOverlapGap;function n(){return t.$el.find(".note").toArray().map(function(e){var n=$(e);return{el:e,$el:n,step:t.yToStep(parseFloat(n.css("top")))}})}function i(t){for(var e={},n=0;n<t.length;n++){var i=t[n].step;(e[i]||(e[i]=[])).push(t[n])}return e}function a(e){for(var n=t.centerX(),i=0;i<e.length;i++){var a=e[i].$el.attr("data-note-id");t.moveNote(a,{x:n,step:e[i].step}),e[i]._shifted=!1}}function r(n,i){var a=n.el.getBoundingClientRect(),r=i[n.step-1];if(!r||!r.length)return!1;var o=r[0].el.getBoundingClientRect();if(!t._rectsOverlap(a,o))return!1;var s=o.right-a.left+e,l=n.$el.attr("data-note-id");return t.moveNote(l,{x:parseFloat(n.$el.css("left"))+s,step:n.step}),!0}for(var o=0;o<20;o++){var s=n();if(!s.length)return;a(s);for(var l=i(s),c=Object.keys(l).map(function(t){return parseInt(t,10)}).sort(function(t,e){return t-e}),u=!1,f=0;f<c.length;f++){var h=c[f];if(l[h]&&l[h+1]){var d=l[h][0],p=l[h+1][0];d._shifted||(r(p,l)&&(u=!0),p._shifted=!0)}}if(!u)return void t._repositionAllAccidentals()}t._repositionAllAccidentals()}},{key:"_setDraggingVisual",value:function(t,e){var n=this.$el.find('.note[data-note-id="'.concat(t,'"]')),i=this.$el.find('.ledger[data-for-note-id="'.concat(t,'"]')),a=this.$el.find('.accidental[data-for-note-id="'.concat(t,'"]'));n.toggleClass("dragging",!!e),i.toggleClass("dragging",!!e),a.toggleClass("dragging",!!e)}},{key:"_applyDraggedAdjacencyX",value:function(t){var e=this.$el.find('.note[data-note-id="'.concat(t,'"]'));if(e.length){var n=this.yToStep(parseFloat(e.css("top"))),i=this.centerX(),a=this.opts.noteOverlapGap;this.moveNote(t,{x:i});var r=this._getNoteIdAtStep(n-1,t);if(r&&this._isCenteredX(r)){var o=this.$el.find('.note[data-note-id="'.concat(r,'"]'));if(o.length){var s=e[0].getBoundingClientRect(),l=o[0].getBoundingClientRect();if(this._rectsOverlap(s,l)){var c=l.right-s.left+a;this.moveNote(t,{x:i+c})}}}}}},{key:"enableGhostClickCreate",value:function(){var t=this;this.$el.off(".previewCreate"),$(window).off("blur.previewCreate"),this.$el.on("pointerdown.previewCreate",function(e){if(!($(e.target).closest(".note, .accidental").length||t._userNoteCount()>=t._maxUserNotes())){e.preventDefault();var n=i(e).y,r=t.yToStep(t._pageYToLocalY(n));if(t._isStepAllowed(r)){t._previewState.active=!0,t._previewState.step=r,t._previewSet(r),t._soundEnabled()&&t._ensureAudio();var o=a(e);this.setPointerCapture&&null!=o&&this.setPointerCapture(o),t.$el.off("pointermove.previewCreate").on("pointermove.previewCreate",function(e){if(t._previewState.active){if(t._userNoteCount()>=t._maxUserNotes())return t._previewState.active=!1,t._previewClear(),void t.$el.off("pointermove.previewCreate pointerup.previewCreate pointercancel.previewCreate");var n=i(e).y,a=t.yToStep(t._pageYToLocalY(n));t._isStepAllowed(a)&&(t._previewState.step=a,t._previewSet(a))}}),t.$el.off("pointerup.previewCreate pointercancel.previewCreate").on("pointerup.previewCreate pointercancel.previewCreate",function(){if(t._previewState.active){t._previewState.active=!1;var e=t._previewState.step;if(t._previewClear(),t.$el.off("pointermove.previewCreate pointerup.previewCreate pointercancel.previewCreate"),t._isStepAllowed(e)&&!(t._isStepOccupied(e,null)||t._userNoteCount()>=t._maxUserNotes())){var n=t.addNote({step:e});n&&(t.$el.trigger("staff:userNoteAdded",{noteId:n,step:e}),t._emitNoteState(n,"user"),t._suppressNextClick.noteId=n,t._suppressNextClick.until=Date.now()+700,t._playStep(e,0))}}})}}}),$(window).on("blur.previewCreate",function(){t._previewState.active&&(t._previewState.active=!1,t._previewClear(),t.$el.off("pointermove.previewCreate pointerup.previewCreate pointercancel.previewCreate"))})}},{key:"enableNoteDragAndClickDelete",value:function(){var t=this,e=this._drag;function n(n,r){if(r.preventDefault(),!$(n).hasClass("fixed")){r.stopImmediatePropagation?r.stopImmediatePropagation():r.stopPropagation();var o=a(r),s=$(n);e.isDragging=!1,e.movedPx=0,e.startPageY=i(r).y,e.noteId=s.attr("data-note-id"),e.startStep=t.yToStep(parseFloat(s.css("top"))),e.lastTargetStep=e.startStep,e.lastSoundStep=e.startStep,e.dropOnOccupied=!1,e.outOfRange=!1,t._setDraggingVisual(e.noteId,!0),t._soundEnabled()&&t._ensureAudio();var l=r.currentTarget&&r.currentTarget.setPointerCapture?r.currentTarget:null;l&&null!=o&&l.setPointerCapture(o),t.$el.off("pointermove.noteDrag").on("pointermove.noteDrag",function(n){var r=a(n);if(null==o||null==r||r===o){var s=i(n).y,l=s-e.startPageY;if(e.movedPx=Math.max(e.movedPx,Math.abs(l)),!e.isDragging&&e.movedPx>=e.thresholdPx&&(e.isDragging=!0),e.isDragging){var c=t.yToStep(t._pageYToLocalY(s));if(t._isStepAllowed(c)){if(e.outOfRange=!1,e.lastTargetStep=c,t.moveNote(e.noteId,{step:c}),e.dropOnOccupied=t._isStepOccupied(c,e.noteId),t._applyDraggedAdjacencyX(e.noteId),t._soundEnabled()&&c!==e.lastSoundStep){e.lastSoundStep=c;var u=t._getAttachedAccidentalClass(e.noteId),f=t._accidentalClassToOffset(u);t._playStep(c,f)}}else e.outOfRange=!0}}}),t.$el.off("pointerup.noteDrag pointercancel.noteDrag").on("pointerup.noteDrag pointercancel.noteDrag",function(n){var i=a(n);null!=o&&null!=i&&i!==o||(t.$el.off("pointermove.noteDrag pointerup.noteDrag pointercancel.noteDrag"),e.swallowClick=e.isDragging,t._setDraggingVisual(e.noteId,!1),e.outOfRange||e.dropOnOccupied?t.removeNote(e.noteId):(t.moveNote(e.noteId,{step:e.lastTargetStep}),t._resolveNoteOverlaps(),t._emitNoteState(e.noteId,"user")),e.noteId=null,e.isDragging=!1,e.movedPx=0,e.startStep=null,e.lastTargetStep=null,e.lastSoundStep=null,e.dropOnOccupied=!1,e.outOfRange=!1)})}}this.$el.off(".noteDrag"),this.$el.on("pointerdown.noteDrag",".accidental",function(t){t.stopPropagation()}),this.$el.on("pointerdown.noteDrag",".note",function(t){n(this,t)}),this.$el.on("pointerdown.noteDrag",function(e){if(!$(e.target).closest(".accidental").length&&!$(e.target).closest(".note").length){var a=i(e).y,r=t.yToStep(t._pageYToLocalY(a)),o=t._getNoteIdAtStep(r,null);if(o){var s=t.$el.find('.note[data-note-id="'.concat(o,'"]'))[0];s&&n(s,e)}}}),this.$el.on("click.noteDrag",".accidental",function(e){e.preventDefault(),e.stopPropagation();var n=this.getAttribute("data-for-note-id");n&&(t.isNoteFixed(n)||(t._removeAccidentalForNote(n),t._repositionAllAccidentals(),t._emitNoteState(n,"user")))}),this.$el.on("click.noteDrag",".note",function(n){var i=$(this).attr("data-note-id");return t._suppressNextClick.noteId&&i===t._suppressNextClick.noteId&&Date.now()<t._suppressNextClick.until?(t._suppressNextClick.noteId=null,t._suppressNextClick.until=0,n.preventDefault(),void n.stopPropagation()):e.swallowClick?(n.preventDefault(),n.stopPropagation(),void(e.swallowClick=!1)):void t.removeNote(i)})}},{key:"enableAccidentalDrag",value:function(t){var e=this;function n(){e._accDragSound.noteId=null,e._accDragSound.step=null,e._accDragSound.toolType=null,e._accDragSound.prospectiveCls=null,e._accSnap.noteId=null,e._accSnap.dist=null,e._accSnap.localY=null}t.addClass("accidental-tool"),t.draggable({helper:"clone",appendTo:"body",zIndex:9999,revert:"invalid",scroll:!1,start:function(t,i){i.helper.addClass("dragging accidental-tool"),e._soundEnabled()&&e._ensureAudio(),e._playAccidentalGrabSfx(),n(),e._accDragSound.toolType=s($(this))},drag:function(t){var i=e._accDragSound.toolType;if(i){var a=t.pageX,r=t.pageY;!Number.isFinite(r)&&t.originalEvent&&(r=t.originalEvent.pageY),!Number.isFinite(a)&&t.originalEvent&&(a=t.originalEvent.pageX);var o=e.$el.offset(),s=a-o.left,u=r-o.top;if(e._accSnap.localY=u,s<0||u<0||s>e.$el.width()||u>e.$el.height())return n(),void(e._accDragSound.toolType=i);var f=e._nearestEditableNoteByLocalY(u);if(!f)return e._accSnap.noteId=null,e._accSnap.dist=null,e._accDragSound.noteId=null,e._accDragSound.step=null,void(e._accDragSound.prospectiveCls=null);var h=f.noteId;e._accSnap.noteId=h,e._accSnap.dist=f.dist;var d=e.$el.find('.note[data-note-id="'.concat(h,'"]'));if(d.length){var p=e.yToStep(parseFloat(d.css("top")));if(e._isStepAllowed(p)){var v=e._getAttachedAccidentalClass(h),_=l(v,i);if(c(v,i))return e._accDragSound.noteId=null,e._accDragSound.step=null,void(e._accDragSound.prospectiveCls=null);if((h!==e._accDragSound.noteId||p!==e._accDragSound.step||_!==e._accDragSound.prospectiveCls)&&(e._accDragSound.noteId=h,e._accDragSound.step=p,e._accDragSound.prospectiveCls=_,e._soundEnabled())){var m=e._accidentalClassToOffset(_);e._playStep(p,m)}}}}},stop:function(){n()}})}},{key:"enableAccidentalDropOnStaff",value:function(){var t=this;this.$el.droppable({accept:".accidental-tool",tolerance:"pointer",drop:function(e,n){var i=s(n.draggable);if(i){var a;if(t._accSnap&&null!=t._accSnap.localY)a=t._accSnap.localY;else{var r=e.pageY;!Number.isFinite(r)&&e.originalEvent&&(r=e.originalEvent.pageY),a=t._pageYToLocalY(r)}var o=t._nearestEditableNoteByLocalY(a);o&&t.applyAccidentalToolToNote(o.noteId,i)}}})}}],u&&_(r.prototype,u),f&&_(r,f),Object.defineProperty(r,"prototype",{writable:!1}),r;var r,u,f,d,p}();function g(t){return g="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},g(t)}function S(){var t,e,n="function"==typeof Symbol?Symbol:{},i=n.iterator||"@@iterator",a=n.toStringTag||"@@toStringTag";function r(n,i,a,r){var l=i&&i.prototype instanceof s?i:s,c=Object.create(l.prototype);return b(c,"_invoke",function(n,i,a){var r,s,l,c=0,u=a||[],f=!1,h={p:0,n:0,v:t,a:d,f:d.bind(t,4),d:function(e,n){return r=e,s=0,l=t,h.n=n,o}};function d(n,i){for(s=n,l=i,e=0;!f&&c&&!a&&e<u.length;e++){var a,r=u[e],d=h.p,p=r[2];n>3?(a=p===i)&&(l=r[(s=r[4])?5:(s=3,3)],r[4]=r[5]=t):r[0]<=d&&((a=n<2&&d<r[1])?(s=0,h.v=i,h.n=r[1]):d<p&&(a=n<3||r[0]>i||i>p)&&(r[4]=n,r[5]=i,h.n=p,s=0))}if(a||n>1)return o;throw f=!0,i}return function(a,u,p){if(c>1)throw TypeError("Generator is already running");for(f&&1===u&&d(u,p),s=u,l=p;(e=s<2?t:l)||!f;){r||(s?s<3?(s>1&&(h.n=-1),d(s,l)):h.n=l:h.v=l);try{if(c=2,r){if(s||(a="next"),e=r[a]){if(!(e=e.call(r,l)))throw TypeError("iterator result is not an object");if(!e.done)return e;l=e.value,s<2&&(s=0)}else 1===s&&(e=r.return)&&e.call(r),s<2&&(l=TypeError("The iterator does not provide a '"+a+"' method"),s=1);r=t}else if((e=(f=h.n<0)?l:n.call(i,h))!==o)break}catch(e){r=t,s=1,l=e}finally{c=1}}return{value:e,done:f}}}(n,a,r),!0),c}var o={};function s(){}function l(){}function c(){}e=Object.getPrototypeOf;var u=[][i]?e(e([][i]())):(b(e={},i,function(){return this}),e),f=c.prototype=s.prototype=Object.create(u);function h(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,c):(t.__proto__=c,b(t,a,"GeneratorFunction")),t.prototype=Object.create(f),t}return l.prototype=c,b(f,"constructor",c),b(c,"constructor",l),l.displayName="GeneratorFunction",b(c,a,"GeneratorFunction"),b(f),b(f,a,"Generator"),b(f,i,function(){return this}),b(f,"toString",function(){return"[object Generator]"}),(S=function(){return{w:r,m:h}})()}function b(t,e,n,i){var a=Object.defineProperty;try{a({},"",{})}catch(t){a=0}b=function(t,e,n,i){function r(e,n){b(t,e,function(t){return this._invoke(e,n,t)})}e?a?a(t,e,{value:n,enumerable:!i,configurable:!i,writable:!i}):t[e]=n:(r("next",0),r("throw",1),r("return",2))},b(t,e,n,i)}function k(t,e,n,i,a,r,o){try{var s=t[r](o),l=s.value}catch(t){return void n(t)}s.done?e(l):Promise.resolve(l).then(i,a)}function w(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,i)}return n}function x(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?w(Object(n),!0).forEach(function(e){T(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):w(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function A(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,C(i.key),i)}}function T(t,e,n){return(e=C(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function C(t){var e=function(t,e){if("object"!=g(t)||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var i=n.call(t,e||"default");if("object"!=g(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==g(e)?e:e+""}var N=Date.now(),E=function(){function t(){var e,n,i=this,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t);var r={staffEl:"#staff",basePoints:1,firstTryBonus:2,sound:!0,showLetterNames:!1,clefUrls:null,initialClef:"treble",maxUserNotes:1/0,numOfChallenges:10,practiceMode:!1,timer:!1,levelName:"",successPhrases:["Awesome","Nicely done","Well done","Great job","Hooray","Fantastic","Nice work","Looks good","Good one","Splendid","Way to go","Nailed it","Brilliant","Excellent","Superb","Right on","You got it","Perfect","Spot on","Impressive","Top notch","That’s it"],namespace:"staffGame",instructionsAfterUserNotes:1,checkAfterUserNotes:1};this.opts=x(x({},r),a||{}),this.ns=this.opts.namespace||"staffGame",this.opts.numOfChallenges=this._normalizeNumOfChallenges(this.opts.numOfChallenges),this._uiSfxReady=!1,this._uiSfxSynth=null,this._uiSfxNoise=null,this._uiTimerSfxSynth=null,this.$staffEl=$(this.opts.staffEl),this.$accidentals=$("#accidentals"),this.$controls=$("#controls"),this.$feedback=$("#feedback-success"),this.$bonusBadge=this.$feedback.find(".bonus"),this.$points=$("#points"),this.$increment=$("#increment"),this.$checkBtn=$("#check button"),this.$skipWrap=$("#skip"),this.$skipBtn=this.$skipWrap.find("button"),this.$finalOverlay=$("#final-overlay"),this.$doublePoints=$("#double-points"),this.$checkWrap=this.$checkBtn.parent(),this.$progressBar=$("#progress-bar"),this.$progressCounter=$("#progress-counter"),this.$helpBtn=$("#help"),this.$timeupMessage=$("#timeup-message"),this.$handPointer=$("#hand-pointer"),this.$timer=$("#timer"),this.$timerBox=this.$timer.children("div").first(),this.$timerText=this.$timer.find("span"),this.successPhrases=this.opts.successPhrases,this.maxUserNotes=Number(this.opts.maxUserNotes),this.numOfChallenges=this.opts.numOfChallenges,this.levelName=this.opts.levelName,this.points=0,this._madeMistakeThisRound=!1,this._madeAnyMistake=!1,this._continueBound=!1,this._usedHintThisRound=!1,this._correctStreak=0,this._stats={checksTotal:0,checksCorrect:0,finishedAtMs:null},this._timerTimeoutId=null,this._timerRemainingSec=0,this._audioUnlockArmed=!1,this._timerEndsAtMs=0,this._finalMetricsSfxTimeouts=[],this._finalCountupTimeouts=[],this.staff=new y(this.$staffEl,{clef:this.opts.initialClef||"treble",clefUrls:this.opts.clefUrls||window.__clefUrls,autoClef:!1,getMaxUserNotes:function(){return Number.isFinite(i.maxUserNotes)?i.maxUserNotes:1/0},sound:!!this.opts.sound}),this.showLetterNames=!!this.opts.showLetterNames,this.$staffEl.toggleClass("show-letternames",this.showLetterNames),this._fixedNote={letterWithAcc:"?",letterOnly:"?"},this._fixedState=null,this.$increment.hide(),this.$bonusBadge.hide(),null===(e=this.$doublePoints)||void 0===e||null===(n=e.hide)||void 0===n||n.call(e),this.$points.text(String(this.points))}return e=t,n=[{key:"_normalizeNumOfChallenges",value:function(e){var n,i,a=Number(e),r=Number(null!==(n=null===(i=this.opts)||void 0===i?void 0:i.numOfChallenges)&&void 0!==n?n:10),o=Number.isFinite(a)?Math.trunc(a):Number.isFinite(r)?Math.trunc(r):10,s=t.MIN_CHALLENGES,l=t.MAX_CHALLENGES;return o<s?s:o>l?l:o}},{key:"setSoundEnabled",value:function(t){if(this.opts.sound=!!t,this.staff.setSoundEnabled(!!t),!this.opts.sound&&window.Tone){try{this._uiSfxSynth&&this._uiSfxSynth.releaseAll&&this._uiSfxSynth.releaseAll()}catch(t){}try{this._uiSfxSynth&&this._uiSfxSynth.dispose&&this._uiSfxSynth.dispose()}catch(t){}try{this._uiSfxNoise&&this._uiSfxNoise.dispose&&this._uiSfxNoise.dispose()}catch(t){}try{this._uiTimerSfxSynth&&this._uiTimerSfxSynth.dispose&&this._uiTimerSfxSynth.dispose()}catch(t){}this._uiSfxSynth=null,this._uiSfxNoise=null,this._uiTimerSfxSynth=null,this._uiSfxReady=!1;try{Tone.context&&Tone.context.suspend&&Tone.context.suspend()}catch(t){}}return this}},{key:"isSoundEnabled",value:function(){return this.staff.isSoundEnabled()}},{key:"_ensureUiSfxAudio",value:(a=S().m(function t(){return S().w(function(t){for(;;)switch(t.p=t.n){case 0:if(this.isSoundEnabled()){t.n=1;break}return t.a(2);case 1:if(!this._uiSfxReady){t.n=2;break}return t.a(2);case 2:if(window.Tone){t.n=3;break}return t.a(2);case 3:return t.p=3,t.n=4,Tone.start();case 4:t.n=6;break;case 5:return t.p=5,t.v,t.a(2);case 6:this._uiSfxSynth=new Tone.PolySynth(Tone.Synth,{oscillator:{type:"triangle"},envelope:{attack:.005,decay:.12,sustain:0,release:.25}}).toDestination(),this._uiSfxNoise=new Tone.NoiseSynth({noise:{type:"pink"},envelope:{attack:.001,decay:.08,sustain:0,release:.06}}).toDestination(),this._uiTimerSfxSynth=new Tone.Synth({oscillator:{type:"square"},envelope:{attack:.001,decay:.03,sustain:0,release:.06}}).toDestination(),this._uiSfxReady=!0;case 7:return t.a(2)}},t,this,[[3,5]])}),o=function(){var t=this,e=arguments;return new Promise(function(n,i){var r=a.apply(t,e);function o(t){k(r,n,i,o,s,"next",t)}function s(t){k(r,n,i,o,s,"throw",t)}o(void 0)})},function(){return o.apply(this,arguments)})},{key:"_armUiSfxOnFirstGesture",value:function(){var t=this;if(!this._audioUnlockArmed&&this.isSoundEnabled()&&window.Tone){this._audioUnlockArmed=!0;var e=".uiSfxUnlock.".concat(this.ns);$(document).off(e).one("pointerdown".concat(e," keydown").concat(e," touchstart").concat(e),function(){t._ensureUiSfxAudio().finally(function(){$(document).off(e)})})}}},{key:"_playSuccessSfxBasic",value:function(){var t=this;this.isSoundEnabled()&&window.Tone&&this._ensureUiSfxAudio().then(function(){if(t._uiSfxSynth){var e=Tone.now(),n=[["C6","E6","G6"],["D6","F#6","A6"],["E6","G6","B6"],["G5","B5","D6","G6"],["A5","C6","E6","A6"],["C6","D6","G6"],["F5","A5","C6","F6"],["E6","A6","C7"],["B5","D6","G6"],["C6","G6","E7"]];n[Math.floor(Math.random()*n.length)].forEach(function(n,i){t._uiSfxSynth.triggerAttackRelease(n,.07,e+.05*i,.42)})}})}},{key:"_playSuccessSfxBonus",value:function(){var t=this;this.isSoundEnabled()&&window.Tone&&this._ensureUiSfxAudio().then(function(){var e;if(t._uiSfxSynth){var n=Tone.now(),i=x({},t._uiSfxSynth.get().envelope),a=null===(e=t._uiSfxSynth.get().oscillator)||void 0===e?void 0:e.type;try{t._uiSfxSynth.set({oscillator:{type:"sine"},envelope:{attack:.004,decay:.12,sustain:.15,release:.65}})}catch(t){}var r=Math.max(1,Math.min(24,Number(t._correctStreak)||1))-1,o=function(t){return Tone.Frequency(t,"midi").toNote()},s=[62,66,69,73,74].map(function(t){return o(t+r)}),l=[62,69,74,78].map(function(t){return o(t+r)});s.forEach(function(e,i){t._uiSfxSynth.triggerAttackRelease(e,.06,n+.045*i,.45)}),l.forEach(function(e){t._uiSfxSynth.triggerAttackRelease(e,.12,n+.26,.3)}),setTimeout(function(){try{t._uiSfxSynth.set({oscillator:{type:a||"triangle"},envelope:i})}catch(t){}},600)}})}},{key:"_playFailSfx",value:function(){var t=this;this.isSoundEnabled()&&window.Tone&&this._ensureUiSfxAudio().then(function(){var e=Tone.now();t._uiSfxNoise&&t._uiSfxNoise.triggerAttackRelease(.06,e,.1),t._uiSfxSynth&&(t._uiSfxSynth.triggerAttackRelease("A2",.1,e+.01,.1),t._uiSfxSynth.triggerAttackRelease("G2",.12,e+.08,10.1))})}},{key:"_playFinalSfx",value:function(){var t=this;this.isSoundEnabled()&&window.Tone&&this._ensureUiSfxAudio().then(function(){var e;if(t._uiSfxSynth){var n=x({},t._uiSfxSynth.get().envelope),i=null===(e=t._uiSfxSynth.get().oscillator)||void 0===e?void 0:e.type;t._uiSfxSynth.set({oscillator:{type:"sine"},envelope:{attack:.02,decay:.25,sustain:.35,release:.9}});var a=Tone.now(),r=[function(){["C4","G4","C5","E5"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.9,a,.6)}),["G5","A5","B5","C6","D6","E6","G6"].forEach(function(e,n){t._uiSfxSynth.triggerAttackRelease(e,.08,a+.25+.06*n,.35)})},function(){["C5","E5","G5","B5","D6","G6"].forEach(function(e,n){t._uiSfxSynth.triggerAttackRelease(e,.11,a+.08*n,.44)}),["C6","E6","G6"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.28,a+.62,.5)})},function(){["A3","E4","A4","C5"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.45,a,.45)}),["F4","A4","C5","F5"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.52,a+.35,.48)}),["C5","F5","A5"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.24,a+.78,.4)})},function(){["E5","G5","A5","B5","D6","E6","G6","A6"].forEach(function(e,n){t._uiSfxSynth.triggerAttackRelease(e,.075,a+.055*n,.34)}),["A5","A6","C7"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.2,a+.52,.42)})},function(){["D4","A4","D5","F#5"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.36,a,.45)}),["D5","F#5","A5","D6","F#6"].forEach(function(e,n){t._uiSfxSynth.triggerAttackRelease(e,.095,a+.2+.065*n,.4)})},function(){["G3","D4","G4","B4"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.4,a,.4)}),["C4","E4","G4","C5"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.44,a+.32,.46)}),["E5","G5","C6"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.22,a+.72,.4)})},function(){["C6","D6","E6","G6","A6","G6","E6","C7"].forEach(function(e,n){t._uiSfxSynth.triggerAttackRelease(e,.06,a+.048*n,.3)}),["G6","C7"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.2,a+.48,.38)})},function(){["F4","C5","A5"].forEach(function(e,n){t._uiSfxSynth.triggerAttackRelease(e,.16,a+.06*n,.45)}),["G4","D5","B5"].forEach(function(e,n){t._uiSfxSynth.triggerAttackRelease(e,.16,a+.28+.06*n,.48)}),["C5","E5","G5","C6"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.26,a+.54,.44)})},function(){["A6","G6","E6","D6","C6"].forEach(function(e,n){t._uiSfxSynth.triggerAttackRelease(e,.08,a+.06*n,.34)}),["E6","G6","C7"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.24,a+.4,.42)})},function(){["C4","E4","G4","C5"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.34,a,.48)}),["E5","G5","B5","D6","E6"].forEach(function(e,n){t._uiSfxSynth.triggerAttackRelease(e,.09,a+.18+.055*n,.38)}),["C6","E6","G6","C7"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.3,a+.58,.5)})}];(0,r[Math.floor(Math.random()*r.length)])(),setTimeout(function(){try{t._uiSfxSynth.set({oscillator:{type:i||"triangle"},envelope:n})}catch(t){}},1700)}})}},{key:"_clearFinalMetricsSfxTimers",value:function(){Array.isArray(this._finalMetricsSfxTimeouts)?(this._finalMetricsSfxTimeouts.forEach(function(t){return clearTimeout(t)}),this._finalMetricsSfxTimeouts=[]):this._finalMetricsSfxTimeouts=[]}},{key:"_clearFinalCountupTimers",value:function(){Array.isArray(this._finalCountupTimeouts)?(this._finalCountupTimeouts.forEach(function(t){return clearTimeout(t)}),this._finalCountupTimeouts=[]):this._finalCountupTimeouts=[]}},{key:"_playFinalMetricPopSfx",value:function(t){if(this.isSoundEnabled()&&window.Tone&&this._uiSfxReady){var e=Tone.now(),n=Math.max(0,Number(t)||0),i=Math.min(96,67+2*n),a=this._uiTimerSfxSynth||this._uiSfxSynth;a&&(a.triggerAttackRelease(Tone.Frequency(i,"midi"),.055,e,.44),a.triggerAttackRelease(Tone.Frequency(i+5,"midi"),.045,e+.03,.34))}}},{key:"_animateFinalMetricsWithSfx",value:function(){var t=this,e=this.$finalOverlay.find("#metrics-boxes > div");e.length&&(this._clearFinalMetricsSfxTimers(),e.each(function(e,n){var i=260+260*e;n.style.animationDelay="".concat(i,"ms");var a=setTimeout(function(){t._playFinalMetricPopSfx(e)},i);t._finalMetricsSfxTimeouts.push(a)}))}},{key:"_playPerfectGameBonusSfx",value:function(){var t=this;this.isSoundEnabled()&&window.Tone&&this._ensureUiSfxAudio().then(function(){var e;if(t._uiSfxSynth){var n=x({},t._uiSfxSynth.get().envelope),i=null===(e=t._uiSfxSynth.get().oscillator)||void 0===e?void 0:e.type;try{t._uiSfxSynth.set({oscillator:{type:"triangle"},envelope:{attack:.01,decay:.18,sustain:.25,release:.8}})}catch(t){}var a=Tone.now();["C5","E5","G5","C6","E6","G6","C7"].forEach(function(e,n){t._uiSfxSynth.triggerAttackRelease(e,.09,a+.06*n,.62)}),["C6","G6","C7","E7"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.35,a+.48,.46)}),setTimeout(function(){try{t._uiSfxSynth.set({oscillator:{type:i||"triangle"},envelope:n})}catch(t){}},1400)}})}},{key:"_isTimerEnabled",value:function(){var t=this.opts.timer,e=String(t||"").trim().toLowerCase();return!0===t||"true"===e||"on"===e}},{key:"_formatTimerDisplay",value:function(t){var e=Math.max(0,Math.floor(Number(t)||0)),n=String(Math.floor(e/60)).padStart(2,"0"),i=String(e%60).padStart(2,"0");return"".concat(n,":").concat(i)}},{key:"_renderTimerDisplay",value:function(){var t;null!==(t=this.$timerText)&&void 0!==t&&t.length&&(this.$timerText.text(this._formatTimerDisplay(this._timerRemainingSec)),this._syncTimerWarningStyle())}},{key:"_syncTimerWarningStyle",value:function(){var t;if(null!==(t=this.$timerBox)&&void 0!==t&&t.length){var e=this._timerRemainingSec<=5;this.$timerBox.toggleClass("bg-red",e),this.$timerBox.toggleClass("bg-primary",!e)}}},{key:"_setTimedOutInteractivityDisabled",value:function(t){var e=!!t,n=$("#staff"),i=$("#staff-wrapper"),a=$("#accidentals");e?(n.attr("disabled","disabled"),i.attr("disabled","disabled"),a.attr("disabled","disabled"),n.attr("aria-disabled","true"),i.attr("aria-disabled","true"),a.attr("aria-disabled","true"),n.css("pointer-events","none"),i.css("pointer-events","none"),a.css("pointer-events","none")):(n.removeAttr("disabled"),i.removeAttr("disabled"),a.removeAttr("disabled"),n.removeAttr("aria-disabled"),i.removeAttr("aria-disabled"),a.removeAttr("aria-disabled"),n.css("pointer-events",""),i.css("pointer-events",""),a.css("pointer-events",""))}},{key:"_showSkipRoundButton",value:function(){var t;null!==(t=this.$skipWrap)&&void 0!==t&&t.length&&this.$skipWrap.show()}},{key:"_hideSkipRoundButton",value:function(){var t;null!==(t=this.$skipWrap)&&void 0!==t&&t.length&&this.$skipWrap.hide()}},{key:"_hideTimeUpMessage",value:function(){var t;null!==(t=this.$timeupMessage)&&void 0!==t&&t.length&&this.$timeupMessage.removeClass("animate__animated animate__flash").hide()}},{key:"_showTimeUpMessage",value:function(){var t;null!==(t=this.$timeupMessage)&&void 0!==t&&t.length&&(this.$timeupMessage.removeClass("animate__animated animate__flash").show(),this.$timeupMessage[0]&&this.$timeupMessage[0].offsetWidth,this.$timeupMessage.addClass("animate__animated animate__flash"))}},{key:"_wouldReachLastRoundAfterAdvance",value:function(){if(this._isPracticeMode())return!1;var t=100/Math.max(1,this.numOfChallenges||1);return(parseFloat(this.$progressBar.data("progress"))||0)+t>=100}},{key:"_finishRoundAsTimedOut",value:function(){var t=this;if(this._correctStreak=0,this._madeAnyMistake=!0,this._madeMistakeThisRound=!0,this._stats.checksTotal+=1,this._updateProgressBar()>=100&&!this._isPracticeMode())return this._stats.finishedAtMs=Date.now(),this.$checkBtn.text("Final results, let's see…"),void setTimeout(function(){return t._showFinalResults()},1600);this._setTimedOutInteractivityDisabled(!1),this._hideTimeUpMessage(),this._hideSkipRoundButton(),$("#interval").removeClass("text-red").addClass("text-blue"),this._resetRoundTimerIfEnabled(),this.newChallenge(),this._armUiGates({resetInstructions:!1}),this.$checkBtn.enable()}},{key:"_pulseTimerWarning",value:function(){var t;null!==(t=this.$timer)&&void 0!==t&&t.length&&(this.$timer.removeClass("animate__animated animate__pulse"),this.$timer[0]&&this.$timer[0].offsetWidth,this.$timer.addClass("animate__animated animate__pulse"))}},{key:"_playTimerWarningBeep",value:function(){if(this.isSoundEnabled()&&window.Tone&&this._uiSfxReady&&this._uiTimerSfxSynth){var t=Tone.now();this._uiTimerSfxSynth.triggerAttackRelease("C6",.06,t,.5)}}},{key:"_playTimerTimeUpSfx",value:function(){if(this.isSoundEnabled()&&window.Tone&&this._uiSfxReady&&this._uiTimerSfxSynth){var t=Tone.now();this._uiSfxNoise&&this._uiSfxNoise.triggerAttackRelease(.12,t,.2),this._uiTimerSfxSynth.triggerAttackRelease("G4",.11,t,.72),this._uiTimerSfxSynth.triggerAttackRelease("E4",.13,t+.1,.76),this._uiTimerSfxSynth.triggerAttackRelease("C4",.18,t+.22,.82)}}},{key:"_stopGameTimer",value:function(){var t,e;null!=this._timerTimeoutId&&(clearTimeout(this._timerTimeoutId),this._timerTimeoutId=null),this._timerEndsAtMs=0,this._timerRemainingSec=0,this._syncTimerWarningStyle(),null===(t=this.$timer)||void 0===t||null===(e=t.removeClass)||void 0===e||e.call(t,"animate__animated animate__pulse")}},{key:"_pauseGameTimer",value:function(){var t,e;null!=this._timerTimeoutId&&(clearTimeout(this._timerTimeoutId),this._timerTimeoutId=null),this._timerEndsAtMs=0,null===(t=this.$timer)||void 0===t||null===(e=t.removeClass)||void 0===e||e.call(t,"animate__animated animate__pulse")}},{key:"_runGameTimerTick",value:function(){var t=this;if(this._timerEndsAtMs){var e=this._timerRemainingSec,n=this._timerEndsAtMs-Date.now(),i=Math.max(0,Math.ceil(n/1e3));if(this._timerRemainingSec=i,this._renderTimerDisplay(),i>0&&i<=5&&i!==e?(this._pulseTimerWarning(),this._playTimerWarningBeep()):0===i&&0!==e&&($("#check").hide(),this.$helpBtn.hide(),this._setTimedOutInteractivityDisabled(!0),this._pulseTimerWarning(),this._playTimerTimeUpSfx(),this._showTimeUpMessage(),this.$checkBtn.disable(),this._wouldReachLastRoundAfterAdvance()?(this._hideSkipRoundButton(),this._finishRoundAsTimedOut()):this._showSkipRoundButton()),i<=0)this._stopGameTimer();else{var a=this._timerEndsAtMs-1e3*(i-1),r=Math.max(16,a-Date.now());this._timerTimeoutId=setTimeout(function(){return t._runGameTimerTick()},r)}}}},{key:"_startGameTimer",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10;this._stopGameTimer();var e=Math.max(0,Math.floor(Number(t)||0));this._timerEndsAtMs=Date.now()+1e3*e,this._timerRemainingSec=e,this._renderTimerDisplay(),this._runGameTimerTick()}},{key:"_timerLimitSeconds",value:function(){var t=Number(null!=this.opts.timeLimit?this.opts.timeLimit:this.opts.timerLimit);return Number.isFinite(t)?Math.max(0,Math.floor(t)):10}},{key:"_resetRoundTimerIfEnabled",value:function(){this._isTimerEnabled()&&(this.$timer.show(),this._startGameTimer(this._timerLimitSeconds()))}},{key:"start",value:function(){this._madeAnyMistake=!1,$("#instructions").show(),$("#controls").show(),this._instructionsRemoved=!1,this._wireAccidentalPalette(),this._wireStaffTools(),this._wireFirstNoteLearningTracker(),this._wireControls(),this._resetProgress(),this._setTimedOutInteractivityDisabled(!1),this._hideTimeUpMessage(),this._hideSkipRoundButton(),this._syncHandPointerVisibility(),this._isTimerEnabled()?(this.$timer.show(),this._armUiSfxOnFirstGesture(),this._resetRoundTimerIfEnabled()):(this._stopGameTimer(),this.$timer.hide()),this.newChallenge(),this._armUiGates({resetInstructions:!0}),$("#page-wrapper").fadeIn("fast")}},{key:"newChallenge",value:function(){throw new Error("newChallenge() not implemented")}},{key:"_onCheck",value:function(){throw new Error("_onCheck() not implemented")}},{key:"_wireAccidentalPalette",value:function(){$("#accidentals .music-font__doublesharp, #accidentals .music-font__doubleflat").addClass("d-none")}},{key:"_wireStaffTools",value:function(){var t=this;this.staff.enableNoteDragAndClickDelete(),this.staff.enableGhostClickCreate(),this.staff.enableAccidentalDrag($("#accidentals .music-font__sharp, #accidentals .music-font__flat, #accidentals .music-font__natural")),this.staff.enableAccidentalDropOnStaff(),this.$staffEl.off("staff:noteState._log.".concat(this.ns)).on("staff:noteState._log.".concat(this.ns),function(e,n){var i,a=u(t.staff,n.step,n.accidentalClass),r=a.replace(/\d+$/,"");t.showLetterNames&&t.$staffEl.find('.note[data-note-id="'.concat(n.noteId,'"] .lettername')).text(r),"fixed"===n.source&&(t._fixedNote={letterWithAcc:r,letterOnly:r.replace(/[#b]+$/,"")},t._fixedState={step:n.step,accidentalClass:n.accidentalClass||null,midi:n.midi},null===(i=t._onFixedNoteState)||void 0===i||i.call(t,n,a,r)),console.log("fixed"===n.source?"Fixed note:":"User note:",a,{midi:n.midi,noteId:n.noteId,step:n.step,clef:t.staff.getClef()})})}},{key:"_firstNoteCookieName",value:function(){var t=String(this.ns||"staffGame").trim().replace(/[^a-zA-Z0-9_-]/g,"_");return"music_first_note_learned_".concat(t)}},{key:"_getCookie",value:function(t){for(var e="".concat(t,"="),n=String(document.cookie||"").split("; "),i=0;i<n.length;i+=1)if(n[i].startsWith(e))return decodeURIComponent(n[i].slice(e.length));return null}},{key:"_setCookie",value:function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:3650,i=new Date;i.setTime(i.getTime()+24*n*60*60*1e3);var a="expires=".concat(i.toUTCString());document.cookie="".concat(t,"=").concat(encodeURIComponent(String(e)),"; ").concat(a,"; path=/; SameSite=Lax")}},{key:"_hasLearnedFirstNote",value:function(){return"1"===this._getCookie(this._firstNoteCookieName())}},{key:"_markLearnedFirstNote",value:function(){this._setCookie(this._firstNoteCookieName(),"1")}},{key:"_syncHandPointerVisibility",value:function(){var t;null!==(t=this.$handPointer)&&void 0!==t&&t.length&&(this._hasLearnedFirstNote()?this.$handPointer.hide():this.$handPointer.show())}},{key:"_wireFirstNoteLearningTracker",value:function(){var t=this;this.$staffEl.off("staff:userNoteAdded._learn.".concat(this.ns)).on("staff:userNoteAdded._learn.".concat(this.ns),function(){var e,n,i,a;if(t._hasLearnedFirstNote())return null===(i=t.$handPointer)||void 0===i||null===(a=i.hide)||void 0===a||a.call(i),void t.$staffEl.off("staff:userNoteAdded._learn.".concat(t.ns));t._markLearnedFirstNote(),null===(e=t.$handPointer)||void 0===e||null===(n=e.hide)||void 0===n||n.call(e),t.$staffEl.off("staff:userNoteAdded._learn.".concat(t.ns))})}},{key:"_wireControls",value:function(){var t=this;$("#clear").off("click.".concat(this.ns)).on("click.".concat(this.ns),function(){return t.staff.clearNotes()}),this.$checkBtn.off("click.".concat(this.ns)).on("click.".concat(this.ns),function(){return t._onCheck()}),this.$helpBtn.off("click.".concat(this.ns,"Help")).on("click.".concat(this.ns,"Help"),function(){t._usedHintThisRound=!0,t._showHintNote()}),this.$skipBtn.off("click.".concat(this.ns,"Skip")).on("click.".concat(this.ns,"Skip"),function(e){e.preventDefault(),t._finishRoundAsTimedOut()}),this._continueBound||(this._continueBound=!0,$("#continue button").off("click.".concat(this.ns)).on("click.".concat(this.ns),function(){$("#continue").hide(),t._hideSkipRoundButton(),t._hideTimeUpMessage(),t._setTimedOutInteractivityDisabled(!1),t._resetRoundTimerIfEnabled(),t.newChallenge(),t._armUiGates({resetInstructions:!1}),t.$checkBtn.enable()}))}},{key:"_instructionsAfterUserNotes",value:function(){var t=Number(this.opts.instructionsAfterUserNotes);return Number.isFinite(t)&&t>=0?Math.floor(t):1}},{key:"_checkAfterUserNotes",value:function(){var t=Number(this.opts.checkAfterUserNotes);return Number.isFinite(t)&&t>=0?Math.floor(t):1}},{key:"_armUiGates",value:function(){var t=this,e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).resetInstructions,n=this._instructionsAfterUserNotes(),i=this._checkAfterUserNotes();e&&(this._instructionsRemoved=!1),$("#check").show().addClass("invisible"),this._userNotesSinceGate=0,this.$staffEl.off("staff:userNoteAdded._uiGate.".concat(this.ns)).on("staff:userNoteAdded._uiGate.".concat(this.ns),function(){t._userNotesSinceGate+=1,!t._instructionsRemoved&&t._userNotesSinceGate>=n&&($("#instructions").remove(),t._instructionsRemoved=!0),t._userNotesSinceGate>=i&&($("#check").removeClass("invisible"),t.$staffEl.off("staff:userNoteAdded._uiGate.".concat(t.ns)))})}},{key:"_initialNoteRangeIndex",value:function(){var t=null!=this.opts.initialNoteRange?this.opts.initialNoteRange:null!=this.opts.range?this.opts.range:void 0;if(null==t)throw new Error("[BaseStaffGame] Missing required option: initialNoteRange (0=narrow, 1=wide, 2=full).");var e=Number(t);if(!Number.isFinite(e))throw new Error("[BaseStaffGame] initialNoteRange must be a number (0, 1, or 2). Got: ".concat(String(t)));var n=Math.trunc(e);return 0===n||1===n||2===n?n:(console.warn("[BaseStaffGame] initialNoteRange out of range; defaulting to 2 (full).",{value:t}),2)}},{key:"_clefMainLineStep",value:function(t){switch(String(t||"").trim().toLowerCase()){case"bass":case"tenor":return 6;case"alto":return 4;default:return 2}}},{key:"_initialFixedStepBounds",value:function(){var t=this.staff.minStepAllowed(),e=this.staff.maxStepAllowed(),n=this._initialNoteRangeIndex();if(2===n)return{min:t,max:e};var i=this._clefMainLineStep(this.staff.getClef()),a=2*(0===n?1:2);return{min:Math.max(t,i-a),max:Math.min(e,i+a)}}},{key:"_isStepInInitialFixedRange",value:function(t){if(!Number.isFinite(t))return!1;var e=this._initialFixedStepBounds(),n=e.min,i=e.max;return t>=n&&t<=i}},{key:"_randomInitialFixedStep",value:function(){var t=this._initialFixedStepBounds(),e=t.min,n=t.max;return Math.floor(Math.random()*(n-e+1))+e}},{key:"_computeHintAnswer",value:function(){return null}},{key:"_computeHintAnswers",value:function(){var t=this._computeHintAnswer();return t?[t]:[]}},{key:"_removeAllHintNotes",value:function(){var t=this;(Array.isArray(this._activeHintIds)?this._activeHintIds:[]).forEach(function(e){return t.staff.removeNote(e)}),this._activeHintIds=[]}},{key:"_randomFreeStep",value:function(){for(var t=this.staff.minStepAllowed(),e=this.staff.maxStepAllowed(),n=0;n<50;n++){var i=Math.floor(Math.random()*(e-t+1))+t;if(!this.staff._isStepOccupied(i,null))return i}return null}},{key:"_attachHintBlinkRemoval",value:function(t){var e=this,n=this.$staffEl.find('.note[data-note-id="'.concat(t,'"]'));n.length&&n.off("animationend.hint.".concat(t," webkitAnimationEnd.hint.").concat(t)).one("animationend.hint.".concat(t," webkitAnimationEnd.hint.").concat(t),function(){e.staff.removeNote(t),e._activeHintIds=(e._activeHintIds||[]).filter(function(e){return e!==t})})}},{key:"_showHintNote",value:function(){this._removeAllHintNotes();var t=this._computeHintAnswers(),e=Array.isArray(t)&&t.length?t:[{step:null,accidentalClass:null}];this._activeHintIds=[];for(var n=0;n<e.length;n++){var i=e[n]||{},a=i.id||(1===e.length?"hint":"hint".concat(n+1)),r=Number.isFinite(i.step)?Number(i.step):null,o=i.accidentalClass||null;null==r&&(r=this._randomFreeStep()),null!=r&&this.staff.addNote({id:a,step:r,className:"hint blink",allowOccupied:!0,skipResolve:!0})&&(this._activeHintIds.push(a),o&&(this.staff.attachAccidentalToNote(a,o),this.$staffEl.find('.accidental[data-for-note-id="'.concat(a,'"]')).addClass("hint blink")),this.$staffEl.find('.ledger[data-for-note-id="'.concat(a,'"]')).addClass("hint blink"),this._attachHintBlinkRemoval(a))}}},{key:"_isPracticeMode",value:function(){var t=this.opts.practiceMode;return!0===t||"on"===String(t||"").trim().toLowerCase()}},{key:"_syncPracticeUi",value:function(){var t=this._isPracticeMode(),e=$("#score");t?(e.hide(),this.$progressBar.parent().addClass("opacity-1")):(e.show(),this.$progressBar.parent().removeClass("opacity-1"))}},{key:"_successAnimation",value:function(){(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).isBonus?this._playSuccessSfxBonus():this._playSuccessSfxBasic(),this.$helpBtn.hide(),this.$accidentals.addClass("invisible"),this.$feedback.find(".message span").text(r(this.successPhrases)),this.$feedback.stop(!0,!0).fadeIn("fast")}},{key:"_showIncrement",value:function(t){var e=this.$increment;e&&e.length&&(e.stop(!0,!0),e.text("+".concat(t)).show(),e.animateCSS?e.animateCSS("fadeOutUp").then(function(){return e.hide()}):setTimeout(function(){return e.hide()},800))}},{key:"_showBonusBadge",value:function(t){this.$bonusBadge&&this.$bonusBadge.length&&(!t||t<=0?this.$bonusBadge.hide():(this.$bonusBadge.text("+".concat(t," BONUS")).show(),this.$bonusBadge.animateCSS&&this.$bonusBadge.animateCSS("tada")))}},{key:"_awardPointsForCorrect",value:function(){if(this._isPracticeMode())return this.$points.text("0"),this._showBonusBadge(0),{earned:0,firstTry:!1,bonusEarned:0};if(this._usedHintThisRound)return this._showBonusBadge(0),{earned:0,firstTry:!1,bonusEarned:0};var t=!this._madeMistakeThisRound,e=Number.isFinite(this.opts.basePoints)?this.opts.basePoints:1,n=Number.isFinite(this.opts.firstTryBonus)?this.opts.firstTryBonus:0,i=t?e+n:e,a=t?n:0;return t&&(this._correctStreak+=1,this._correctStreak<=1?console.log("[BaseStaffGame] Correct answer. No streak yet."):console.log("[BaseStaffGame] Streak ".concat(this._correctStreak,"x"))),this.points+=i,this.$points.text(String(this.points)),this._showBonusBadge(a),{earned:i,firstTry:t,bonusEarned:a}}},{key:"getCorrectStreak",value:function(){return Math.max(0,Number(this._correctStreak)||0)}},{key:"_resetProgress",value:function(){this._syncPracticeUi(),this._correctStreak=0,this._madeAnyMistake=!1,this.$progressBar.data("progress",0),this.$progressBar.css({width:"0%"}),this._isPracticeMode()?this.$progressCounter.text("Practice"):this.$progressCounter.text("")}},{key:"_updateProgressBar",value:function(){if(this._isPracticeMode())return this.$progressBar.data("progress",0),this.$progressBar.css({width:"0%"}),this.$progressCounter.text("Practice"),0;var t=Math.max(1,this.numOfChallenges||1),e=100/t,n=parseFloat(this.$progressBar.data("progress"))||0;n=Math.min(100,n+e),this.$progressBar.data("progress",n),this.$progressBar.css({width:"".concat(n,"%")});var i=Math.min(t,Math.max(0,Math.round(n/e)));return this.$progressCounter.text("".concat(i," of ").concat(t)),n}},{key:"_failAnimation",value:function(t){var e=this;this._correctStreak=0,this._playFailSfx();var n=t||this.$checkWrap;n.removeClass("animate__animated animate__shakeX"),n[0]&&n[0].offsetWidth,n.addClass("animate__animated animate__shakeX"),n.off("animationend._fail.".concat(this.ns," webkitAnimationEnd._fail.").concat(this.ns," oAnimationEnd._fail.").concat(this.ns," MSAnimationEnd._fail.").concat(this.ns)).one("animationend._fail.".concat(this.ns," webkitAnimationEnd._fail.").concat(this.ns," oAnimationEnd._fail.").concat(this.ns," MSAnimationEnd._fail.").concat(this.ns),function(){n.removeClass("animate__animated animate__shakeX"),e.$checkBtn.enable()})}},{key:"_showFinalResults",value:function(){var t,e,n,i,a=this;if(!this._isPracticeMode()){var r=Math.max(0,null!==(t=this._stats.checksTotal)&&void 0!==t?t:0),o=Math.max(0,null!==(e=this._stats.checksCorrect)&&void 0!==e?e:0),s=r?Math.round(o/r*100):0,l=null!==(n=this._stats.finishedAtMs)&&void 0!==n?n:Date.now(),c=Math.max(0,Math.floor((l-N)/1e3)),u=r>0&&!this._madeAnyMistake,f=u?2*this.points:this.points;u?(setTimeout(function(){var t,e;null===(t=a.$doublePoints)||void 0===t||null===(e=t.show)||void 0===e||e.call(t),a._playPerfectGameBonusSfx()},1750),console.log("[BaseStaffGame] Perfect game! 2x bonus applied.",{basePoints:this.points,finalPoints:f})):console.log("[BaseStaffGame] No perfect-game bonus.",{basePoints:this.points,finalPoints:f,madeAnyMistake:this._madeAnyMistake});var h=null===(i=window)||void 0===i||null===(i=i.CountUp)||void 0===i?void 0:i.CountUp,d=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=a.$finalOverlay.find(t)[0];if(i){var r=function(){if(h){var t=new h(i,e,x({duration:3.5},n));t.error||t.start()}else i.textContent=String(n.formattingFn?n.formattingFn(e):e)+(n.suffix||"")},o=$(i).closest("#metrics-boxes > div"),s=o.length?parseFloat(o[0].style.animationDelay||"0"):0,l=Number.isFinite(s)?Math.max(0,s):0;if(l<=0)r();else{var c=setTimeout(r,l+40);a._finalCountupTimeouts.push(c)}}},p=this.$finalOverlay.find("#result-greeting"),v=p.find("h1"),_=p.find("h6"),m=this.$finalOverlay.find("img").first();if(s<50){if(v.text("Keep going!"),_.text("That round was tough, but your next one can be much better."),m.length){var y=String(m.attr("src")||"");y.includes("trophy.svg")&&m.attr("src",y.replace("trophy.svg","plant.svg"))}}else if(v.text("Great job!"),_.text("It's not about getting the most points, but if it was..."),m.length){var g=String(m.attr("src")||"");g.includes("plant.svg")&&m.attr("src",g.replace("plant.svg","trophy.svg"))}this.$finalOverlay.show(),this._animateFinalMetricsWithSfx(),this._clearFinalCountupTimers(),d('span[name="rounds"]',this.numOfChallenges),d('span[name="score"]',f),d('span[name="accuracy"]',s,{suffix:"%"}),d('span[name="duration"]',c,{formattingFn:function(t){var e=Math.max(0,Math.floor(t)),n=String(Math.floor(e/60)).padStart(2,"0"),i=String(e%60).padStart(2,"0");return"".concat(n,":").concat(i)}}),this._playFinalSfx()}}}],n&&A(e.prototype,n),i&&A(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,n,i,a,o}();function O(t){return 2===t?"music-font__doublesharp":1===t?"music-font__sharp":0===t?"music-font__natural":-1===t?"music-font__flat":-2===t?"music-font__doubleflat":null}function P(t,e){var n=function(t){var e=String(t||"").trim().match(/^([A-Ga-g])((?:#{1,2})|(?:b{1,2})|)?(\d+)$/);if(!e)return null;var n=e[1].toUpperCase(),i=e[2]||"",a="##"===i?2:"#"===i?1:"bb"===i?-2:"b"===i?-1:0;return{midi:12*(parseInt(e[3],10)+1)+{C:0,D:2,E:4,F:5,G:7,A:9,B:11}[n]+a,accOffset:a,accidentalClass:O(a)}}(e);if(!n)return null;for(var i=n.midi,a=n.accOffset,r=n.accidentalClass,o=t.minStepAllowed();o<=t.maxStepAllowed();o+=1){if(t._stepToMidi(o)+a===i)return{step:o,accidentalClass:r}}for(var s=null,l=t.minStepAllowed();l<=t.maxStepAllowed();l+=1){var c=t._stepToMidi(l),u=Math.abs(c+a-i);(!s||u<s.dist)&&(s={step:l,dist:u})}return s?{step:s.step,accidentalClass:r}:null}function M(t){return M="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},M(t)}function F(){var t,e,n="function"==typeof Symbol?Symbol:{},i=n.iterator||"@@iterator",a=n.toStringTag||"@@toStringTag";function r(n,i,a,r){var l=i&&i.prototype instanceof s?i:s,c=Object.create(l.prototype);return B(c,"_invoke",function(n,i,a){var r,s,l,c=0,u=a||[],f=!1,h={p:0,n:0,v:t,a:d,f:d.bind(t,4),d:function(e,n){return r=e,s=0,l=t,h.n=n,o}};function d(n,i){for(s=n,l=i,e=0;!f&&c&&!a&&e<u.length;e++){var a,r=u[e],d=h.p,p=r[2];n>3?(a=p===i)&&(l=r[(s=r[4])?5:(s=3,3)],r[4]=r[5]=t):r[0]<=d&&((a=n<2&&d<r[1])?(s=0,h.v=i,h.n=r[1]):d<p&&(a=n<3||r[0]>i||i>p)&&(r[4]=n,r[5]=i,h.n=p,s=0))}if(a||n>1)return o;throw f=!0,i}return function(a,u,p){if(c>1)throw TypeError("Generator is already running");for(f&&1===u&&d(u,p),s=u,l=p;(e=s<2?t:l)||!f;){r||(s?s<3?(s>1&&(h.n=-1),d(s,l)):h.n=l:h.v=l);try{if(c=2,r){if(s||(a="next"),e=r[a]){if(!(e=e.call(r,l)))throw TypeError("iterator result is not an object");if(!e.done)return e;l=e.value,s<2&&(s=0)}else 1===s&&(e=r.return)&&e.call(r),s<2&&(l=TypeError("The iterator does not provide a '"+a+"' method"),s=1);r=t}else if((e=(f=h.n<0)?l:n.call(i,h))!==o)break}catch(e){r=t,s=1,l=e}finally{c=1}}return{value:e,done:f}}}(n,a,r),!0),c}var o={};function s(){}function l(){}function c(){}e=Object.getPrototypeOf;var u=[][i]?e(e([][i]())):(B(e={},i,function(){return this}),e),f=c.prototype=s.prototype=Object.create(u);function h(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,c):(t.__proto__=c,B(t,a,"GeneratorFunction")),t.prototype=Object.create(f),t}return l.prototype=c,B(f,"constructor",c),B(c,"constructor",l),l.displayName="GeneratorFunction",B(c,a,"GeneratorFunction"),B(f),B(f,a,"Generator"),B(f,i,function(){return this}),B(f,"toString",function(){return"[object Generator]"}),(F=function(){return{w:r,m:h}})()}function B(t,e,n,i){var a=Object.defineProperty;try{a({},"",{})}catch(t){a=0}B=function(t,e,n,i){function r(e,n){B(t,e,function(t){return this._invoke(e,n,t)})}e?a?a(t,e,{value:n,enumerable:!i,configurable:!i,writable:!i}):t[e]=n:(r("next",0),r("throw",1),r("return",2))},B(t,e,n,i)}function R(t,e,n,i,a,r,o){try{var s=t[r](o),l=s.value}catch(t){return void n(t)}s.done?e(l):Promise.resolve(l).then(i,a)}function D(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,i)}return n}function G(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?D(Object(n),!0).forEach(function(e){H(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):D(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function I(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,X(i.key),i)}}function j(t,e,n){return e=W(e),function(t,e){if(e&&("object"==M(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(t,U()?Reflect.construct(e,n||[],W(t).constructor):e.apply(t,n))}function U(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(t){}return(U=function(){return!!t})()}function L(){return L="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(t,e,n){var i=function(t,e){for(;!{}.hasOwnProperty.call(t,e)&&null!==(t=W(t)););return t}(t,e);if(i){var a=Object.getOwnPropertyDescriptor(i,e);return a.get?a.get.call(arguments.length<3?t:n):a.value}},L.apply(null,arguments)}function W(t){return W=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},W(t)}function Y(t,e){return Y=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},Y(t,e)}function H(t,e,n){return(e=X(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function X(t){var e=function(t,e){if("object"!=M(t)||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var i=n.call(t,e||"default");if("object"!=M(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==M(e)?e:e+""}T(E,"MIN_CHALLENGES",2),T(E,"MAX_CHALLENGES",12);var V=function(t){function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e);var i={staffEl:"#staff",basePoints:1,firstTryBonus:2,namespace:"dictationChallenge",maxUserNotes:1,instructionsAfterUserNotes:1,checkAfterUserNotes:1},a=G(G(G({},i),n),{},{accidentalWeights:G(G({},i.accidentalWeights||{}),n.accidentalWeights||{}),intervals:Array.isArray(n.intervals)&&n.intervals.length?n.intervals.slice():e.INTERVALS_DEFAULT.slice()}),r=function(t){for(var e=(Array.isArray(t)?t:null!=t?[t]:["treble","bass"]).map(function(t){return o(t)}).filter(Boolean),n=[],i=0;i<e.length;i+=1)n.includes(e[i])||n.push(e[i]);return n.length?n:["treble","bass"]}(null!=a.clefs?a.clefs:a.clef);return(t=j(this,e,[G(G({},a),{},{initialClef:r&&r[0]?r[0]:"treble"})]))._clefPool=r,t._expectedFirst=null,t._expectedSecond=null,t._dictationTimeouts=[],t._dictSynth=null,t._dictAudioReady=!1,t.$playWrap=null,t.$playPlayBtn=null,t.$playStopBtn=null,t}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&Y(t,e)}(e,t),n=e,i=[{key:"start",value:function(){var t,n,i,a,r,o=this;(t=e,n="start",i=this,r=L(W(1&(a=3)?t.prototype:t),n,i),2&a&&"function"==typeof r?function(t){return r.apply(i,t)}:r)([]),this.staff&&"function"==typeof this.staff._soundEnabled&&(this.staff._soundEnabled=function(){return!1}),this.$playWrap=$("#play"),this.$playPlayBtn=this.$playWrap.find('button[action="play"]'),this.$playStopBtn=this.$playWrap.find('button[action="stop"]'),this.$playPlayBtn.off("click.".concat(this.ns,"Play")).on("click.".concat(this.ns,"Play"),function(t){t.preventDefault(),o.playDictation()}),this.$playStopBtn.off("click.".concat(this.ns,"Stop")).on("click.".concat(this.ns,"Stop"),function(t){t.preventDefault(),o._stopDictationPlayback(),o._setPlayButtons(!1)}),$("#continue button").off("click.".concat(this.ns,"ShowPlay")).on("click.".concat(this.ns,"ShowPlay"),function(){var t;null!==(t=o.$playWrap)&&void 0!==t&&t.length&&o.$playWrap.show(),o._setPlayButtons(!1)}),this._setPlayButtons(!1)}},{key:"_setPlayButtons",value:function(t){var e,n;null!==(e=this.$playPlayBtn)&&void 0!==e&&e.length&&this.$playPlayBtn.toggle(!t),null!==(n=this.$playStopBtn)&&void 0!==n&&n.length&&this.$playStopBtn.toggle(!!t)}},{key:"playDictation",value:function(){var t=this;if(this._expectedFirst&&this._expectedSecond){this._stopDictationPlayback(),this._setPlayButtons(!0);var e=this.staff._stepToMidi(this._expectedFirst.step)+(this.staff._accidentalClassToOffset(this._expectedFirst.accidentalClass)||0);this._playMidi(e,.6,0),this._playMidi(this._expectedSecond.midi,.6,1),this._playMidi(e,.6,2),this._playMidi(e,.6,3),this._playMidi(this._expectedSecond.midi,.6,3),this._dictationTimeouts.push(setTimeout(function(){console.log("Dictation: user can now write the note on the staff."),t._setPlayButtons(!1)},3e3))}}},{key:"_stopDictationPlayback",value:function(){if(Array.isArray(this._dictationTimeouts)&&this._dictationTimeouts.forEach(function(t){return clearTimeout(t)}),this._dictationTimeouts=[],this._dictSynth&&this._dictSynth.dispose)try{this._dictSynth.dispose()}catch(t){}this._dictSynth=null,this._dictAudioReady=!1}},{key:"_ensureDictationAudio",value:(s=F().m(function t(){return F().w(function(t){for(;;)switch(t.n){case 0:if(window.Tone){t.n=1;break}return t.a(2);case 1:if(!this._dictAudioReady){t.n=2;break}return t.a(2);case 2:return t.n=3,Tone.start();case 3:this._dictSynth=new Tone.PolySynth(Tone.Synth,{oscillator:{type:"sine"},envelope:{attack:.01,decay:.08,sustain:.35,release:.25}}).toDestination(),this._dictAudioReady=!0;case 4:return t.a(2)}},t,this)}),l=function(){var t=this,e=arguments;return new Promise(function(n,i){var a=s.apply(t,e);function r(t){R(a,n,i,r,o,"next",t)}function o(t){R(a,n,i,r,o,"throw",t)}r(void 0)})},function(){return l.apply(this,arguments)})},{key:"_playMidi",value:function(t,e,n){var i=this;window.Tone&&this._ensureDictationAudio().then(function(){if(i._dictSynth){var a=Tone.now()+(Number(n)||0),r=Number(e)||.6;i._dictSynth.triggerAttackRelease(Tone.Frequency(t,"midi"),r,a)}})}},{key:"_pickInterval",value:function(){var t=Array.isArray(this.opts.intervals)&&this.opts.intervals.length?this.opts.intervals:e.INTERVALS_DEFAULT;return t[Math.floor(Math.random()*t.length)]}},{key:"_pickFixedNote",value:function(){var t,e=(t=this.opts.fixedNotes,null==t?[]:Array.isArray(t)?t:[t]).filter(Boolean);if(e.length){var n=r(e);return P(this.staff,n)}var i=this.opts.accidentalWeights||{},a=function(t){var e=Array.isArray(t)?t.filter(function(t){return t&&Number.isFinite(t.weight)&&t.weight>0}):[];if(!e.length)return null;for(var n=e.reduce(function(t,e){return t+e.weight},0),i=Math.random()*n,a=0;a<e.length;a++)if((i-=e[a].weight)<=0)return e[a].value;return e[e.length-1].value}([{value:null,weight:Number(i.natural)||0},{value:"music-font__sharp",weight:Number(i.sharp)||0},{value:"music-font__flat",weight:Number(i.flat)||0}]);return{step:this._randomInitialFixedStep(),accidentalClass:a}}},{key:"_intervalSemitones",value:function(t,e){var n={1:0,2:2,3:4,4:5,5:7,6:9,7:11,8:12}[e];if(null==n)return null;var i=1===e||4===e||5===e||8===e,a=String(t||"").trim();return i?"P"===a?n:/^A+$/.test(a)?n+a.length:/^d+$/.test(a)?n-a.length:null:"M"===a?n:"m"===a?n-1:/^A+$/.test(a)?n+a.length:/^d+$/.test(a)?n-(a.length+1):null}},{key:"_computeSecondFromFixed",value:function(t,e,n){var i,a=this,o=(i=String(t||"").trim().match(/^([PMAmd]+)(\d+)$/))?{quality:i[1],number:parseInt(i[2],10)}:null;if(!o||!Number.isFinite(o.number)||o.number<1)return null;var s=o.number-1,l=(o.number-1)%7+1,c=Math.floor((o.number-1)/7),u=this._intervalSemitones(o.quality,l);if(null==u)return null;var f=u+12*c,h=this.staff.minStepAllowed(),d=this.staff.maxStepAllowed(),p=function(t){var i=e+t*s;if(i<h||i>d)return null;var r=n+t*f,o=r-a.staff._stepToMidi(i);if(o<-2||o>2)return null;var l=O(o);return l?{step:i,accidentalClass:l,accOff:o,midi:r}:null},v=p(1),_=p(-1);return v&&_?r([v,_]):v||_||null}},{key:"newChallenge",value:function(){var t,e,n;null!==(t=this.$playWrap)&&void 0!==t&&t.length&&this.$playWrap.show(),this._setPlayButtons(!1),this.$helpBtn.hide(),this._fixedState=null,this._expectedFirst=null,this._expectedSecond=null;var i,a,r=(i=this._clefPool,1===(a=Array.isArray(i)&&i.length?i:["treble","bass"]).length?a[0]:a[Math.floor(Math.random()*a.length)]);r&&r!==this.staff.getClef()&&this.staff.setClef(r),this._madeMistakeThisRound=!1,this._usedHintThisRound=!1,this.$bonusBadge.hide(),null===(e=this.$doublePoints)||void 0===e||null===(n=e.hide)||void 0===n||n.call(e);for(var o=this._pickInterval(),s=null,l=null,c=0;c<40;c+=1)if(s=this._pickFixedNote()){var u=this.staff._accidentalClassToOffset(s.accidentalClass)||0,f=this.staff._stepToMidi(s.step)+u;if(l=this._computeSecondFromFixed(o,s.step,f))break}if(s&&l){this.staff.clearNotes(),this.$accidentals.removeClass("invisible"),this.$feedback.hide();var h="music-font__natural"===s.accidentalClass?null:s.accidentalClass||null,d=this.staff.addFixedNote({step:s.step,accidentalClass:h});d&&this.staff._emitNoteState(d,"fixed"),this._expectedFirst={step:s.step,accidentalClass:s.accidentalClass||null},this._expectedSecond=l,$("#continue").hide()}}},{key:"_notesOnStaffOrdered",value:function(){var t=this,e=this.$staffEl.find(".note").not(".preview").not(".hint").toArray().map(function(e){var n=e.getAttribute("data-note-id"),i=t.staff._stepOfNoteEl(e),a=t.staff._getAttachedAccidentalClass(n);return{id:n,step:i,accOff:t.staff._accidentalClassToOffset(a)||0,fixed:e.classList.contains("fixed")}});return e.sort(function(t,e){return t.step-e.step}),e}},{key:"_computeHintAnswer",value:function(){return this._expectedSecond?{step:this._expectedSecond.step,accidentalClass:this._expectedSecond.accidentalClass||null}:null}},{key:"_onCheck",value:function(){var t=this;this._stopDictationPlayback(),this._setPlayButtons(!1);var e=this._notesOnStaffOrdered();if(this.$checkBtn.disable(),this._stats.checksTotal+=1,this._expectedSecond){if(2!==e.length)return this._madeAnyMistake=!0,this._madeMistakeThisRound=!0,this._failAnimation(this.$checkWrap),void this.$helpBtn.show();var n=e.find(function(t){return!t.fixed})||null;if(!n)return this._madeAnyMistake=!0,this._madeMistakeThisRound=!0,this._failAnimation(this.$checkWrap),void this.$helpBtn.show();if(this.staff._stepToMidi(n.step)+(n.accOff||0)===this._expectedSecond.midi){var i;this._stats.checksCorrect+=1,this._pauseGameTimer();var a=this._awardPointsForCorrect(),r=a.earned,o=a.bonusEarned;this._successAnimation({isBonus:o>0}),null!==(i=this.$playWrap)&&void 0!==i&&i.length&&this.$playWrap.hide(),$("#score").animateCSS&&$("#score").animateCSS("heartBeat"),r>0&&this._showIncrement(r),this._updateProgressBar()>=100?(this._stats.finishedAtMs=Date.now(),this.$checkBtn.text("Final results, let's see…"),setTimeout(function(){return t._showFinalResults()},1600)):($("#check").hide(),$("#continue").show())}else this._madeAnyMistake=!0,this._madeMistakeThisRound=!0,this._failAnimation(this.$checkWrap),this.$helpBtn.show()}}}],i&&I(n.prototype,i),a&&I(n,a),Object.defineProperty(n,"prototype",{writable:!1}),n;var n,i,a,s,l}(E);function q(t){return q="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},q(t)}function z(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,i)}return n}function K(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?z(Object(n),!0).forEach(function(e){Z(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):z(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function Z(t,e,n){return(e=function(t){var e=function(t,e){if("object"!=q(t)||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var i=n.call(t,e||"default");if("object"!=q(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==q(e)?e:e+""}(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}H(V,"INTERVALS_DEFAULT",["M2","m3","M3","P5","P8"]);var J=readGlobal("__challengeOptions")||{},Q=readGlobal("__clefUrls")||null;new V(K(K({},J),{},{clefUrls:Q})).start()})();