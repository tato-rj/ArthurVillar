/*! For license information please see chords.js.LICENSE.txt */
(()=>{"use strict";var t=["music-font__sharp","music-font__doublesharp","music-font__flat","music-font__doubleflat","music-font__natural"],e={treble:{"--clef-width":"140px","--clef-height":"calc(var(--staff-line-gap) * 6)","--clef-top":"54px","--clef-left-nudge":"28px"},bass:{"--clef-width":"76px","--clef-height":"calc(var(--staff-line-gap) * 6)","--clef-top":"35px","--clef-left-nudge":"-12px"},alto:{"--clef-width":"88px","--clef-height":"calc(var(--staff-line-gap) * 6)","--clef-top":"47.5px","--clef-left-nudge":"-10px"},tenor:{"--clef-width":"88px","--clef-height":"calc(var(--staff-line-gap) * 6)","--clef-top":"22.5px","--clef-left-nudge":"-10px"}};function n(t,e,n){var i=t.getPropertyValue(e),a=parseFloat(i);return Number.isFinite(a)?a:n}function i(t){var e=t.originalEvent||t;return e.touches&&e.touches.length?{x:e.touches[0].pageX,y:e.touches[0].pageY}:e.changedTouches&&e.changedTouches.length?{x:e.changedTouches[0].pageX,y:e.changedTouches[0].pageY}:{x:e.pageX,y:e.pageY}}function a(t){var e=t.originalEvent||t;return e&&null!=e.pointerId?e.pointerId:null}function r(t,e){return Math.floor(Math.random()*(e-t+1))+t}function o(t){return Array.isArray(t)&&t.length?t[Math.floor(Math.random()*t.length)]:null}function s(t){var e=Array.isArray(t)?t.filter(function(t){return t&&Number.isFinite(t.weight)&&t.weight>0}):[];if(!e.length)return null;for(var n=e.reduce(function(t,e){return t+e.weight},0),i=Math.random()*n,a=0;a<e.length;a++)if((i-=e[a].weight)<=0)return e[a].value;return e[e.length-1].value}function l(t){return null==t?[]:Array.isArray(t)?t:[t]}function c(t){if(null==t)return null;var e=String(t||"treble").toLowerCase();return"bass"===e?"bass":"alto"===e?"alto":"tenor"===e?"tenor":"treble"}function u(t){return t.hasClass("music-font__sharp")?"sharp":t.hasClass("music-font__flat")?"flat":t.hasClass("music-font__natural")?"natural":null}function f(t,e){return"sharp"===e?"music-font__doublesharp"===t||"music-font__sharp"===t?"music-font__doublesharp":"music-font__sharp":"flat"===e?"music-font__doubleflat"===t||"music-font__flat"===t?"music-font__doubleflat":"music-font__flat":"natural"===e?"music-font__natural":t||null}function h(t,e){return"sharp"===e&&"music-font__doublesharp"===t||"flat"===e&&"music-font__doubleflat"===t}function d(t,e,n){var i,a=function(t,e){var n,i;switch(t.getClef()){case"bass":n=36,i=4;break;case"alto":n=48,i=3;break;case"tenor":n=48,i=1;break;default:n=60,i=2}var a=i+e,r=Math.floor(a/7),o=(a%7+7)%7,s=Math.floor(n/12)-1;return{letter:["C","D","E","F","G","A","B"][o],octave:s+r}}(t,e),r=a.letter,o=a.octave,s=(i=n)?i.includes("music-font__doublesharp")?"##":i.includes("music-font__sharp")?"#":i.includes("music-font__doubleflat")?"bb":i.includes("music-font__flat")?"b":"":"";return"".concat(r).concat(s).concat(o)}function p(t){return p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},p(t)}function v(){var t,e,n="function"==typeof Symbol?Symbol:{},i=n.iterator||"@@iterator",a=n.toStringTag||"@@toStringTag";function r(n,i,a,r){var l=i&&i.prototype instanceof s?i:s,c=Object.create(l.prototype);return _(c,"_invoke",function(n,i,a){var r,s,l,c=0,u=a||[],f=!1,h={p:0,n:0,v:t,a:d,f:d.bind(t,4),d:function(e,n){return r=e,s=0,l=t,h.n=n,o}};function d(n,i){for(s=n,l=i,e=0;!f&&c&&!a&&e<u.length;e++){var a,r=u[e],d=h.p,p=r[2];n>3?(a=p===i)&&(l=r[(s=r[4])?5:(s=3,3)],r[4]=r[5]=t):r[0]<=d&&((a=n<2&&d<r[1])?(s=0,h.v=i,h.n=r[1]):d<p&&(a=n<3||r[0]>i||i>p)&&(r[4]=n,r[5]=i,h.n=p,s=0))}if(a||n>1)return o;throw f=!0,i}return function(a,u,p){if(c>1)throw TypeError("Generator is already running");for(f&&1===u&&d(u,p),s=u,l=p;(e=s<2?t:l)||!f;){r||(s?s<3?(s>1&&(h.n=-1),d(s,l)):h.n=l:h.v=l);try{if(c=2,r){if(s||(a="next"),e=r[a]){if(!(e=e.call(r,l)))throw TypeError("iterator result is not an object");if(!e.done)return e;l=e.value,s<2&&(s=0)}else 1===s&&(e=r.return)&&e.call(r),s<2&&(l=TypeError("The iterator does not provide a '"+a+"' method"),s=1);r=t}else if((e=(f=h.n<0)?l:n.call(i,h))!==o)break}catch(e){r=t,s=1,l=e}finally{c=1}}return{value:e,done:f}}}(n,a,r),!0),c}var o={};function s(){}function l(){}function c(){}e=Object.getPrototypeOf;var u=[][i]?e(e([][i]())):(_(e={},i,function(){return this}),e),f=c.prototype=s.prototype=Object.create(u);function h(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,c):(t.__proto__=c,_(t,a,"GeneratorFunction")),t.prototype=Object.create(f),t}return l.prototype=c,_(f,"constructor",c),_(c,"constructor",l),l.displayName="GeneratorFunction",_(c,a,"GeneratorFunction"),_(f),_(f,a,"Generator"),_(f,i,function(){return this}),_(f,"toString",function(){return"[object Generator]"}),(v=function(){return{w:r,m:h}})()}function _(t,e,n,i){var a=Object.defineProperty;try{a({},"",{})}catch(t){a=0}_=function(t,e,n,i){function r(e,n){_(t,e,function(t){return this._invoke(e,n,t)})}e?a?a(t,e,{value:n,enumerable:!i,configurable:!i,writable:!i}):t[e]=n:(r("next",0),r("throw",1),r("return",2))},_(t,e,n,i)}function m(t,e,n,i,a,r,o){try{var s=t[r](o),l=s.value}catch(t){return void n(t)}s.done?e(l):Promise.resolve(l).then(i,a)}function y(t){return function(){var e=this,n=arguments;return new Promise(function(i,a){var r=t.apply(e,n);function o(t){m(r,i,a,o,s,"next",t)}function s(t){m(r,i,a,o,s,"throw",t)}o(void 0)})}}function g(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,b(i.key),i)}}function b(t){var e=function(t,e){if("object"!=p(t)||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var i=n.call(t,e||"default");if("object"!=p(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==p(e)?e:e+""}var S=function(){return r=function t(e,i){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.$el=e;var a=getComputedStyle(e[0]);this.opts=$.extend({paddingX:n(a,"--staff-padding-x",20),lineGap:n(a,"--staff-line-gap",16),lineThickness:n(a,"--staff-line-thickness",3),noteOverlapGap:n(a,"--note-overlap-gap",-6),noteIdPrefix:"n",clefUrls:null,clef:null,clefUrl:null,autoClef:!0,maxLedgerAbove:2,maxLedgerBelow:2,accidentalTopPx:20,accidentalGapPx:16,getMaxUserNotes:function(){return 1/0},sound:!0,accSnapMaxPx:1.2*n(a,"--staff-line-gap",25)},i||{}),this.opts.clef=null==this.opts.clef?null:c(this.opts.clef),this.opts.clef&&!this.opts.clefUrl&&(this.opts.clefUrl=this._clefUrlFor(this.opts.clef)),this.opts.stepSize=this.opts.lineGap/2,this.$el.css("position","relative"),this._idCounter=1,this._drag={isDragging:!1,movedPx:0,startPageY:0,noteId:null,thresholdPx:5,swallowClick:!1,startStep:null,lastTargetStep:null,lastSoundStep:null,dropOnOccupied:!1,outOfRange:!1},this._previewState={active:!1,step:null},this._preview=null,this._previewStep=null,this._audioReady=!1,this._synth=null,this._accDragSound={noteId:null,step:null,toolType:null,prospectiveCls:null},this._accSnap={noteId:null,dist:null,localY:null},this._suppressNextClick={noteId:null,until:0},this._applyClefCssVars(this.opts.clef),this._computeLayout(),this._drawLines(),this.opts.autoClef&&!this.opts.clef?this.setClef("treble"):this.opts.clef&&(this._applyClefCssVars(this.opts.clef),this.relayout())},o=[{key:"_clefUrlFor",value:function(t){var e=c(t);if(!e)return null;var n=this.opts.clefUrls||{};return n[e]||n.treble||null}},{key:"setSoundEnabled",value:function(t){if(this.opts.sound=!!t,!this.opts.sound&&window.Tone){try{Tone.Transport&&Tone.Transport.stop()}catch(t){}try{Tone.context&&Tone.context.suspend&&Tone.context.suspend()}catch(t){}try{this._synth&&this._synth.releaseAll&&this._synth.releaseAll()}catch(t){}}}},{key:"isSoundEnabled",value:function(){return!!this.opts.sound}},{key:"_soundEnabled",value:function(){return!!this.opts.sound}},{key:"_applyClefCssVars",value:function(t){var n=c(t),i=e[n]||e.treble,a=this.$el[0];Object.keys(i).forEach(function(t){return a.style.setProperty(t,i[t])})}},{key:"setClef",value:function(t){this.opts.clef=c(t),this.opts.clefUrl=this._clefUrlFor(this.opts.clef),this._applyClefCssVars(this.opts.clef),this.relayout()}},{key:"getClef",value:function(){return this.opts.clef||"treble"}},{key:"_maxUserNotes",value:function(){var t=this.opts.getMaxUserNotes?this.opts.getMaxUserNotes():1/0;return Number.isFinite(t)?t:1/0}},{key:"_userNoteCount",value:function(){return this.$el.find(".note").not(".fixed").not(".preview").not(".hint").length}},{key:"_computeLayout",value:function(){var t=this.$el.height(),e=4*this.opts.lineGap,n=Math.round((t-e)/2);this.opts.bottomLineY=n+e}},{key:"_drawLines",value:function(){this.$el.find(".staff-line, .staff-clef").remove();for(var t=0;t<5;t++){var e=this.opts.bottomLineY-(4-t)*this.opts.lineGap;$('<div class="staff-line"></div>').css({top:"".concat(e,"px")}).appendTo(this.$el)}this._drawClef()}},{key:"_drawClef",value:function(){if(this.opts.clefUrl){var t=c(this.opts.clef);$('<img alt="">').addClass("staff-clef").addClass("".concat(t,"-clef")).attr("src",this.opts.clefUrl).appendTo(this.$el)}}},{key:"relayout",value:function(){this._computeLayout(),this._drawLines(),this._resolveNoteOverlaps(),this._repositionAllAccidentals()}},{key:"centerX",value:function(){return this.$el.width()/2}},{key:"stepToY",value:function(t){return this.opts.bottomLineY-t*this.opts.stepSize}},{key:"yToStep",value:function(t){return Math.round((this.opts.bottomLineY-t)/this.opts.stepSize)}},{key:"_pageYToLocalY",value:function(t){return t-this.$el.offset().top}},{key:"minStepAllowed",value:function(){return 0-2*this.opts.maxLedgerBelow}},{key:"maxStepAllowed",value:function(){return 8+2*this.opts.maxLedgerAbove}},{key:"_isStepAllowed",value:function(t){return t>=this.minStepAllowed()&&t<=this.maxStepAllowed()}},{key:"_ledgerStepsFor",value:function(t){var e=[],n=8+2*this.opts.maxLedgerAbove,i=0-2*this.opts.maxLedgerBelow;if(t>8)for(var a=Math.min(t,n),r=10;r<=a;r+=2)e.push(r);else if(t<0)for(var o=Math.max(t,i),s=-2;s>=o;s-=2)e.push(s);return e}},{key:"_renderLedgers",value:function(t,e,n){this.$el.find('.ledger[data-for-note-id="'.concat(t,'"]')).remove();for(var i=this.$el.find('.note[data-note-id="'.concat(t,'"]')).hasClass("dragging"),a=this._ledgerStepsFor(n),r=0;r<a.length;r++){var o=$('<div class="ledger"></div>').attr("data-for-note-id",t).css({left:"".concat(e,"px"),top:"".concat(this.stepToY(a[r]),"px")});i&&o.addClass("dragging"),o.appendTo(this.$el)}}},{key:"_previewLedgersClear",value:function(){this.$el.find(".ledger.preview").remove()}},{key:"_previewLedgersSet",value:function(t){this._previewLedgersClear();for(var e=this.centerX(),n=this._ledgerStepsFor(t),i=0;i<n.length;i++)$('<div class="ledger preview"></div>').css({left:"".concat(e,"px"),top:"".concat(this.stepToY(n[i]),"px")}).appendTo(this.$el)}},{key:"_stepOfNoteEl",value:function(t){var e=t.style.top||window.getComputedStyle(t).top;return this.yToStep(parseFloat(e))}},{key:"_isStepOccupied",value:function(t,e){for(var n=this.$el.find(".note").toArray(),i=0;i<n.length;i++){var a=n[i];if(a){var r=a.getAttribute("data-note-id");if((!e||r!==e)&&this._stepOfNoteEl(a)===t)return!0}}return!1}},{key:"_getNoteIdAtStep",value:function(t,e){for(var n=this.$el.find(".note").toArray(),i=0;i<n.length;i++){var a=n[i];if(a){var r=a.getAttribute("data-note-id");if((!e||r!==e)&&this._stepOfNoteEl(a)===t)return r}}return null}},{key:"_isCenteredX",value:function(t){var e=this.$el.find('.note[data-note-id="'.concat(t,'"]'));return!e.length||Math.abs(parseFloat(e.css("left"))-this.centerX())<=.5}},{key:"isNoteFixed",value:function(t){var e=this.$el.find('.note[data-note-id="'.concat(t,'"]'));return!!e.length&&e.hasClass("fixed")}},{key:"_nearestEditableNoteByLocalY",value:function(t){for(var e=Number.isFinite(this.opts.accSnapMaxPx)?this.opts.accSnapMaxPx:1.2*this.opts.lineGap,n=null,i=this.$el.find(".note").not(".preview").toArray(),a=0;a<i.length;a++){var r=i[a],o=r.getAttribute("data-note-id");if(o&&!$(r).hasClass("fixed")){var s=parseFloat(r.style.top||window.getComputedStyle(r).top),l=Math.abs(s-t);(null==n||l<n.dist)&&(n={noteId:o,dist:l})}}return!n||n.dist>e?null:n}},{key:"_removeAccidentalForNote",value:function(t){this.$el.find('.accidental[data-for-note-id="'.concat(t,'"]')).remove()}},{key:"_accidentalAnchorXForNote",value:function(t){var e=this.centerX();return Number.isFinite(t)&&t>e+.5?e:t}},{key:"_positionAccidentalForNote",value:function(t){var e=this.$el.find('.note[data-note-id="'.concat(t,'"]')),n=this.$el.find('.accidental[data-for-note-id="'.concat(t,'"]'));if(e.length&&n.length){var i=parseFloat(e.css("left")),a=parseFloat(e.css("top")),r=this._accidentalAnchorXForNote(i);n.css({left:"".concat(r-this.opts.accidentalGapPx,"px"),top:"".concat(a-this.opts.accidentalTopPx,"px")})}}},{key:"_rectsOverlap",value:function(t,e){return!(t.right<=e.left||t.left>=e.right||t.bottom<=e.top||t.top>=e.bottom)}},{key:"_repositionAllAccidentals",value:function(){var t=this;this.$el.find(".accidental").each(function(e,n){var i=n.getAttribute("data-for-note-id");i&&t._positionAccidentalForNote(i)});for(var e=this.$el.find(".note").not(".preview").toArray(),n={},i=0;i<e.length;i++){var a=e[i],r=a.getAttribute("data-note-id");r&&(n[this._stepOfNoteEl(a)]=r)}for(var o=Object.keys(n).map(function(t){return parseInt(t,10)}).sort(function(t,e){return t-e}),s=0;s<o.length;s++){var l=o[s],c=l+1,u=n[l],f=n[c];if(u&&f){var h=this.$el.find('.accidental[data-for-note-id="'.concat(u,'"]')),d=this.$el.find('.accidental[data-for-note-id="'.concat(f,'"]'));if(h.length&&d.length){var p=h[0].getBoundingClientRect(),v=d[0].getBoundingClientRect();if(this._rectsOverlap(p,v)){var _=Math.max(0,v.right-p.left),m=parseFloat(d.css("left"));Number.isFinite(m)&&d.css("left","".concat(m-(_+-6),"px"))}}}}}},{key:"_getAttachedAccidentalClass",value:function(e){var n=this.$el.find('.accidental[data-for-note-id="'.concat(e,'"]'));if(!n.length)return null;for(var i=0;i<t.length;i++){var a=t[i];if(n.hasClass(a))return a}return null}},{key:"attachAccidentalToNote",value:function(t,e){if(t&&!this.isNoteFixed(t)){this._removeAccidentalForNote(t);var n=$('<div class="accidental music-font"></div>').addClass(e).attr("data-for-note-id",t);this.$el.append(n),this._repositionAllAccidentals()}}},{key:"_hintIgnoredAccidental",value:function(t){var e=this.$el.find('.note[data-note-id="'.concat(t,'"]'));e.length&&(e.removeClass("animate__animated animate__headShake"),e[0].offsetWidth,e.addClass("animate__animated animate__headShake"),e.off("animationend._hint webkitAnimationEnd._hint oAnimationEnd._hint MSAnimationEnd._hint").one("animationend._hint webkitAnimationEnd._hint oAnimationEnd._hint MSAnimationEnd._hint",function(){e.removeClass("animate__animated animate__headShake")}))}},{key:"applyAccidentalToolToNote",value:function(t,e){if(!t||this.isNoteFixed(t))return!1;var n=this._getAttachedAccidentalClass(t);if(h(n,e))return this._hintIgnoredAccidental(t),!1;var i=f(n,e);return("natural"!==e||"music-font__natural"!==n)&&i!==n&&(this.attachAccidentalToNote(t,i),this._emitNoteState(t,"user"),!0)}},{key:"_ensureAudio",value:(d=y(v().m(function t(){return v().w(function(t){for(;;)switch(t.n){case 0:if(this._soundEnabled()){t.n=1;break}return t.a(2);case 1:if(!this._audioReady){t.n=2;break}return t.a(2);case 2:if(window.Tone){t.n=3;break}return t.a(2);case 3:return t.n=4,Tone.start();case 4:this._synth=new Tone.Synth({oscillator:{type:"sine"},envelope:{attack:.01,decay:.08,sustain:.6,release:.12}}).toDestination(),this._audioReady=!0;case 5:return t.a(2)}},t,this)})),function(){return d.apply(this,arguments)})},{key:"_stepToMidi",value:function(t){var e,n;switch(this.opts.clef){case"bass":e=36,n=4;break;case"alto":e=48,n=3;break;case"tenor":e=48,n=1;break;default:e=60,n=2}var i=n+t,a=Math.floor(i/7);return e+[0,2,4,5,7,9,11][(i%7+7)%7]+12*a}},{key:"_accidentalClassToOffset",value:function(t){return t?t.includes("music-font__doublesharp")?2:t.includes("music-font__sharp")?1:t.includes("music-font__doubleflat")?-2:t.includes("music-font__flat")?-1:0:0}},{key:"_emitNoteState",value:function(t,e){var n=this.$el.find('.note[data-note-id="'.concat(t,'"]'));if(n.length){var i=this.yToStep(parseFloat(n.css("top"))),a=this._getAttachedAccidentalClass(t),r=this._accidentalClassToOffset(a),o=this._stepToMidi(i)+r;this.$el.trigger("staff:noteState",{noteId:t,step:i,accidentalClass:a,midi:o,source:e||"unknown"})}}},{key:"_playStep",value:(l=y(v().m(function t(e,n){var i;return v().w(function(t){for(;;)switch(t.n){case 0:if(this._soundEnabled()&&Number.isFinite(e)){t.n=1;break}return t.a(2);case 1:return t.n=2,this._ensureAudio();case 2:if(this._synth){t.n=3;break}return t.a(2);case 3:i=this._stepToMidi(e)+(n||0),this._synth.triggerRelease&&this._synth.triggerRelease(),this._synth.triggerAttackRelease(Tone.Frequency(i,"midi"),.5);case 4:return t.a(2)}},t,this)})),function(t,e){return l.apply(this,arguments)})},{key:"setNoteFixed",value:function(t,e){var n=!!e;this.$el.find('.note[data-note-id="'.concat(t,'"]')).toggleClass("fixed",n),this.$el.find('.ledger[data-for-note-id="'.concat(t,'"]')).toggleClass("fixed",n),this.$el.find('.accidental[data-for-note-id="'.concat(t,'"]')).toggleClass("fixed",n)}},{key:"addFixedNote",value:function(t){var e=t||{},n=this.addNote({step:e.step,y:e.y,x:e.x,id:e.id,ledger:e.ledger,className:e.className||""});return n?(e.accidentalClass&&this.attachAccidentalToNote(n,e.accidentalClass),this.setNoteFixed(n,!0),n):null}},{key:"clearNotes",value:function(){this.$el.find(".note, .ledger, .accidental").remove(),this._previewClear()}},{key:"removeNote",value:function(t){this.$el.find('.note[data-note-id="'.concat(t,'"]')).remove(),this.$el.find('.ledger[data-for-note-id="'.concat(t,'"]')).remove(),this._removeAccidentalForNote(t),this._resolveNoteOverlaps()}},{key:"addNote",value:function(t){var e=t||{},n=Number.isFinite(e.step)?Number(e.step):null;if(Number.isFinite(n)&&!this._isStepAllowed(n))return null;if(Number.isFinite(n)&&!e.allowOccupied&&this._isStepOccupied(n,null))return null;var i=Number.isFinite(e.y)?Number(e.y):Number.isFinite(n)?this.stepToY(n):null;if(!Number.isFinite(i))throw new Error("addNote: provide either y or step");var a=Number.isFinite(e.x)?Number(e.x):this.centerX(),r=e.id||"".concat(this.opts.noteIdPrefix).concat(this._idCounter++),o=$('<div class="note"><span class="lettername"></span></div>').attr("data-note-id",r).css({left:"".concat(a,"px"),top:"".concat(i,"px")});return e.className&&o.addClass(e.className),this.$el.append(o),(!0===e.ledger||!1!==e.ledger&&Number.isFinite(n))&&this._renderLedgers(r,a,n),e.skipResolve?this._repositionAllAccidentals():this._resolveNoteOverlaps(),r}},{key:"moveNote",value:function(t,e){var n=e||{},i=this.$el.find('.note[data-note-id="'.concat(t,'"]'));if(i.length){var a=Number.isFinite(n.x)?Number(n.x):null,r=Number.isFinite(n.step)?Number(n.step):null;if(!Number.isFinite(r)||this._isStepAllowed(r)){var o=Number.isFinite(n.y)?Number(n.y):Number.isFinite(r)?this.stepToY(r):null;if(Number.isFinite(a)&&i.css("left","".concat(a,"px")),Number.isFinite(o)&&i.css("top","".concat(o,"px")),Number.isFinite(r)){var s=Number.isFinite(a)?a:parseFloat(i.css("left"));this._renderLedgers(t,s,r)}this._repositionAllAccidentals()}}}},{key:"_previewSet",value:function(t){this._preview||(this._preview=$('<div class="note preview"></div>').appendTo(this.$el)),this._preview.css({left:"".concat(this.centerX(),"px"),top:"".concat(this.stepToY(t),"px")}),this._previewStep=t,this._previewLedgersSet(t)}},{key:"_previewClear",value:function(){this._preview&&(this._preview.remove(),this._preview=null,this._previewStep=null),this._previewLedgersClear()}},{key:"_resolveNoteOverlaps",value:function(){var t=this,e=this.opts.noteOverlapGap;function n(){return t.$el.find(".note").toArray().map(function(e){var n=$(e);return{el:e,$el:n,step:t.yToStep(parseFloat(n.css("top")))}})}function i(t){for(var e={},n=0;n<t.length;n++){var i=t[n].step;(e[i]||(e[i]=[])).push(t[n])}return e}function a(e){for(var n=t.centerX(),i=0;i<e.length;i++){var a=e[i].$el.attr("data-note-id");t.moveNote(a,{x:n,step:e[i].step}),e[i]._shifted=!1}}function r(n,i){var a=n.el.getBoundingClientRect(),r=i[n.step-1];if(!r||!r.length)return!1;var o=r[0].el.getBoundingClientRect();if(!t._rectsOverlap(a,o))return!1;var s=o.right-a.left+e,l=n.$el.attr("data-note-id");return t.moveNote(l,{x:parseFloat(n.$el.css("left"))+s,step:n.step}),!0}for(var o=0;o<20;o++){var s=n();if(!s.length)return;a(s);for(var l=i(s),c=Object.keys(l).map(function(t){return parseInt(t,10)}).sort(function(t,e){return t-e}),u=!1,f=0;f<c.length;f++){var h=c[f];if(l[h]&&l[h+1]){var d=l[h][0],p=l[h+1][0];d._shifted||(r(p,l)&&(u=!0),p._shifted=!0)}}if(!u)return void t._repositionAllAccidentals()}t._repositionAllAccidentals()}},{key:"_setDraggingVisual",value:function(t,e){var n=this.$el.find('.note[data-note-id="'.concat(t,'"]')),i=this.$el.find('.ledger[data-for-note-id="'.concat(t,'"]')),a=this.$el.find('.accidental[data-for-note-id="'.concat(t,'"]'));n.toggleClass("dragging",!!e),i.toggleClass("dragging",!!e),a.toggleClass("dragging",!!e)}},{key:"_applyDraggedAdjacencyX",value:function(t){var e=this.$el.find('.note[data-note-id="'.concat(t,'"]'));if(e.length){var n=this.yToStep(parseFloat(e.css("top"))),i=this.centerX(),a=this.opts.noteOverlapGap;this.moveNote(t,{x:i});var r=this._getNoteIdAtStep(n-1,t);if(r&&this._isCenteredX(r)){var o=this.$el.find('.note[data-note-id="'.concat(r,'"]'));if(o.length){var s=e[0].getBoundingClientRect(),l=o[0].getBoundingClientRect();if(this._rectsOverlap(s,l)){var c=l.right-s.left+a;this.moveNote(t,{x:i+c})}}}}}},{key:"enableGhostClickCreate",value:function(){var t=this;this.$el.off(".previewCreate"),$(window).off("blur.previewCreate"),this.$el.on("pointerdown.previewCreate",function(e){if(!($(e.target).closest(".note, .accidental").length||t._userNoteCount()>=t._maxUserNotes())){e.preventDefault();var n=i(e).y,r=t.yToStep(t._pageYToLocalY(n));if(t._isStepAllowed(r)){t._previewState.active=!0,t._previewState.step=r,t._previewSet(r),t._soundEnabled()&&t._ensureAudio();var o=a(e);this.setPointerCapture&&null!=o&&this.setPointerCapture(o),t.$el.off("pointermove.previewCreate").on("pointermove.previewCreate",function(e){if(t._previewState.active){if(t._userNoteCount()>=t._maxUserNotes())return t._previewState.active=!1,t._previewClear(),void t.$el.off("pointermove.previewCreate pointerup.previewCreate pointercancel.previewCreate");var n=i(e).y,a=t.yToStep(t._pageYToLocalY(n));t._isStepAllowed(a)&&(t._previewState.step=a,t._previewSet(a))}}),t.$el.off("pointerup.previewCreate pointercancel.previewCreate").on("pointerup.previewCreate pointercancel.previewCreate",function(){if(t._previewState.active){t._previewState.active=!1;var e=t._previewState.step;if(t._previewClear(),t.$el.off("pointermove.previewCreate pointerup.previewCreate pointercancel.previewCreate"),t._isStepAllowed(e)&&!(t._isStepOccupied(e,null)||t._userNoteCount()>=t._maxUserNotes())){var n=t.addNote({step:e});n&&(t.$el.trigger("staff:userNoteAdded",{noteId:n,step:e}),t._emitNoteState(n,"user"),t._suppressNextClick.noteId=n,t._suppressNextClick.until=Date.now()+700,t._playStep(e,0))}}})}}}),$(window).on("blur.previewCreate",function(){t._previewState.active&&(t._previewState.active=!1,t._previewClear(),t.$el.off("pointermove.previewCreate pointerup.previewCreate pointercancel.previewCreate"))})}},{key:"enableNoteDragAndClickDelete",value:function(){var t=this,e=this._drag;function n(n,r){if(r.preventDefault(),!$(n).hasClass("fixed")){r.stopImmediatePropagation?r.stopImmediatePropagation():r.stopPropagation();var o=a(r),s=$(n);e.isDragging=!1,e.movedPx=0,e.startPageY=i(r).y,e.noteId=s.attr("data-note-id"),e.startStep=t.yToStep(parseFloat(s.css("top"))),e.lastTargetStep=e.startStep,e.lastSoundStep=e.startStep,e.dropOnOccupied=!1,e.outOfRange=!1,t._setDraggingVisual(e.noteId,!0),t._soundEnabled()&&t._ensureAudio();var l=r.currentTarget&&r.currentTarget.setPointerCapture?r.currentTarget:null;l&&null!=o&&l.setPointerCapture(o),t.$el.off("pointermove.noteDrag").on("pointermove.noteDrag",function(n){var r=a(n);if(null==o||null==r||r===o){var s=i(n).y,l=s-e.startPageY;if(e.movedPx=Math.max(e.movedPx,Math.abs(l)),!e.isDragging&&e.movedPx>=e.thresholdPx&&(e.isDragging=!0),e.isDragging){var c=t.yToStep(t._pageYToLocalY(s));if(t._isStepAllowed(c)){if(e.outOfRange=!1,e.lastTargetStep=c,t.moveNote(e.noteId,{step:c}),e.dropOnOccupied=t._isStepOccupied(c,e.noteId),t._applyDraggedAdjacencyX(e.noteId),t._soundEnabled()&&c!==e.lastSoundStep){e.lastSoundStep=c;var u=t._getAttachedAccidentalClass(e.noteId),f=t._accidentalClassToOffset(u);t._playStep(c,f)}}else e.outOfRange=!0}}}),t.$el.off("pointerup.noteDrag pointercancel.noteDrag").on("pointerup.noteDrag pointercancel.noteDrag",function(n){var i=a(n);null!=o&&null!=i&&i!==o||(t.$el.off("pointermove.noteDrag pointerup.noteDrag pointercancel.noteDrag"),e.swallowClick=e.isDragging,t._setDraggingVisual(e.noteId,!1),e.outOfRange||e.dropOnOccupied?t.removeNote(e.noteId):(t.moveNote(e.noteId,{step:e.lastTargetStep}),t._resolveNoteOverlaps(),t._emitNoteState(e.noteId,"user")),e.noteId=null,e.isDragging=!1,e.movedPx=0,e.startStep=null,e.lastTargetStep=null,e.lastSoundStep=null,e.dropOnOccupied=!1,e.outOfRange=!1)})}}this.$el.off(".noteDrag"),this.$el.on("pointerdown.noteDrag",".accidental",function(t){t.stopPropagation()}),this.$el.on("pointerdown.noteDrag",".note",function(t){n(this,t)}),this.$el.on("pointerdown.noteDrag",function(e){if(!$(e.target).closest(".accidental").length&&!$(e.target).closest(".note").length){var a=i(e).y,r=t.yToStep(t._pageYToLocalY(a)),o=t._getNoteIdAtStep(r,null);if(o){var s=t.$el.find('.note[data-note-id="'.concat(o,'"]'))[0];s&&n(s,e)}}}),this.$el.on("click.noteDrag",".accidental",function(e){e.preventDefault(),e.stopPropagation();var n=this.getAttribute("data-for-note-id");n&&(t.isNoteFixed(n)||(t._removeAccidentalForNote(n),t._repositionAllAccidentals(),t._emitNoteState(n,"user")))}),this.$el.on("click.noteDrag",".note",function(n){var i=$(this).attr("data-note-id");return t._suppressNextClick.noteId&&i===t._suppressNextClick.noteId&&Date.now()<t._suppressNextClick.until?(t._suppressNextClick.noteId=null,t._suppressNextClick.until=0,n.preventDefault(),void n.stopPropagation()):e.swallowClick?(n.preventDefault(),n.stopPropagation(),void(e.swallowClick=!1)):void t.removeNote(i)})}},{key:"enableAccidentalDrag",value:function(t){var e=this;function n(){e._accDragSound.noteId=null,e._accDragSound.step=null,e._accDragSound.toolType=null,e._accDragSound.prospectiveCls=null,e._accSnap.noteId=null,e._accSnap.dist=null,e._accSnap.localY=null}t.addClass("accidental-tool"),t.draggable({helper:"clone",appendTo:"body",zIndex:9999,revert:"invalid",scroll:!1,start:function(t,i){i.helper.addClass("dragging accidental-tool"),e._soundEnabled()&&e._ensureAudio(),n(),e._accDragSound.toolType=u($(this))},drag:function(t){var i=e._accDragSound.toolType;if(i){var a=t.pageX,r=t.pageY;!Number.isFinite(r)&&t.originalEvent&&(r=t.originalEvent.pageY),!Number.isFinite(a)&&t.originalEvent&&(a=t.originalEvent.pageX);var o=e.$el.offset(),s=a-o.left,l=r-o.top;if(e._accSnap.localY=l,s<0||l<0||s>e.$el.width()||l>e.$el.height())return n(),void(e._accDragSound.toolType=i);var c=e._nearestEditableNoteByLocalY(l);if(!c)return e._accSnap.noteId=null,e._accSnap.dist=null,e._accDragSound.noteId=null,e._accDragSound.step=null,void(e._accDragSound.prospectiveCls=null);var u=c.noteId;e._accSnap.noteId=u,e._accSnap.dist=c.dist;var d=e.$el.find('.note[data-note-id="'.concat(u,'"]'));if(d.length){var p=e.yToStep(parseFloat(d.css("top")));if(e._isStepAllowed(p)){var v=e._getAttachedAccidentalClass(u),_=f(v,i);if(h(v,i))return e._accDragSound.noteId=null,e._accDragSound.step=null,void(e._accDragSound.prospectiveCls=null);if((u!==e._accDragSound.noteId||p!==e._accDragSound.step||_!==e._accDragSound.prospectiveCls)&&(e._accDragSound.noteId=u,e._accDragSound.step=p,e._accDragSound.prospectiveCls=_,e._soundEnabled())){var m=e._accidentalClassToOffset(_);e._playStep(p,m)}}}}},stop:function(){n()}})}},{key:"enableAccidentalDropOnStaff",value:function(){var t=this;this.$el.droppable({accept:".accidental-tool",tolerance:"pointer",drop:function(e,n){var i=u(n.draggable);if(i){var a;if(t._accSnap&&null!=t._accSnap.localY)a=t._accSnap.localY;else{var r=e.pageY;!Number.isFinite(r)&&e.originalEvent&&(r=e.originalEvent.pageY),a=t._pageYToLocalY(r)}var o=t._nearestEditableNoteByLocalY(a);o&&t.applyAccidentalToolToNote(o.noteId,i)}}})}}],o&&g(r.prototype,o),s&&g(r,s),Object.defineProperty(r,"prototype",{writable:!1}),r;var r,o,s,l,d}();function w(t){return w="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},w(t)}function k(){var t,e,n="function"==typeof Symbol?Symbol:{},i=n.iterator||"@@iterator",a=n.toStringTag||"@@toStringTag";function r(n,i,a,r){var l=i&&i.prototype instanceof s?i:s,c=Object.create(l.prototype);return x(c,"_invoke",function(n,i,a){var r,s,l,c=0,u=a||[],f=!1,h={p:0,n:0,v:t,a:d,f:d.bind(t,4),d:function(e,n){return r=e,s=0,l=t,h.n=n,o}};function d(n,i){for(s=n,l=i,e=0;!f&&c&&!a&&e<u.length;e++){var a,r=u[e],d=h.p,p=r[2];n>3?(a=p===i)&&(l=r[(s=r[4])?5:(s=3,3)],r[4]=r[5]=t):r[0]<=d&&((a=n<2&&d<r[1])?(s=0,h.v=i,h.n=r[1]):d<p&&(a=n<3||r[0]>i||i>p)&&(r[4]=n,r[5]=i,h.n=p,s=0))}if(a||n>1)return o;throw f=!0,i}return function(a,u,p){if(c>1)throw TypeError("Generator is already running");for(f&&1===u&&d(u,p),s=u,l=p;(e=s<2?t:l)||!f;){r||(s?s<3?(s>1&&(h.n=-1),d(s,l)):h.n=l:h.v=l);try{if(c=2,r){if(s||(a="next"),e=r[a]){if(!(e=e.call(r,l)))throw TypeError("iterator result is not an object");if(!e.done)return e;l=e.value,s<2&&(s=0)}else 1===s&&(e=r.return)&&e.call(r),s<2&&(l=TypeError("The iterator does not provide a '"+a+"' method"),s=1);r=t}else if((e=(f=h.n<0)?l:n.call(i,h))!==o)break}catch(e){r=t,s=1,l=e}finally{c=1}}return{value:e,done:f}}}(n,a,r),!0),c}var o={};function s(){}function l(){}function c(){}e=Object.getPrototypeOf;var u=[][i]?e(e([][i]())):(x(e={},i,function(){return this}),e),f=c.prototype=s.prototype=Object.create(u);function h(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,c):(t.__proto__=c,x(t,a,"GeneratorFunction")),t.prototype=Object.create(f),t}return l.prototype=c,x(f,"constructor",c),x(c,"constructor",l),l.displayName="GeneratorFunction",x(c,a,"GeneratorFunction"),x(f),x(f,a,"Generator"),x(f,i,function(){return this}),x(f,"toString",function(){return"[object Generator]"}),(k=function(){return{w:r,m:h}})()}function x(t,e,n,i){var a=Object.defineProperty;try{a({},"",{})}catch(t){a=0}x=function(t,e,n,i){function r(e,n){x(t,e,function(t){return this._invoke(e,n,t)})}e?a?a(t,e,{value:n,enumerable:!i,configurable:!i,writable:!i}):t[e]=n:(r("next",0),r("throw",1),r("return",2))},x(t,e,n,i)}function A(t,e,n,i,a,r,o){try{var s=t[r](o),l=s.value}catch(t){return void n(t)}s.done?e(l):Promise.resolve(l).then(i,a)}function C(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,i)}return n}function N(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?C(Object(n),!0).forEach(function(e){T(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):C(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function T(t,e,n){return(e=F(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function O(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,F(i.key),i)}}function F(t){var e=function(t,e){if("object"!=w(t)||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var i=n.call(t,e||"default");if("object"!=w(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==w(e)?e:e+""}var P=Date.now(),E=function(){return t=function t(){var e,n,i=this,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t);var r={staffEl:"#staff",basePoints:1,firstTryBonus:2,sound:!0,showLetterNames:!1,clefUrls:null,initialClef:"treble",maxUserNotes:1/0,numOfChallenges:10,levelName:"",successPhrases:["Awesome","Nicely done","Well done","Great job","Hooray","Fantastic","Nice work","Looks good","Good one"],namespace:"staffGame",instructionsAfterUserNotes:1,checkAfterUserNotes:1};this.opts=N(N({},r),a||{}),this.ns=this.opts.namespace||"staffGame",this._uiSfxReady=!1,this._uiSfxSynth=null,this._uiSfxNoise=null,this.$staffEl=$(this.opts.staffEl),this.$accidentals=$("#accidentals"),this.$controls=$("#controls"),this.$feedback=$("#feedback-success"),this.$bonusBadge=this.$feedback.find(".bonus"),this.$points=$("#points"),this.$increment=$("#increment"),this.$checkBtn=$("#check button"),this.$finalOverlay=$("#final-overlay"),this.$doublePoints=$("#double-points"),this.$checkWrap=this.$checkBtn.parent(),this.$progressBar=$("#progress-bar"),this.$progressCounter=$("#progress-counter"),this.$helpBtn=$("#help"),this.successPhrases=this.opts.successPhrases,this.maxUserNotes=Number(this.opts.maxUserNotes),this.numOfChallenges=this.opts.numOfChallenges,this.levelName=this.opts.levelName,this.points=0,this._madeMistakeThisRound=!1,this._madeAnyMistake=!1,this._continueBound=!1,this._usedHintThisRound=!1,this._stats={checksTotal:0,checksCorrect:0,finishedAtMs:null},this.staff=new S(this.$staffEl,{clef:this.opts.initialClef||"treble",clefUrls:this.opts.clefUrls||window.__clefUrls,autoClef:!1,getMaxUserNotes:function(){return Number.isFinite(i.maxUserNotes)?i.maxUserNotes:1/0},sound:!!this.opts.sound}),this.showLetterNames=!!this.opts.showLetterNames,this.$staffEl.toggleClass("show-letternames",this.showLetterNames),this._fixedNote={letterWithAcc:"?",letterOnly:"?"},this._fixedState=null,this.$increment.hide(),this.$bonusBadge.hide(),null===(e=this.$doublePoints)||void 0===e||null===(n=e.hide)||void 0===n||n.call(e),this.$points.text(String(this.points))},e=[{key:"setSoundEnabled",value:function(t){if(this.opts.sound=!!t,this.staff.setSoundEnabled(!!t),!this.opts.sound&&window.Tone){try{this._uiSfxSynth&&this._uiSfxSynth.releaseAll&&this._uiSfxSynth.releaseAll()}catch(t){}try{this._uiSfxSynth&&this._uiSfxSynth.dispose&&this._uiSfxSynth.dispose()}catch(t){}try{this._uiSfxNoise&&this._uiSfxNoise.dispose&&this._uiSfxNoise.dispose()}catch(t){}this._uiSfxSynth=null,this._uiSfxNoise=null,this._uiSfxReady=!1;try{Tone.context&&Tone.context.suspend&&Tone.context.suspend()}catch(t){}}return this}},{key:"isSoundEnabled",value:function(){return this.staff.isSoundEnabled()}},{key:"_ensureUiSfxAudio",value:(i=k().m(function t(){return k().w(function(t){for(;;)switch(t.n){case 0:if(this.isSoundEnabled()){t.n=1;break}return t.a(2);case 1:if(!this._uiSfxReady){t.n=2;break}return t.a(2);case 2:if(window.Tone){t.n=3;break}return t.a(2);case 3:return t.n=4,Tone.start();case 4:this._uiSfxSynth=new Tone.PolySynth(Tone.Synth,{oscillator:{type:"triangle"},envelope:{attack:.005,decay:.12,sustain:0,release:.25}}).toDestination(),this._uiSfxNoise=new Tone.NoiseSynth({noise:{type:"pink"},envelope:{attack:.001,decay:.08,sustain:0,release:.06}}).toDestination(),this._uiSfxReady=!0;case 5:return t.a(2)}},t,this)}),a=function(){var t=this,e=arguments;return new Promise(function(n,a){var r=i.apply(t,e);function o(t){A(r,n,a,o,s,"next",t)}function s(t){A(r,n,a,o,s,"throw",t)}o(void 0)})},function(){return a.apply(this,arguments)})},{key:"_playSuccessSfxBasic",value:function(){var t=this;this.isSoundEnabled()&&window.Tone&&this._ensureUiSfxAudio().then(function(){if(t._uiSfxSynth){var e=Tone.now();["C6","E6","G6"].forEach(function(n,i){t._uiSfxSynth.triggerAttackRelease(n,.07,e+.05*i,.42)})}})}},{key:"_playSuccessSfxBonus",value:function(){var t=this;this.isSoundEnabled()&&window.Tone&&this._ensureUiSfxAudio().then(function(){var e;if(t._uiSfxSynth){var n=Tone.now(),i=N({},t._uiSfxSynth.get().envelope),a=null===(e=t._uiSfxSynth.get().oscillator)||void 0===e?void 0:e.type;try{t._uiSfxSynth.set({oscillator:{type:"sine"},envelope:{attack:.004,decay:.12,sustain:.15,release:.65}})}catch(t){}["C6","E6","G6","B6","C7"].forEach(function(e,i){t._uiSfxSynth.triggerAttackRelease(e,.06,n+.045*i,.45)}),["C6","G6","C7","E7"].forEach(function(e){t._uiSfxSynth.triggerAttackRelease(e,.12,n+.26,.3)}),setTimeout(function(){try{t._uiSfxSynth.set({oscillator:{type:a||"triangle"},envelope:i})}catch(t){}},600)}})}},{key:"_playFailSfx",value:function(){var t=this;this.isSoundEnabled()&&window.Tone&&this._ensureUiSfxAudio().then(function(){var e=Tone.now();t._uiSfxNoise&&t._uiSfxNoise.triggerAttackRelease(.06,e,.1),t._uiSfxSynth&&(t._uiSfxSynth.triggerAttackRelease("A2",.1,e+.01,.1),t._uiSfxSynth.triggerAttackRelease("G2",.12,e+.08,10.1))})}},{key:"_playFinalSfx",value:function(){var t=this;this.isSoundEnabled()&&window.Tone&&this._ensureUiSfxAudio().then(function(){var e;if(t._uiSfxSynth){var n=N({},t._uiSfxSynth.get().envelope),i=null===(e=t._uiSfxSynth.get().oscillator)||void 0===e?void 0:e.type;t._uiSfxSynth.set({oscillator:{type:"sine"},envelope:{attack:.02,decay:.25,sustain:.35,release:.9}});var a=Tone.now();["C4","G4","C5","E5"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.9,a,.6)}),["G5","A5","B5","C6","D6","E6","G6"].forEach(function(e,n){t._uiSfxSynth.triggerAttackRelease(e,.08,a+.25+.06*n,.35)}),setTimeout(function(){try{t._uiSfxSynth.set({oscillator:{type:i||"triangle"},envelope:n})}catch(t){}},1400)}})}},{key:"_playPerfectGameBonusSfx",value:function(){var t=this;this.isSoundEnabled()&&window.Tone&&this._ensureUiSfxAudio().then(function(){var e;if(t._uiSfxSynth){var n=N({},t._uiSfxSynth.get().envelope),i=null===(e=t._uiSfxSynth.get().oscillator)||void 0===e?void 0:e.type;try{t._uiSfxSynth.set({oscillator:{type:"triangle"},envelope:{attack:.01,decay:.18,sustain:.25,release:.8}})}catch(t){}var a=Tone.now();["C5","E5","G5","C6","E6","G6","C7"].forEach(function(e,n){t._uiSfxSynth.triggerAttackRelease(e,.09,a+.06*n,.62)}),["C6","G6","C7","E7"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.35,a+.48,.46)}),setTimeout(function(){try{t._uiSfxSynth.set({oscillator:{type:i||"triangle"},envelope:n})}catch(t){}},1400)}})}},{key:"start",value:function(){this._madeAnyMistake=!1,$("#instructions").show(),$("#controls").show(),this._instructionsRemoved=!1,this._wireAccidentalPalette(),this._wireStaffTools(),this._wireControls(),this._resetProgress(),this.newChallenge(),this._armUiGates({resetInstructions:!0}),$("#page-wrapper").fadeIn("fast")}},{key:"newChallenge",value:function(){throw new Error("newChallenge() not implemented")}},{key:"_onCheck",value:function(){throw new Error("_onCheck() not implemented")}},{key:"_wireAccidentalPalette",value:function(){$("#accidentals .music-font__doublesharp, #accidentals .music-font__doubleflat").addClass("d-none")}},{key:"_wireStaffTools",value:function(){var t=this;this.staff.enableNoteDragAndClickDelete(),this.staff.enableGhostClickCreate(),this.staff.enableAccidentalDrag($("#accidentals .music-font__sharp, #accidentals .music-font__flat, #accidentals .music-font__natural")),this.staff.enableAccidentalDropOnStaff(),this.$staffEl.off("staff:noteState._log.".concat(this.ns)).on("staff:noteState._log.".concat(this.ns),function(e,n){var i,a=d(t.staff,n.step,n.accidentalClass),r=a.replace(/\d+$/,"");t.showLetterNames&&t.$staffEl.find('.note[data-note-id="'.concat(n.noteId,'"] .lettername')).text(r),"fixed"===n.source&&(t._fixedNote={letterWithAcc:r,letterOnly:r.replace(/[#b]+$/,"")},t._fixedState={step:n.step,accidentalClass:n.accidentalClass||null,midi:n.midi},null===(i=t._onFixedNoteState)||void 0===i||i.call(t,n,a,r)),console.log("fixed"===n.source?"Fixed note:":"User note:",a,{midi:n.midi,noteId:n.noteId,step:n.step,clef:t.staff.getClef()})})}},{key:"_wireControls",value:function(){var t=this;$("#clear").off("click.".concat(this.ns)).on("click.".concat(this.ns),function(){return t.staff.clearNotes()}),this.$checkBtn.off("click.".concat(this.ns)).on("click.".concat(this.ns),function(){return t._onCheck()}),this.$helpBtn.off("click.".concat(this.ns,"Help")).on("click.".concat(this.ns,"Help"),function(){t._usedHintThisRound=!0,t._showHintNote()}),this._continueBound||(this._continueBound=!0,$("#continue button").off("click.".concat(this.ns)).on("click.".concat(this.ns),function(){$("#continue").hide(),t.newChallenge(),t._armUiGates({resetInstructions:!1}),t.$checkBtn.enable()}))}},{key:"_instructionsAfterUserNotes",value:function(){var t=Number(this.opts.instructionsAfterUserNotes);return Number.isFinite(t)&&t>=0?Math.floor(t):1}},{key:"_checkAfterUserNotes",value:function(){var t=Number(this.opts.checkAfterUserNotes);return Number.isFinite(t)&&t>=0?Math.floor(t):1}},{key:"_armUiGates",value:function(){var t=this,e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).resetInstructions,n=this._instructionsAfterUserNotes(),i=this._checkAfterUserNotes();e&&(this._instructionsRemoved=!1),$("#check").show().addClass("invisible"),this._userNotesSinceGate=0,this.$staffEl.off("staff:userNoteAdded._uiGate.".concat(this.ns)).on("staff:userNoteAdded._uiGate.".concat(this.ns),function(){t._userNotesSinceGate+=1,!t._instructionsRemoved&&t._userNotesSinceGate>=n&&($("#instructions").remove(),t._instructionsRemoved=!0),t._userNotesSinceGate>=i&&($("#check").removeClass("invisible"),t.$staffEl.off("staff:userNoteAdded._uiGate.".concat(t.ns)))})}},{key:"_initialNoteRangeIndex",value:function(){var t=null!=this.opts.initialNoteRange?this.opts.initialNoteRange:null!=this.opts.range?this.opts.range:void 0;if(null==t)throw new Error("[BaseStaffGame] Missing required option: initialNoteRange (0=narrow, 1=wide, 2=full).");var e=Number(t);if(!Number.isFinite(e))throw new Error("[BaseStaffGame] initialNoteRange must be a number (0, 1, or 2). Got: ".concat(String(t)));var n=Math.trunc(e);return 0===n||1===n||2===n?n:(console.warn("[BaseStaffGame] initialNoteRange out of range; defaulting to 2 (full).",{value:t}),2)}},{key:"_clefMainLineStep",value:function(t){switch(String(t||"").trim().toLowerCase()){case"bass":case"tenor":return 6;case"alto":return 4;default:return 2}}},{key:"_initialFixedStepBounds",value:function(){var t=this.staff.minStepAllowed(),e=this.staff.maxStepAllowed(),n=this._initialNoteRangeIndex();if(2===n)return{min:t,max:e};var i=this._clefMainLineStep(this.staff.getClef()),a=2*(0===n?1:2);return{min:Math.max(t,i-a),max:Math.min(e,i+a)}}},{key:"_isStepInInitialFixedRange",value:function(t){if(!Number.isFinite(t))return!1;var e=this._initialFixedStepBounds(),n=e.min,i=e.max;return t>=n&&t<=i}},{key:"_randomInitialFixedStep",value:function(){var t=this._initialFixedStepBounds(),e=t.min,n=t.max;return Math.floor(Math.random()*(n-e+1))+e}},{key:"_computeHintAnswer",value:function(){return null}},{key:"_computeHintAnswers",value:function(){var t=this._computeHintAnswer();return t?[t]:[]}},{key:"_removeAllHintNotes",value:function(){var t=this;(Array.isArray(this._activeHintIds)?this._activeHintIds:[]).forEach(function(e){return t.staff.removeNote(e)}),this._activeHintIds=[]}},{key:"_randomFreeStep",value:function(){for(var t=this.staff.minStepAllowed(),e=this.staff.maxStepAllowed(),n=0;n<50;n++){var i=Math.floor(Math.random()*(e-t+1))+t;if(!this.staff._isStepOccupied(i,null))return i}return null}},{key:"_attachHintBlinkRemoval",value:function(t){var e=this,n=this.$staffEl.find('.note[data-note-id="'.concat(t,'"]'));n.length&&n.off("animationend.hint.".concat(t," webkitAnimationEnd.hint.").concat(t)).one("animationend.hint.".concat(t," webkitAnimationEnd.hint.").concat(t),function(){e.staff.removeNote(t),e._activeHintIds=(e._activeHintIds||[]).filter(function(e){return e!==t})})}},{key:"_showHintNote",value:function(){this._removeAllHintNotes();var t=this._computeHintAnswers(),e=Array.isArray(t)&&t.length?t:[{step:null,accidentalClass:null}];this._activeHintIds=[];for(var n=0;n<e.length;n++){var i=e[n]||{},a=i.id||(1===e.length?"hint":"hint".concat(n+1)),r=Number.isFinite(i.step)?Number(i.step):null,o=i.accidentalClass||null;null==r&&(r=this._randomFreeStep()),null!=r&&this.staff.addNote({id:a,step:r,className:"hint blink",allowOccupied:!0,skipResolve:!0})&&(this._activeHintIds.push(a),o&&(this.staff.attachAccidentalToNote(a,o),this.$staffEl.find('.accidental[data-for-note-id="'.concat(a,'"]')).addClass("hint blink")),this.$staffEl.find('.ledger[data-for-note-id="'.concat(a,'"]')).addClass("hint blink"),this._attachHintBlinkRemoval(a))}}},{key:"_successAnimation",value:function(){(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).isBonus?this._playSuccessSfxBonus():this._playSuccessSfxBasic(),this.$helpBtn.hide(),this.$accidentals.addClass("invisible"),this.$feedback.find(".message span").text(o(this.successPhrases)),this.$feedback.stop(!0,!0).fadeIn("fast")}},{key:"_showIncrement",value:function(t){var e=this.$increment;e&&e.length&&(e.stop(!0,!0),e.text("+".concat(t)).show(),e.animateCSS?e.animateCSS("fadeOutUp").then(function(){return e.hide()}):setTimeout(function(){return e.hide()},800))}},{key:"_showBonusBadge",value:function(t){this.$bonusBadge&&this.$bonusBadge.length&&(!t||t<=0?this.$bonusBadge.hide():(this.$bonusBadge.text("+".concat(t," BONUS")).show(),this.$bonusBadge.animateCSS&&this.$bonusBadge.animateCSS("tada")))}},{key:"_awardPointsForCorrect",value:function(){if(this._usedHintThisRound)return this._showBonusBadge(0),{earned:0,firstTry:!1,bonusEarned:0};var t=!this._madeMistakeThisRound,e=Number.isFinite(this.opts.basePoints)?this.opts.basePoints:1,n=Number.isFinite(this.opts.firstTryBonus)?this.opts.firstTryBonus:0,i=t?e+n:e,a=t?n:0;return this.points+=i,this.$points.text(String(this.points)),this._showBonusBadge(a),{earned:i,firstTry:t,bonusEarned:a}}},{key:"_resetProgress",value:function(){this._madeAnyMistake=!1,this.$progressBar.data("progress",0),this.$progressBar.css({width:"0%"}),this.$progressCounter.text("")}},{key:"_updateProgressBar",value:function(){var t=Math.max(1,this.numOfChallenges||1),e=100/t,n=parseFloat(this.$progressBar.data("progress"))||0;n=Math.min(100,n+e),this.$progressBar.data("progress",n),this.$progressBar.css({width:"".concat(n,"%")});var i=Math.min(t,Math.max(0,Math.round(n/e)));return this.$progressCounter.text("".concat(i," of ").concat(t)),n}},{key:"_failAnimation",value:function(t){var e=this;this._playFailSfx();var n=t||this.$checkWrap;n.removeClass("animate__animated animate__shakeX"),n[0]&&n[0].offsetWidth,n.addClass("animate__animated animate__shakeX"),n.off("animationend._fail.".concat(this.ns," webkitAnimationEnd._fail.").concat(this.ns," oAnimationEnd._fail.").concat(this.ns," MSAnimationEnd._fail.").concat(this.ns)).one("animationend._fail.".concat(this.ns," webkitAnimationEnd._fail.").concat(this.ns," oAnimationEnd._fail.").concat(this.ns," MSAnimationEnd._fail.").concat(this.ns),function(){n.removeClass("animate__animated animate__shakeX"),e.$checkBtn.enable()})}},{key:"_showFinalResults",value:function(){var t,e,n,i,a=this,r=Math.max(0,null!==(t=this._stats.checksTotal)&&void 0!==t?t:0),o=Math.max(0,null!==(e=this._stats.checksCorrect)&&void 0!==e?e:0),s=r?Math.round(o/r*100):0,l=null!==(n=this._stats.finishedAtMs)&&void 0!==n?n:Date.now(),c=Math.max(0,Math.floor((l-P)/1e3)),u=r>0&&!this._madeAnyMistake,f=u?2*this.points:this.points;u?(setTimeout(function(){var t,e;null===(t=a.$doublePoints)||void 0===t||null===(e=t.show)||void 0===e||e.call(t),a._playPerfectGameBonusSfx()},1750),console.log("[BaseStaffGame] Perfect game! 2x bonus applied.",{basePoints:this.points,finalPoints:f})):console.log("[BaseStaffGame] No perfect-game bonus.",{basePoints:this.points,finalPoints:f,madeAnyMistake:this._madeAnyMistake});var h=null===(i=window)||void 0===i||null===(i=i.CountUp)||void 0===i?void 0:i.CountUp,d=function(t,e){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},i=a.$finalOverlay.find(t)[0];if(i)if(h){var r=new h(i,e,N({duration:3.5},n));r.error||r.start()}else i.textContent=String(n.formattingFn?n.formattingFn(e):e)+(n.suffix||"")};d('span[name="rounds"]',this.numOfChallenges),d('span[name="score"]',f),d('span[name="accuracy"]',s,{suffix:"%"}),d('span[name="duration"]',c,{formattingFn:function(t){var e=Math.max(0,Math.floor(t)),n=String(Math.floor(e/60)).padStart(2,"0"),i=String(e%60).padStart(2,"0");return"".concat(n,":").concat(i)}}),this._playFinalSfx(),this.$finalOverlay.show()}}],e&&O(t.prototype,e),n&&O(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t;var t,e,n,i,a}();function M(t){return M="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},M(t)}function j(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=I(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var i=0,a=function(){};return{s:a,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,o=!0,s=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return o=t.done,t},e:function(t){s=!0,r=t},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw r}}}}function R(t){return function(t){if(Array.isArray(t))return B(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||I(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function I(t,e){if(t){if("string"==typeof t)return B(t,e);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?B(t,e):void 0}}function B(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=Array(e);n<e;n++)i[n]=t[n];return i}function D(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,i)}return n}function U(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?D(Object(n),!0).forEach(function(e){X(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):D(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function L(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,W(i.key),i)}}function G(t,e,n){return e=H(e),function(t,e){if(e&&("object"==M(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(t,Y()?Reflect.construct(e,n||[],H(t).constructor):e.apply(t,n))}function Y(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(t){}return(Y=function(){return!!t})()}function H(t){return H=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},H(t)}function Q(t,e){return Q=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},Q(t,e)}function X(t,e,n){return(e=W(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function W(t){var e=function(t,e){if("object"!=M(t)||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var i=n.call(t,e||"default");if("object"!=M(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==M(e)?e:e+""}var q=function(t){function e(){var t,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e);var i={staffEl:"#staff",basePoints:1,firstTryBonus:2,namespace:"chordsChallenge",instructionsAfterUserNotes:2,checkAfterUserNotes:2,allowInversions:!1,initialRoot:!0},a=U(U(U({},i),n),{},{accidentalWeights:U(U({},i.accidentalWeights||{}),n.accidentalWeights||{}),triadQualities:Array.isArray(n.triadQualities)&&n.triadQualities.length?n.triadQualities.slice():Object.keys(e.TRIAD_QUALITY_FULL_NAME_MAP)}),r=e._normalizeClefPoolStatic(null!=a.clefs?a.clefs:a.clef);return(t=G(this,e,[U(U({},a),{},{initialClef:r&&r[0]?r[0]:"treble"})]))._clefPool=r,t.$interval=$("#interval"),t.$intervalLabel=t.$interval.find("label"),t.$intervalFull=t.$interval.find("div"),t._currentTriadQuality=null,t._currentSeventhType=null,t._requiredUserNotesThisRound=2,t._triadRootState=null,t._triadBassState=null,t._triadRootLetterWithAcc=null,t}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&Q(t,e)}(e,t),n=e,i=[{key:"_setTriadUI",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this._currentTriadQuality=String(t||"").trim(),this._currentSeventhType=e?String(e).trim():null,this.$interval.removeClass("text-red").addClass("text-blue"),this._refreshTriadUILabels()}},{key:"_escapeHtml",value:function(t){return String(t).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")}},{key:"_formatShortLabelHtml",value:function(t){return this._escapeHtml(t).replaceAll("","<sup></sup>").replace(/(^[A-G](?:bb|b|##|#)?)o(?=\d|$)/,"$1<sup>o</sup>")}},{key:"_triadShortName",value:function(t,n){var i,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=String(t||"").trim(),o=String(n||"").trim();if("diminished"===o&&a)return"".concat(r,"dim7"===a?"":"");var s=null!==(i=e.TRIAD_QUALITY_SHORT_SUFFIX_MAP[o])&&void 0!==i?i:"",l="".concat(r).concat(s);return a?"".concat(l,"maj7"===a?"maj7":"7"):l}},{key:"_triadFullName",value:function(t,n){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=String(t||"").trim(),r=String(n||"").trim(),o=e.TRIAD_QUALITY_FULL_NAME_MAP[r]||r;if("diminished"===r&&i)return"".concat(a," ").concat("dim7"===i?"fully diminished":"half diminished").trim();if(!i)return"".concat(a," ").concat(o).trim();var s="maj7"===i?"M7":"m7";return"".concat(a," ").concat(o," with a ").concat(s).trim()}},{key:"_refreshTriadUILabels",value:function(){var t,n,i=this._currentTriadQuality,a=this._triadRootLetterWithAcc||(this._fixedNote&&this._fixedNote.letterWithAcc&&"?"!==this._fixedNote.letterWithAcc?this._fixedNote.letterWithAcc:null),r=a?this._triadShortName(a,i,this._currentSeventhType):i,o=a?this._triadFullName(a,i,this._currentSeventhType):e.TRIAD_QUALITY_FULL_NAME_MAP[i]||i;null!==(t=this.$intervalLabel)&&void 0!==t&&t.length&&this.$intervalLabel.html(this._formatShortLabelHtml(r)),null!==(n=this.$intervalFull)&&void 0!==n&&n.length&&this.$intervalFull.text(o)}},{key:"_onFixedNoteState",value:function(){this._refreshTriadUILabels()}},{key:"_currentClefForChallenge",value:function(){var t=this._clefPool||["treble","bass"];return 1===t.length?t[0]:t[Math.floor(Math.random()*t.length)]}},{key:"_resetTriadContext",value:function(){this._triadRootState=null,this._triadBassState=null,this._triadRootLetterWithAcc=null}},{key:"_triadExpectedSemisForQuality",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=String(t||"").trim();if(!e)return{major:[4,7],minor:[3,7],augmented:[4,8],diminished:[3,6]}[n]||null;if("augmented"===n)return"7"!==e?null:[4,8,10];if("maj7"===e&&"major"!==n)return null;if("dim7"===e&&"diminished"!==n)return null;var i="maj7"===e?11:"dim7"===e?9:10,a={major:[4,7],minor:[3,7],diminished:[3,6]}[n];return a?[a[0],a[1],i]:null}},{key:"_toneAccidentalClass",value:function(t,e,n){for(var i=t+n-this.staff._stepToMidi(e);i>6;)i-=12;for(;i<-6;)i+=12;var a=this._accidentalClassFromOffset(i);return null==a&&0!==i?null:a}},{key:"_stepAboveBass",value:function(t,e){for(var n=t;n<=e;)n+=7;return n}},{key:"_pickRootAndBassForTriad",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,n=this._triadExpectedSemisForQuality(t,e);if(!n)return null;var i=this.staff.minStepAllowed(),a=this.staff.maxStepAllowed(),c=void 0===this.opts.initialRoot||!!this.opts.initialRoot,u=!!this.opts.allowInversions||!c,f=l(this.opts.fixedNotes).filter(Boolean);if(u&&f.length){var h=this._pickFixedNote();if(!h)return null;var d,p=this.staff._accidentalClassToOffset(h.accidentalClass),v=this.staff._stepToMidi(h.step)+p,_=[{rootStep:h.step,roleSemis:0},{rootStep:h.step-2,roleSemis:n[0]},{rootStep:h.step-4,roleSemis:n[1]}].concat(R(3===n.length?[{rootStep:h.step-6,roleSemis:n[2]}]:[])).filter(function(t){return t.rootStep>=i&&t.rootStep<=a}),m=[],y=j(_);try{for(y.s();!(d=y.n()).done;){var g=d.value,b=v-g.roleSemis,S=b-this.staff._stepToMidi(g.rootStep),w=this._accidentalClassFromOffset(S);if(null!=w||0===S){var k=g.rootStep+2,x=g.rootStep+4,A=3===n.length?g.rootStep+6:null;if(!(k<i||k>a||x<i||x>a||null!=A&&(A<i||A>a))){var C=this._toneAccidentalClass(b,k,n[0]),N=this._toneAccidentalClass(b,x,n[1]),T=null!=A?this._toneAccidentalClass(b,A,n[2]):null;null!=C&&null!=N&&(null!=A&&null==T||m.push({root:{step:g.rootStep,accidentalClass:w},bass:{step:h.step,accidentalClass:h.accidentalClass||null}}))}}}}catch(t){y.e(t)}finally{y.f()}if(m.length)return o(m)}var $=3===n.length?6:4,O=i,F=Math.max(i,a-$);if(F<O)return null;var P=this._initialFixedStepBounds(),E=null,M=0;if(u){for(var I=3===n.length?[0,1,2,3]:[0,1,2],B=0;B<80;B+=1){var D=r(O,F),U=o(I),L=D+2,G=D+4,Y=3===n.length?D+6:null,H=0===U?D:1===U?L:2===U?G:Y;if(this._isStepInInitialFixedRange(H)){E=D,M=U;break}}null==E&&(E=r(O,F),M=o(I))}else{var Q=Math.max(O,P.min),X=Math.min(F,P.max);if(X<Q)return null;E=r(Q,X)}var W=this.opts.accidentalWeights||{},q=s([{value:null,weight:Number(W.natural)||0},{value:"music-font__sharp",weight:Number(W.sharp)||0},{value:"music-font__flat",weight:Number(W.flat)||0}]),V=this.staff._stepToMidi(E)+this.staff._accidentalClassToOffset(q),z=E+2,J=E+4,K=3===n.length?E+6:null,Z=this._toneAccidentalClass(V,z,n[0]),tt=this._toneAccidentalClass(V,J,n[1]),et=null!=K?this._toneAccidentalClass(V,K,n[2]):null;if(null==Z||null==tt)return null;if(null!=K&&null==et)return null;var nt=0===M?E:1===M?z:2===M?J:K,it=0===M?0:1===M?n[0]:2===M?n[1]:n[2],at=this._toneAccidentalClass(V,nt,it);return null==at&&0!==it?null:{root:{step:E,accidentalClass:q},bass:{step:nt,accidentalClass:at}}}},{key:"newChallenge",value:function(){var t,e;this.$helpBtn.hide(),this._fixedState=null,this._resetTriadContext();var n=this._currentClefForChallenge();n&&n!==this.staff.getClef()&&this.staff.setClef(n),this._madeMistakeThisRound=!1,this._usedHintThisRound=!1,this.$bonusBadge.hide(),null===(t=this.$doublePoints)||void 0===t||null===(e=t.hide)||void 0===e||e.call(t);for(var i=null,a=null,r=null,o=0;o<40;o+=1){var s=this._pickChordSpec();if(i=s.quality,a=s.seventhType,(r=this._pickRootAndBassForTriad(i,a))&&("diminished"!==i||"dim7"!==a||"music-font__flat"!==r.root.accidentalClass&&"music-font__doubleflat"!==r.root.accidentalClass||(a="7",r=this._pickRootAndBassForTriad(i,a))))break}if(r||(i="major",a=null,r=this._pickRootAndBassForTriad(i,a))){this._requiredUserNotesThisRound=this._requiredUserNotesForChord(a),this.opts.instructionsAfterUserNotes=this._requiredUserNotesThisRound,this.opts.checkAfterUserNotes=this._requiredUserNotesThisRound,this.opts.maxUserNotes=this._requiredUserNotesThisRound,this.staff.clearNotes(),this.$accidentals.removeClass("invisible"),this.$feedback.hide(),this.$interval.show(),this._setTriadUI(i,a);var l=this.staff._stepToMidi(r.root.step)+this.staff._accidentalClassToOffset(r.root.accidentalClass);this._triadRootState={step:r.root.step,accidentalClass:r.root.accidentalClass||null,midi:l},this._triadBassState={step:r.bass.step,accidentalClass:r.bass.accidentalClass||null,midi:this.staff._stepToMidi(r.bass.step)+this.staff._accidentalClassToOffset(r.bass.accidentalClass)};var c=d(this.staff,r.root.step,r.root.accidentalClass);this._triadRootLetterWithAcc=String(c||"").replace(/\d+$/,"")||null;var u="music-font__natural"===r.bass.accidentalClass?null:r.bass.accidentalClass||null,f=this.staff.addFixedNote({step:r.bass.step,accidentalClass:u});f&&this.staff._emitNoteState(f,"fixed"),$("#continue").hide()}}},{key:"_pickChordSpec",value:function(){if(!this.opts.only7thChords)return{quality:this._pickTriadQuality(),seventhType:null};var t=Array.isArray(this.opts.triadQualities)&&this.opts.triadQualities.length?this.opts.triadQualities:Object.keys(e.TRIAD_QUALITY_FULL_NAME_MAP),n=t.length?t:["major","minor","diminished","augmented"],i=n[Math.floor(Math.random()*n.length)];return"major"===i?{quality:i,seventhType:o(["7","maj7"])}:"minor"===i?{quality:i,seventhType:"7"}:"diminished"===i?{quality:i,seventhType:o(["7","dim7"])}:"augmented"===i?{quality:i,seventhType:"7"}:{quality:i,seventhType:null}}},{key:"_requiredUserNotesForChord",value:function(t){return t?3:2}},{key:"_pickTriadQuality",value:function(){var t=Array.isArray(this.opts.triadQualities)&&this.opts.triadQualities.length?this.opts.triadQualities:["major"];return t[Math.floor(Math.random()*t.length)]}},{key:"_pickFixedNote",value:function(){var t=l(this.opts.fixedNotes).filter(Boolean);if(t.length){var e=o(t);return this._fixedNoteToStaffPosition(e)}var n=this.opts.accidentalWeights||{},i=s([{value:null,weight:Number(n.natural)||0},{value:"music-font__sharp",weight:Number(n.sharp)||0},{value:"music-font__flat",weight:Number(n.flat)||0}]);return{step:this._randomInitialFixedStep(),accidentalClass:i}}},{key:"_notesOnStaffOrdered",value:function(){var t=this,e=this.$staffEl.find(".note").not(".preview").not(".hint").toArray().map(function(e){var n=e.getAttribute("data-note-id"),i=t.staff._stepOfNoteEl(e),a=t.staff._getAttachedAccidentalClass(n);return{id:n,step:i,accOff:t.staff._accidentalClassToOffset(a),fixed:e.classList.contains("fixed")}});return e.sort(function(t,e){return t.step-e.step}),e}},{key:"_onCheck",value:function(){var t=this,e=this._notesOnStaffOrdered();this.$checkBtn.disable(),this._stats.checksTotal+=1;var n=this._triadExpectedSemisForQuality(this._currentTriadQuality,this._currentSeventhType),i=this._triadRootState,a=this._requiredUserNotesThisRound+1;if(e.length!==a)return this._madeAnyMistake=!0,this._madeMistakeThisRound=!0,this.$interval.removeClass("text-blue").addClass("text-red"),this._failAnimation(this.$checkWrap),this.$checkBtn[0]&&this.$checkBtn[0].blur&&this.$checkBtn[0].blur(),void this.$helpBtn.show();if(!n||!i)return this._madeAnyMistake=!0,this._madeMistakeThisRound=!0,void this.$helpBtn.show();var r,o=i.step,s=i.midi,l=3===n.length?{0:0,2:n[0],4:n[1],6:n[2]}:{0:0,2:n[0],4:n[1]},c=new Set,u=!0,f=j(e);try{for(f.s();!(r=f.n()).done;){var h=r.value,d=((h.step-o)%7+7)%7;if(!(3===n.length?0===d||2===d||4===d||6===d:0===d||2===d||4===d)){u=!1;break}if(c.has(d)){u=!1;break}c.add(d);var p=(this.staff._stepToMidi(h.step)+(h.accOff||0)-s)%12;if(p<0&&(p+=12),p!==l[d]){u=!1;break}}}catch(t){f.e(t)}finally{f.f()}if(u){this._stats.checksCorrect+=1;var v=this._awardPointsForCorrect(),_=v.earned,m=v.bonusEarned;this._successAnimation({isBonus:m>0}),this.$interval.hide(),$("#score").animateCSS&&$("#score").animateCSS("heartBeat"),_>0&&this._showIncrement(_),this._updateProgressBar()>=100?(this._stats.finishedAtMs=Date.now(),setTimeout(function(){return t._showFinalResults()},1600)):($("#check").hide(),$("#continue").show())}else this._madeAnyMistake=!0,this._madeMistakeThisRound=!0,this.$interval.removeClass("text-blue").addClass("text-red"),this._failAnimation(this.$checkWrap),this.$checkWrap.off("animationend._failRestore.".concat(this.ns," webkitAnimationEnd._failRestore.").concat(this.ns)).one("animationend._failRestore.".concat(this.ns," webkitAnimationEnd._failRestore.").concat(this.ns),function(){t.$interval.removeClass("text-red").addClass("text-blue")}),this.$helpBtn.show()}},{key:"_accidentalClassFromOffset",value:function(t){return 2===t?"music-font__doublesharp":1===t?"music-font__sharp":0===t?"music-font__natural":-1===t?"music-font__flat":-2===t?"music-font__doubleflat":null}},{key:"_computeHintAnswers",value:function(){var t=this,e=this._notesOnStaffOrdered();if(e.length<1)return[];var n=this._triadExpectedSemisForQuality(this._currentTriadQuality,this._currentSeventhType),i=this._triadRootState,a=this._triadBassState;if(!n||!i||!a)return[];var r,o=i.step,s=i.midi,l=a.step,c=new Set,u=j(e);try{for(u.s();!(r=u.n()).done;){var f=r.value,h=((f.step-o)%7+7)%7;if(3===n.length?0===h||2===h||4===h||6===h:0===h||2===h||4===h){var d=(this.staff._stepToMidi(f.step)+(f.accOff||0)-s)%12;d<0&&(d+=12),d===(0===h?0:2===h?n[0]:4===h?n[1]:n[2])&&c.add(h)}}}catch(t){u.e(t)}finally{u.f()}var p,v=this.staff.minStepAllowed(),_=this.staff.maxStepAllowed(),m=function(e,n,i){if(n<v||n>_)return null;var a=t._toneAccidentalClass(s,n,i);return null==a&&0!==i?null:{id:e,step:n,accidentalClass:a}},y=[],g=j([{role:0,id:"hintR",baseStep:o,semis:0},{role:2,id:"hint3",baseStep:o+2,semis:n[0]},{role:4,id:"hint5",baseStep:o+4,semis:n[1]}].concat(R(3===n.length?[{role:6,id:"hint7",baseStep:o+6,semis:n[2]}]:[])));try{for(g.s();!(p=g.n()).done;){var b=p.value;if(!c.has(b.role)){var S=this._stepAboveBass(b.baseStep,l);S>_&&(S=b.baseStep);var w=m(b.id,S,b.semis);w&&y.push(w)}}}catch(t){g.e(t)}finally{g.f()}return y.slice(0,this._requiredUserNotesThisRound)}},{key:"_fixedNoteToStaffPosition",value:function(t){var e=this._parsePitch(t);if(!e)return null;for(var n=e.midi,i=e.accOffset,a=e.accidentalClass,r=this.staff.minStepAllowed();r<=this.staff.maxStepAllowed();r++)if(this.staff._stepToMidi(r)+i===n)return{step:r,accidentalClass:a};for(var o=null,s=this.staff.minStepAllowed();s<=this.staff.maxStepAllowed();s++){var l=this.staff._stepToMidi(s),c=Math.abs(l+i-n);(!o||c<o.dist)&&(o={step:s,dist:c})}return o?{step:o.step,accidentalClass:a}:null}},{key:"_parsePitch",value:function(t){var e=String(t||"").trim().match(/^([A-Ga-g])((?:#{1,2})|(?:b{1,2})|)?(\d+)$/);if(!e)return null;var n=e[1].toUpperCase(),i=e[2]||"",a="##"===i?2:"#"===i?1:"bb"===i?-2:"b"===i?-1:0;return{midi:12*(parseInt(e[3],10)+1)+{C:0,D:2,E:4,F:5,G:7,A:9,B:11}[n]+a,accOffset:a,accidentalClass:2===a?"music-font__doublesharp":1===a?"music-font__sharp":-1===a?"music-font__flat":-2===a?"music-font__doubleflat":"music-font__natural"}}}],a=[{key:"_normalizeClefPoolStatic",value:function(t){for(var e=(Array.isArray(t)?t:null!=t?[t]:["treble","bass"]).map(function(t){return c(t)}).filter(Boolean),n=[],i=0;i<e.length;i++)n.includes(e[i])||n.push(e[i]);return n.length?n:["treble","bass"]}}],i&&L(n.prototype,i),a&&L(n,a),Object.defineProperty(n,"prototype",{writable:!1}),n;var n,i,a}(E);function V(t){return V="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},V(t)}function z(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),n.push.apply(n,i)}return n}function J(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?z(Object(n),!0).forEach(function(e){K(t,e,n[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):z(Object(n)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})}return t}function K(t,e,n){return(e=function(t){var e=function(t,e){if("object"!=V(t)||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var i=n.call(t,e||"default");if("object"!=V(i))return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==V(e)?e:e+""}(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}X(q,"TRIAD_QUALITY_FULL_NAME_MAP",{major:"major",minor:"minor",augmented:"augmented",diminished:"diminished"}),X(q,"TRIAD_QUALITY_SHORT_SUFFIX_MAP",{major:"",minor:"m",augmented:"aug",diminished:""});var Z=readGlobal("__challengeOptions")||{},tt=readGlobal("__clefUrls")||null;new q(J(J({},Z),{},{clefUrls:tt})).start()})();