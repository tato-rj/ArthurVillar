/*! For license information please see chords.js.LICENSE.txt */
(()=>{"use strict";var t=["music-font__sharp","music-font__doublesharp","music-font__flat","music-font__doubleflat","music-font__natural"],e={treble:{"--clef-width":"140px","--clef-height":"calc(var(--staff-line-gap) * 6)","--clef-top":"54px","--clef-left-nudge":"28px"},bass:{"--clef-width":"76px","--clef-height":"calc(var(--staff-line-gap) * 6)","--clef-top":"35px","--clef-left-nudge":"-12px"},alto:{"--clef-width":"88px","--clef-height":"calc(var(--staff-line-gap) * 6)","--clef-top":"47.5px","--clef-left-nudge":"-10px"},tenor:{"--clef-width":"88px","--clef-height":"calc(var(--staff-line-gap) * 6)","--clef-top":"22.5px","--clef-left-nudge":"-10px"}};function i(t,e,i){var n=t.getPropertyValue(e),a=parseFloat(n);return Number.isFinite(a)?a:i}function n(t){var e=t.originalEvent||t;return e.touches&&e.touches.length?{x:e.touches[0].pageX,y:e.touches[0].pageY}:e.changedTouches&&e.changedTouches.length?{x:e.changedTouches[0].pageX,y:e.changedTouches[0].pageY}:{x:e.pageX,y:e.pageY}}function a(t){var e=t.originalEvent||t;return e&&null!=e.pointerId?e.pointerId:null}function r(t,e){return Math.floor(Math.random()*(e-t+1))+t}function s(t){return Array.isArray(t)&&t.length?t[Math.floor(Math.random()*t.length)]:null}function o(t){var e=Array.isArray(t)?t.filter(function(t){return t&&Number.isFinite(t.weight)&&t.weight>0}):[];if(!e.length)return null;for(var i=e.reduce(function(t,e){return t+e.weight},0),n=Math.random()*i,a=0;a<e.length;a++)if((n-=e[a].weight)<=0)return e[a].value;return e[e.length-1].value}function l(t){return null==t?[]:Array.isArray(t)?t:[t]}function c(t){if(null==t)return null;var e=String(t||"treble").toLowerCase();return"bass"===e?"bass":"alto"===e?"alto":"tenor"===e?"tenor":"treble"}function u(t){return t.hasClass("music-font__sharp")?"sharp":t.hasClass("music-font__flat")?"flat":t.hasClass("music-font__natural")?"natural":null}function f(t,e){return"sharp"===e?"music-font__doublesharp"===t||"music-font__sharp"===t?"music-font__doublesharp":"music-font__sharp":"flat"===e?"music-font__doubleflat"===t||"music-font__flat"===t?"music-font__doubleflat":"music-font__flat":"natural"===e?"music-font__natural":t||null}function h(t,e){return"sharp"===e&&"music-font__doublesharp"===t||"flat"===e&&"music-font__doubleflat"===t}function d(t,e,i){var n,a=function(t,e){var i,n;switch(t.getClef()){case"bass":i=36,n=4;break;case"alto":i=48,n=3;break;case"tenor":i=48,n=1;break;default:i=60,n=2}var a=n+e,r=Math.floor(a/7),s=(a%7+7)%7,o=Math.floor(i/12)-1;return{letter:["C","D","E","F","G","A","B"][s],octave:o+r}}(t,e),r=a.letter,s=a.octave,o=(n=i)?n.includes("music-font__doublesharp")?"##":n.includes("music-font__sharp")?"#":n.includes("music-font__doubleflat")?"bb":n.includes("music-font__flat")?"b":"":"";return"".concat(r).concat(o).concat(s)}function p(t){return p="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},p(t)}function v(){var t,e,i="function"==typeof Symbol?Symbol:{},n=i.iterator||"@@iterator",a=i.toStringTag||"@@toStringTag";function r(i,n,a,r){var l=n&&n.prototype instanceof o?n:o,c=Object.create(l.prototype);return _(c,"_invoke",function(i,n,a){var r,o,l,c=0,u=a||[],f=!1,h={p:0,n:0,v:t,a:d,f:d.bind(t,4),d:function(e,i){return r=e,o=0,l=t,h.n=i,s}};function d(i,n){for(o=i,l=n,e=0;!f&&c&&!a&&e<u.length;e++){var a,r=u[e],d=h.p,p=r[2];i>3?(a=p===n)&&(l=r[(o=r[4])?5:(o=3,3)],r[4]=r[5]=t):r[0]<=d&&((a=i<2&&d<r[1])?(o=0,h.v=n,h.n=r[1]):d<p&&(a=i<3||r[0]>n||n>p)&&(r[4]=i,r[5]=n,h.n=p,o=0))}if(a||i>1)return s;throw f=!0,n}return function(a,u,p){if(c>1)throw TypeError("Generator is already running");for(f&&1===u&&d(u,p),o=u,l=p;(e=o<2?t:l)||!f;){r||(o?o<3?(o>1&&(h.n=-1),d(o,l)):h.n=l:h.v=l);try{if(c=2,r){if(o||(a="next"),e=r[a]){if(!(e=e.call(r,l)))throw TypeError("iterator result is not an object");if(!e.done)return e;l=e.value,o<2&&(o=0)}else 1===o&&(e=r.return)&&e.call(r),o<2&&(l=TypeError("The iterator does not provide a '"+a+"' method"),o=1);r=t}else if((e=(f=h.n<0)?l:i.call(n,h))!==s)break}catch(e){r=t,o=1,l=e}finally{c=1}}return{value:e,done:f}}}(i,a,r),!0),c}var s={};function o(){}function l(){}function c(){}e=Object.getPrototypeOf;var u=[][n]?e(e([][n]())):(_(e={},n,function(){return this}),e),f=c.prototype=o.prototype=Object.create(u);function h(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,c):(t.__proto__=c,_(t,a,"GeneratorFunction")),t.prototype=Object.create(f),t}return l.prototype=c,_(f,"constructor",c),_(c,"constructor",l),l.displayName="GeneratorFunction",_(c,a,"GeneratorFunction"),_(f),_(f,a,"Generator"),_(f,n,function(){return this}),_(f,"toString",function(){return"[object Generator]"}),(v=function(){return{w:r,m:h}})()}function _(t,e,i,n){var a=Object.defineProperty;try{a({},"",{})}catch(t){a=0}_=function(t,e,i,n){function r(e,i){_(t,e,function(t){return this._invoke(e,i,t)})}e?a?a(t,e,{value:i,enumerable:!n,configurable:!n,writable:!n}):t[e]=i:(r("next",0),r("throw",1),r("return",2))},_(t,e,i,n)}function m(t,e,i,n,a,r,s){try{var o=t[r](s),l=o.value}catch(t){return void i(t)}o.done?e(l):Promise.resolve(l).then(n,a)}function g(t){return function(){var e=this,i=arguments;return new Promise(function(n,a){var r=t.apply(e,i);function s(t){m(r,n,a,s,o,"next",t)}function o(t){m(r,n,a,s,o,"throw",t)}s(void 0)})}}function y(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,S(n.key),n)}}function S(t){var e=function(t,e){if("object"!=p(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=p(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==p(e)?e:e+""}var b=function(){return r=function t(e,n){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.$el=e;var a=getComputedStyle(e[0]);this.opts=$.extend({paddingX:i(a,"--staff-padding-x",20),lineGap:i(a,"--staff-line-gap",16),lineThickness:i(a,"--staff-line-thickness",3),noteOverlapGap:i(a,"--note-overlap-gap",-6),noteIdPrefix:"n",clefUrls:null,clef:null,clefUrl:null,autoClef:!0,maxLedgerAbove:2,maxLedgerBelow:2,accidentalTopPx:20,accidentalGapPx:16,getMaxUserNotes:function(){return 1/0},sound:!0,accSnapMaxPx:1.2*i(a,"--staff-line-gap",25)},n||{}),this.opts.clef=null==this.opts.clef?null:c(this.opts.clef),this.opts.clef&&!this.opts.clefUrl&&(this.opts.clefUrl=this._clefUrlFor(this.opts.clef)),this.opts.stepSize=this.opts.lineGap/2,this.$el.css("position","relative"),this._idCounter=1,this._drag={isDragging:!1,movedPx:0,startPageY:0,noteId:null,thresholdPx:5,swallowClick:!1,startStep:null,lastTargetStep:null,lastSoundStep:null,dropOnOccupied:!1,outOfRange:!1},this._previewState={active:!1,step:null},this._preview=null,this._previewStep=null,this._audioReady=!1,this._synth=null,this._accDragSound={noteId:null,step:null,toolType:null,prospectiveCls:null},this._accSnap={noteId:null,dist:null,localY:null},this._suppressNextClick={noteId:null,until:0},this._applyClefCssVars(this.opts.clef),this._computeLayout(),this._drawLines(),this.opts.autoClef&&!this.opts.clef?this.setClef("treble"):this.opts.clef&&(this._applyClefCssVars(this.opts.clef),this.relayout())},s=[{key:"_clefUrlFor",value:function(t){var e=c(t);if(!e)return null;var i=this.opts.clefUrls||{};return i[e]||i.treble||null}},{key:"setSoundEnabled",value:function(t){if(this.opts.sound=!!t,!this.opts.sound&&window.Tone){try{Tone.Transport&&Tone.Transport.stop()}catch(t){}try{Tone.context&&Tone.context.suspend&&Tone.context.suspend()}catch(t){}try{this._synth&&this._synth.releaseAll&&this._synth.releaseAll()}catch(t){}}}},{key:"isSoundEnabled",value:function(){return!!this.opts.sound}},{key:"_soundEnabled",value:function(){return!!this.opts.sound}},{key:"_applyClefCssVars",value:function(t){var i=c(t),n=e[i]||e.treble,a=this.$el[0];Object.keys(n).forEach(function(t){return a.style.setProperty(t,n[t])})}},{key:"setClef",value:function(t){this.opts.clef=c(t),this.opts.clefUrl=this._clefUrlFor(this.opts.clef),this._applyClefCssVars(this.opts.clef),this.relayout()}},{key:"getClef",value:function(){return this.opts.clef||"treble"}},{key:"_maxUserNotes",value:function(){var t=this.opts.getMaxUserNotes?this.opts.getMaxUserNotes():1/0;return Number.isFinite(t)?t:1/0}},{key:"_userNoteCount",value:function(){return this.$el.find(".note").not(".fixed").not(".preview").not(".hint").length}},{key:"_computeLayout",value:function(){var t=this.$el.height(),e=4*this.opts.lineGap,i=Math.round((t-e)/2);this.opts.bottomLineY=i+e}},{key:"_drawLines",value:function(){this.$el.find(".staff-line, .staff-clef").remove();for(var t=0;t<5;t++){var e=this.opts.bottomLineY-(4-t)*this.opts.lineGap;$('<div class="staff-line"></div>').css({top:"".concat(e,"px")}).appendTo(this.$el)}this._drawClef()}},{key:"_drawClef",value:function(){if(this.opts.clefUrl){var t=c(this.opts.clef);$('<img alt="">').addClass("staff-clef").addClass("".concat(t,"-clef")).attr("src",this.opts.clefUrl).appendTo(this.$el)}}},{key:"relayout",value:function(){this._computeLayout(),this._drawLines(),this._resolveNoteOverlaps(),this._repositionAllAccidentals()}},{key:"centerX",value:function(){return this.$el.width()/2}},{key:"stepToY",value:function(t){return this.opts.bottomLineY-t*this.opts.stepSize}},{key:"yToStep",value:function(t){return Math.round((this.opts.bottomLineY-t)/this.opts.stepSize)}},{key:"_pageYToLocalY",value:function(t){return t-this.$el.offset().top}},{key:"minStepAllowed",value:function(){return 0-2*this.opts.maxLedgerBelow}},{key:"maxStepAllowed",value:function(){return 8+2*this.opts.maxLedgerAbove}},{key:"_isStepAllowed",value:function(t){return t>=this.minStepAllowed()&&t<=this.maxStepAllowed()}},{key:"_ledgerStepsFor",value:function(t){var e=[],i=8+2*this.opts.maxLedgerAbove,n=0-2*this.opts.maxLedgerBelow;if(t>8)for(var a=Math.min(t,i),r=10;r<=a;r+=2)e.push(r);else if(t<0)for(var s=Math.max(t,n),o=-2;o>=s;o-=2)e.push(o);return e}},{key:"_renderLedgers",value:function(t,e,i){this.$el.find('.ledger[data-for-note-id="'.concat(t,'"]')).remove();for(var n=this.$el.find('.note[data-note-id="'.concat(t,'"]')).hasClass("dragging"),a=this._ledgerStepsFor(i),r=0;r<a.length;r++){var s=$('<div class="ledger"></div>').attr("data-for-note-id",t).css({left:"".concat(e,"px"),top:"".concat(this.stepToY(a[r]),"px")});n&&s.addClass("dragging"),s.appendTo(this.$el)}}},{key:"_previewLedgersClear",value:function(){this.$el.find(".ledger.preview").remove()}},{key:"_previewLedgersSet",value:function(t){this._previewLedgersClear();for(var e=this.centerX(),i=this._ledgerStepsFor(t),n=0;n<i.length;n++)$('<div class="ledger preview"></div>').css({left:"".concat(e,"px"),top:"".concat(this.stepToY(i[n]),"px")}).appendTo(this.$el)}},{key:"_stepOfNoteEl",value:function(t){var e=t.style.top||window.getComputedStyle(t).top;return this.yToStep(parseFloat(e))}},{key:"_isStepOccupied",value:function(t,e){for(var i=this.$el.find(".note").toArray(),n=0;n<i.length;n++){var a=i[n];if(a){var r=a.getAttribute("data-note-id");if((!e||r!==e)&&this._stepOfNoteEl(a)===t)return!0}}return!1}},{key:"_getNoteIdAtStep",value:function(t,e){for(var i=this.$el.find(".note").toArray(),n=0;n<i.length;n++){var a=i[n];if(a){var r=a.getAttribute("data-note-id");if((!e||r!==e)&&this._stepOfNoteEl(a)===t)return r}}return null}},{key:"_isCenteredX",value:function(t){var e=this.$el.find('.note[data-note-id="'.concat(t,'"]'));return!e.length||Math.abs(parseFloat(e.css("left"))-this.centerX())<=.5}},{key:"isNoteFixed",value:function(t){var e=this.$el.find('.note[data-note-id="'.concat(t,'"]'));return!!e.length&&e.hasClass("fixed")}},{key:"_nearestEditableNoteByLocalY",value:function(t){for(var e=Number.isFinite(this.opts.accSnapMaxPx)?this.opts.accSnapMaxPx:1.2*this.opts.lineGap,i=null,n=this.$el.find(".note").not(".preview").toArray(),a=0;a<n.length;a++){var r=n[a],s=r.getAttribute("data-note-id");if(s&&!$(r).hasClass("fixed")){var o=parseFloat(r.style.top||window.getComputedStyle(r).top),l=Math.abs(o-t);(null==i||l<i.dist)&&(i={noteId:s,dist:l})}}return!i||i.dist>e?null:i}},{key:"_removeAccidentalForNote",value:function(t){this.$el.find('.accidental[data-for-note-id="'.concat(t,'"]')).remove()}},{key:"_accidentalAnchorXForNote",value:function(t){var e=this.centerX();return Number.isFinite(t)&&t>e+.5?e:t}},{key:"_positionAccidentalForNote",value:function(t){var e=this.$el.find('.note[data-note-id="'.concat(t,'"]')),i=this.$el.find('.accidental[data-for-note-id="'.concat(t,'"]'));if(e.length&&i.length){var n=parseFloat(e.css("left")),a=parseFloat(e.css("top")),r=this._accidentalAnchorXForNote(n);i.css({left:"".concat(r-this.opts.accidentalGapPx,"px"),top:"".concat(a-this.opts.accidentalTopPx,"px")})}}},{key:"_rectsOverlap",value:function(t,e){return!(t.right<=e.left||t.left>=e.right||t.bottom<=e.top||t.top>=e.bottom)}},{key:"_repositionAllAccidentals",value:function(){var t=this;this.$el.find(".accidental").each(function(e,i){var n=i.getAttribute("data-for-note-id");n&&t._positionAccidentalForNote(n)});for(var e=this.$el.find(".note").not(".preview").toArray(),i={},n=0;n<e.length;n++){var a=e[n],r=a.getAttribute("data-note-id");r&&(i[this._stepOfNoteEl(a)]=r)}for(var s=Object.keys(i).map(function(t){return parseInt(t,10)}).sort(function(t,e){return t-e}),o=0;o<s.length;o++){var l=s[o],c=l+1,u=i[l],f=i[c];if(u&&f){var h=this.$el.find('.accidental[data-for-note-id="'.concat(u,'"]')),d=this.$el.find('.accidental[data-for-note-id="'.concat(f,'"]'));if(h.length&&d.length){var p=h[0].getBoundingClientRect(),v=d[0].getBoundingClientRect();if(this._rectsOverlap(p,v)){var _=Math.max(0,v.right-p.left),m=parseFloat(d.css("left"));Number.isFinite(m)&&d.css("left","".concat(m-(_+-6),"px"))}}}}}},{key:"_getAttachedAccidentalClass",value:function(e){var i=this.$el.find('.accidental[data-for-note-id="'.concat(e,'"]'));if(!i.length)return null;for(var n=0;n<t.length;n++){var a=t[n];if(i.hasClass(a))return a}return null}},{key:"attachAccidentalToNote",value:function(t,e){if(t&&!this.isNoteFixed(t)){this._removeAccidentalForNote(t);var i=$('<div class="accidental music-font"></div>').addClass(e).attr("data-for-note-id",t);this.$el.append(i),this._repositionAllAccidentals()}}},{key:"_hintIgnoredAccidental",value:function(t){var e=this.$el.find('.note[data-note-id="'.concat(t,'"]'));e.length&&(e.removeClass("animate__animated animate__headShake"),e[0].offsetWidth,e.addClass("animate__animated animate__headShake"),e.off("animationend._hint webkitAnimationEnd._hint oAnimationEnd._hint MSAnimationEnd._hint").one("animationend._hint webkitAnimationEnd._hint oAnimationEnd._hint MSAnimationEnd._hint",function(){e.removeClass("animate__animated animate__headShake")}))}},{key:"applyAccidentalToolToNote",value:function(t,e){if(!t||this.isNoteFixed(t))return!1;var i=this._getAttachedAccidentalClass(t);if(h(i,e))return this._hintIgnoredAccidental(t),!1;var n=f(i,e);return("natural"!==e||"music-font__natural"!==i)&&n!==i&&(this.attachAccidentalToNote(t,n),this._emitNoteState(t,"user"),!0)}},{key:"_ensureAudio",value:(d=g(v().m(function t(){return v().w(function(t){for(;;)switch(t.n){case 0:if(this._soundEnabled()){t.n=1;break}return t.a(2);case 1:if(!this._audioReady){t.n=2;break}return t.a(2);case 2:if(window.Tone){t.n=3;break}return t.a(2);case 3:return t.n=4,Tone.start();case 4:this._synth=new Tone.Synth({oscillator:{type:"sine"},envelope:{attack:.01,decay:.08,sustain:.6,release:.12}}).toDestination(),this._audioReady=!0;case 5:return t.a(2)}},t,this)})),function(){return d.apply(this,arguments)})},{key:"_stepToMidi",value:function(t){var e,i;switch(this.opts.clef){case"bass":e=36,i=4;break;case"alto":e=48,i=3;break;case"tenor":e=48,i=1;break;default:e=60,i=2}var n=i+t,a=Math.floor(n/7);return e+[0,2,4,5,7,9,11][(n%7+7)%7]+12*a}},{key:"_accidentalClassToOffset",value:function(t){return t?t.includes("music-font__doublesharp")?2:t.includes("music-font__sharp")?1:t.includes("music-font__doubleflat")?-2:t.includes("music-font__flat")?-1:0:0}},{key:"_emitNoteState",value:function(t,e){var i=this.$el.find('.note[data-note-id="'.concat(t,'"]'));if(i.length){var n=this.yToStep(parseFloat(i.css("top"))),a=this._getAttachedAccidentalClass(t),r=this._accidentalClassToOffset(a),s=this._stepToMidi(n)+r;this.$el.trigger("staff:noteState",{noteId:t,step:n,accidentalClass:a,midi:s,source:e||"unknown"})}}},{key:"_playStep",value:(l=g(v().m(function t(e,i){var n;return v().w(function(t){for(;;)switch(t.n){case 0:if(this._soundEnabled()&&Number.isFinite(e)){t.n=1;break}return t.a(2);case 1:return t.n=2,this._ensureAudio();case 2:if(this._synth){t.n=3;break}return t.a(2);case 3:n=this._stepToMidi(e)+(i||0),this._synth.triggerRelease&&this._synth.triggerRelease(),this._synth.triggerAttackRelease(Tone.Frequency(n,"midi"),.5);case 4:return t.a(2)}},t,this)})),function(t,e){return l.apply(this,arguments)})},{key:"setNoteFixed",value:function(t,e){var i=!!e;this.$el.find('.note[data-note-id="'.concat(t,'"]')).toggleClass("fixed",i),this.$el.find('.ledger[data-for-note-id="'.concat(t,'"]')).toggleClass("fixed",i),this.$el.find('.accidental[data-for-note-id="'.concat(t,'"]')).toggleClass("fixed",i)}},{key:"addFixedNote",value:function(t){var e=t||{},i=this.addNote({step:e.step,y:e.y,x:e.x,id:e.id,ledger:e.ledger,className:e.className||""});return i?(e.accidentalClass&&this.attachAccidentalToNote(i,e.accidentalClass),this.setNoteFixed(i,!0),i):null}},{key:"clearNotes",value:function(){this.$el.find(".note, .ledger, .accidental").remove(),this._previewClear()}},{key:"removeNote",value:function(t){this.$el.find('.note[data-note-id="'.concat(t,'"]')).remove(),this.$el.find('.ledger[data-for-note-id="'.concat(t,'"]')).remove(),this._removeAccidentalForNote(t),this._resolveNoteOverlaps()}},{key:"addNote",value:function(t){var e=t||{},i=Number.isFinite(e.step)?Number(e.step):null;if(Number.isFinite(i)&&!this._isStepAllowed(i))return null;if(Number.isFinite(i)&&!e.allowOccupied&&this._isStepOccupied(i,null))return null;var n=Number.isFinite(e.y)?Number(e.y):Number.isFinite(i)?this.stepToY(i):null;if(!Number.isFinite(n))throw new Error("addNote: provide either y or step");var a=Number.isFinite(e.x)?Number(e.x):this.centerX(),r=e.id||"".concat(this.opts.noteIdPrefix).concat(this._idCounter++),s=$('<div class="note"><span class="lettername"></span></div>').attr("data-note-id",r).css({left:"".concat(a,"px"),top:"".concat(n,"px")});return e.className&&s.addClass(e.className),this.$el.append(s),(!0===e.ledger||!1!==e.ledger&&Number.isFinite(i))&&this._renderLedgers(r,a,i),e.skipResolve?this._repositionAllAccidentals():this._resolveNoteOverlaps(),r}},{key:"moveNote",value:function(t,e){var i=e||{},n=this.$el.find('.note[data-note-id="'.concat(t,'"]'));if(n.length){var a=Number.isFinite(i.x)?Number(i.x):null,r=Number.isFinite(i.step)?Number(i.step):null;if(!Number.isFinite(r)||this._isStepAllowed(r)){var s=Number.isFinite(i.y)?Number(i.y):Number.isFinite(r)?this.stepToY(r):null;if(Number.isFinite(a)&&n.css("left","".concat(a,"px")),Number.isFinite(s)&&n.css("top","".concat(s,"px")),Number.isFinite(r)){var o=Number.isFinite(a)?a:parseFloat(n.css("left"));this._renderLedgers(t,o,r)}this._repositionAllAccidentals()}}}},{key:"_previewSet",value:function(t){this._preview||(this._preview=$('<div class="note preview"></div>').appendTo(this.$el)),this._preview.css({left:"".concat(this.centerX(),"px"),top:"".concat(this.stepToY(t),"px")}),this._previewStep=t,this._previewLedgersSet(t)}},{key:"_previewClear",value:function(){this._preview&&(this._preview.remove(),this._preview=null,this._previewStep=null),this._previewLedgersClear()}},{key:"_resolveNoteOverlaps",value:function(){var t=this,e=this.opts.noteOverlapGap;function i(){return t.$el.find(".note").toArray().map(function(e){var i=$(e);return{el:e,$el:i,step:t.yToStep(parseFloat(i.css("top")))}})}function n(t){for(var e={},i=0;i<t.length;i++){var n=t[i].step;(e[n]||(e[n]=[])).push(t[i])}return e}function a(e){for(var i=t.centerX(),n=0;n<e.length;n++){var a=e[n].$el.attr("data-note-id");t.moveNote(a,{x:i,step:e[n].step}),e[n]._shifted=!1}}function r(i,n){var a=i.el.getBoundingClientRect(),r=n[i.step-1];if(!r||!r.length)return!1;var s=r[0].el.getBoundingClientRect();if(!t._rectsOverlap(a,s))return!1;var o=s.right-a.left+e,l=i.$el.attr("data-note-id");return t.moveNote(l,{x:parseFloat(i.$el.css("left"))+o,step:i.step}),!0}for(var s=0;s<20;s++){var o=i();if(!o.length)return;a(o);for(var l=n(o),c=Object.keys(l).map(function(t){return parseInt(t,10)}).sort(function(t,e){return t-e}),u=!1,f=0;f<c.length;f++){var h=c[f];if(l[h]&&l[h+1]){var d=l[h][0],p=l[h+1][0];d._shifted||(r(p,l)&&(u=!0),p._shifted=!0)}}if(!u)return void t._repositionAllAccidentals()}t._repositionAllAccidentals()}},{key:"_setDraggingVisual",value:function(t,e){var i=this.$el.find('.note[data-note-id="'.concat(t,'"]')),n=this.$el.find('.ledger[data-for-note-id="'.concat(t,'"]')),a=this.$el.find('.accidental[data-for-note-id="'.concat(t,'"]'));i.toggleClass("dragging",!!e),n.toggleClass("dragging",!!e),a.toggleClass("dragging",!!e)}},{key:"_applyDraggedAdjacencyX",value:function(t){var e=this.$el.find('.note[data-note-id="'.concat(t,'"]'));if(e.length){var i=this.yToStep(parseFloat(e.css("top"))),n=this.centerX(),a=this.opts.noteOverlapGap;this.moveNote(t,{x:n});var r=this._getNoteIdAtStep(i-1,t);if(r&&this._isCenteredX(r)){var s=this.$el.find('.note[data-note-id="'.concat(r,'"]'));if(s.length){var o=e[0].getBoundingClientRect(),l=s[0].getBoundingClientRect();if(this._rectsOverlap(o,l)){var c=l.right-o.left+a;this.moveNote(t,{x:n+c})}}}}}},{key:"enableGhostClickCreate",value:function(){var t=this;this.$el.off(".previewCreate"),$(window).off("blur.previewCreate"),this.$el.on("pointerdown.previewCreate",function(e){if(!($(e.target).closest(".note, .accidental").length||t._userNoteCount()>=t._maxUserNotes())){e.preventDefault();var i=n(e).y,r=t.yToStep(t._pageYToLocalY(i));if(t._isStepAllowed(r)){t._previewState.active=!0,t._previewState.step=r,t._previewSet(r),t._soundEnabled()&&t._ensureAudio();var s=a(e);this.setPointerCapture&&null!=s&&this.setPointerCapture(s),t.$el.off("pointermove.previewCreate").on("pointermove.previewCreate",function(e){if(t._previewState.active){if(t._userNoteCount()>=t._maxUserNotes())return t._previewState.active=!1,t._previewClear(),void t.$el.off("pointermove.previewCreate pointerup.previewCreate pointercancel.previewCreate");var i=n(e).y,a=t.yToStep(t._pageYToLocalY(i));t._isStepAllowed(a)&&(t._previewState.step=a,t._previewSet(a))}}),t.$el.off("pointerup.previewCreate pointercancel.previewCreate").on("pointerup.previewCreate pointercancel.previewCreate",function(){if(t._previewState.active){t._previewState.active=!1;var e=t._previewState.step;if(t._previewClear(),t.$el.off("pointermove.previewCreate pointerup.previewCreate pointercancel.previewCreate"),t._isStepAllowed(e)&&!(t._isStepOccupied(e,null)||t._userNoteCount()>=t._maxUserNotes())){var i=t.addNote({step:e});i&&(t.$el.trigger("staff:userNoteAdded",{noteId:i,step:e}),t._emitNoteState(i,"user"),t._suppressNextClick.noteId=i,t._suppressNextClick.until=Date.now()+700,t._playStep(e,0))}}})}}}),$(window).on("blur.previewCreate",function(){t._previewState.active&&(t._previewState.active=!1,t._previewClear(),t.$el.off("pointermove.previewCreate pointerup.previewCreate pointercancel.previewCreate"))})}},{key:"enableNoteDragAndClickDelete",value:function(){var t=this,e=this._drag;function i(i,r){if(r.preventDefault(),!$(i).hasClass("fixed")){r.stopImmediatePropagation?r.stopImmediatePropagation():r.stopPropagation();var s=a(r),o=$(i);e.isDragging=!1,e.movedPx=0,e.startPageY=n(r).y,e.noteId=o.attr("data-note-id"),e.startStep=t.yToStep(parseFloat(o.css("top"))),e.lastTargetStep=e.startStep,e.lastSoundStep=e.startStep,e.dropOnOccupied=!1,e.outOfRange=!1,t._setDraggingVisual(e.noteId,!0),t._soundEnabled()&&t._ensureAudio();var l=r.currentTarget&&r.currentTarget.setPointerCapture?r.currentTarget:null;l&&null!=s&&l.setPointerCapture(s),t.$el.off("pointermove.noteDrag").on("pointermove.noteDrag",function(i){var r=a(i);if(null==s||null==r||r===s){var o=n(i).y,l=o-e.startPageY;if(e.movedPx=Math.max(e.movedPx,Math.abs(l)),!e.isDragging&&e.movedPx>=e.thresholdPx&&(e.isDragging=!0),e.isDragging){var c=t.yToStep(t._pageYToLocalY(o));if(t._isStepAllowed(c)){if(e.outOfRange=!1,e.lastTargetStep=c,t.moveNote(e.noteId,{step:c}),e.dropOnOccupied=t._isStepOccupied(c,e.noteId),t._applyDraggedAdjacencyX(e.noteId),t._soundEnabled()&&c!==e.lastSoundStep){e.lastSoundStep=c;var u=t._getAttachedAccidentalClass(e.noteId),f=t._accidentalClassToOffset(u);t._playStep(c,f)}}else e.outOfRange=!0}}}),t.$el.off("pointerup.noteDrag pointercancel.noteDrag").on("pointerup.noteDrag pointercancel.noteDrag",function(i){var n=a(i);null!=s&&null!=n&&n!==s||(t.$el.off("pointermove.noteDrag pointerup.noteDrag pointercancel.noteDrag"),e.swallowClick=e.isDragging,t._setDraggingVisual(e.noteId,!1),e.outOfRange||e.dropOnOccupied?t.removeNote(e.noteId):(t.moveNote(e.noteId,{step:e.lastTargetStep}),t._resolveNoteOverlaps(),t._emitNoteState(e.noteId,"user")),e.noteId=null,e.isDragging=!1,e.movedPx=0,e.startStep=null,e.lastTargetStep=null,e.lastSoundStep=null,e.dropOnOccupied=!1,e.outOfRange=!1)})}}this.$el.off(".noteDrag"),this.$el.on("pointerdown.noteDrag",".accidental",function(t){t.stopPropagation()}),this.$el.on("pointerdown.noteDrag",".note",function(t){i(this,t)}),this.$el.on("pointerdown.noteDrag",function(e){if(!$(e.target).closest(".accidental").length&&!$(e.target).closest(".note").length){var a=n(e).y,r=t.yToStep(t._pageYToLocalY(a)),s=t._getNoteIdAtStep(r,null);if(s){var o=t.$el.find('.note[data-note-id="'.concat(s,'"]'))[0];o&&i(o,e)}}}),this.$el.on("click.noteDrag",".accidental",function(e){e.preventDefault(),e.stopPropagation();var i=this.getAttribute("data-for-note-id");i&&(t.isNoteFixed(i)||(t._removeAccidentalForNote(i),t._repositionAllAccidentals(),t._emitNoteState(i,"user")))}),this.$el.on("click.noteDrag",".note",function(i){var n=$(this).attr("data-note-id");return t._suppressNextClick.noteId&&n===t._suppressNextClick.noteId&&Date.now()<t._suppressNextClick.until?(t._suppressNextClick.noteId=null,t._suppressNextClick.until=0,i.preventDefault(),void i.stopPropagation()):e.swallowClick?(i.preventDefault(),i.stopPropagation(),void(e.swallowClick=!1)):void t.removeNote(n)})}},{key:"enableAccidentalDrag",value:function(t){var e=this;function i(){e._accDragSound.noteId=null,e._accDragSound.step=null,e._accDragSound.toolType=null,e._accDragSound.prospectiveCls=null,e._accSnap.noteId=null,e._accSnap.dist=null,e._accSnap.localY=null}t.addClass("accidental-tool"),t.draggable({helper:"clone",appendTo:"body",zIndex:9999,revert:"invalid",scroll:!1,start:function(t,n){n.helper.addClass("dragging accidental-tool"),e._soundEnabled()&&e._ensureAudio(),i(),e._accDragSound.toolType=u($(this))},drag:function(t){var n=e._accDragSound.toolType;if(n){var a=t.pageX,r=t.pageY;!Number.isFinite(r)&&t.originalEvent&&(r=t.originalEvent.pageY),!Number.isFinite(a)&&t.originalEvent&&(a=t.originalEvent.pageX);var s=e.$el.offset(),o=a-s.left,l=r-s.top;if(e._accSnap.localY=l,o<0||l<0||o>e.$el.width()||l>e.$el.height())return i(),void(e._accDragSound.toolType=n);var c=e._nearestEditableNoteByLocalY(l);if(!c)return e._accSnap.noteId=null,e._accSnap.dist=null,e._accDragSound.noteId=null,e._accDragSound.step=null,void(e._accDragSound.prospectiveCls=null);var u=c.noteId;e._accSnap.noteId=u,e._accSnap.dist=c.dist;var d=e.$el.find('.note[data-note-id="'.concat(u,'"]'));if(d.length){var p=e.yToStep(parseFloat(d.css("top")));if(e._isStepAllowed(p)){var v=e._getAttachedAccidentalClass(u),_=f(v,n);if(h(v,n))return e._accDragSound.noteId=null,e._accDragSound.step=null,void(e._accDragSound.prospectiveCls=null);if((u!==e._accDragSound.noteId||p!==e._accDragSound.step||_!==e._accDragSound.prospectiveCls)&&(e._accDragSound.noteId=u,e._accDragSound.step=p,e._accDragSound.prospectiveCls=_,e._soundEnabled())){var m=e._accidentalClassToOffset(_);e._playStep(p,m)}}}}},stop:function(){i()}})}},{key:"enableAccidentalDropOnStaff",value:function(){var t=this;this.$el.droppable({accept:".accidental-tool",tolerance:"pointer",drop:function(e,i){var n=u(i.draggable);if(n){var a;if(t._accSnap&&null!=t._accSnap.localY)a=t._accSnap.localY;else{var r=e.pageY;!Number.isFinite(r)&&e.originalEvent&&(r=e.originalEvent.pageY),a=t._pageYToLocalY(r)}var s=t._nearestEditableNoteByLocalY(a);s&&t.applyAccidentalToolToNote(s.noteId,n)}}})}}],s&&y(r.prototype,s),o&&y(r,o),Object.defineProperty(r,"prototype",{writable:!1}),r;var r,s,o,l,d}();function k(t){return k="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},k(t)}function w(){var t,e,i="function"==typeof Symbol?Symbol:{},n=i.iterator||"@@iterator",a=i.toStringTag||"@@toStringTag";function r(i,n,a,r){var l=n&&n.prototype instanceof o?n:o,c=Object.create(l.prototype);return A(c,"_invoke",function(i,n,a){var r,o,l,c=0,u=a||[],f=!1,h={p:0,n:0,v:t,a:d,f:d.bind(t,4),d:function(e,i){return r=e,o=0,l=t,h.n=i,s}};function d(i,n){for(o=i,l=n,e=0;!f&&c&&!a&&e<u.length;e++){var a,r=u[e],d=h.p,p=r[2];i>3?(a=p===n)&&(l=r[(o=r[4])?5:(o=3,3)],r[4]=r[5]=t):r[0]<=d&&((a=i<2&&d<r[1])?(o=0,h.v=n,h.n=r[1]):d<p&&(a=i<3||r[0]>n||n>p)&&(r[4]=i,r[5]=n,h.n=p,o=0))}if(a||i>1)return s;throw f=!0,n}return function(a,u,p){if(c>1)throw TypeError("Generator is already running");for(f&&1===u&&d(u,p),o=u,l=p;(e=o<2?t:l)||!f;){r||(o?o<3?(o>1&&(h.n=-1),d(o,l)):h.n=l:h.v=l);try{if(c=2,r){if(o||(a="next"),e=r[a]){if(!(e=e.call(r,l)))throw TypeError("iterator result is not an object");if(!e.done)return e;l=e.value,o<2&&(o=0)}else 1===o&&(e=r.return)&&e.call(r),o<2&&(l=TypeError("The iterator does not provide a '"+a+"' method"),o=1);r=t}else if((e=(f=h.n<0)?l:i.call(n,h))!==s)break}catch(e){r=t,o=1,l=e}finally{c=1}}return{value:e,done:f}}}(i,a,r),!0),c}var s={};function o(){}function l(){}function c(){}e=Object.getPrototypeOf;var u=[][n]?e(e([][n]())):(A(e={},n,function(){return this}),e),f=c.prototype=o.prototype=Object.create(u);function h(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,c):(t.__proto__=c,A(t,a,"GeneratorFunction")),t.prototype=Object.create(f),t}return l.prototype=c,A(f,"constructor",c),A(c,"constructor",l),l.displayName="GeneratorFunction",A(c,a,"GeneratorFunction"),A(f),A(f,a,"Generator"),A(f,n,function(){return this}),A(f,"toString",function(){return"[object Generator]"}),(w=function(){return{w:r,m:h}})()}function A(t,e,i,n){var a=Object.defineProperty;try{a({},"",{})}catch(t){a=0}A=function(t,e,i,n){function r(e,i){A(t,e,function(t){return this._invoke(e,i,t)})}e?a?a(t,e,{value:i,enumerable:!n,configurable:!n,writable:!n}):t[e]=i:(r("next",0),r("throw",1),r("return",2))},A(t,e,i,n)}function x(t,e,i,n,a,r,s){try{var o=t[r](s),l=o.value}catch(t){return void i(t)}o.done?e(l):Promise.resolve(l).then(n,a)}function C(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)}return i}function T(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?C(Object(i),!0).forEach(function(e){E(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):C(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function N(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,O(n.key),n)}}function E(t,e,i){return(e=O(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function O(t){var e=function(t,e){if("object"!=k(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=k(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==k(e)?e:e+""}var M=Date.now(),R=function(){function t(){var e,i,n=this,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t);var r={staffEl:"#staff",basePoints:1,firstTryBonus:2,sound:!0,showLetterNames:!1,clefUrls:null,initialClef:"treble",maxUserNotes:1/0,numOfChallenges:10,practiceMode:!1,timer:!1,levelName:"",successPhrases:["Awesome","Nicely done","Well done","Great job","Hooray","Fantastic","Nice work","Looks good","Good one","Splendid","Way to go","Nailed it","Brilliant","Excellent","Superb","Right on","You got it","Perfect","Spot on","Impressive","Top notch","That’s it"],namespace:"staffGame",instructionsAfterUserNotes:1,checkAfterUserNotes:1};this.opts=T(T({},r),a||{}),this.ns=this.opts.namespace||"staffGame",this.opts.numOfChallenges=this._normalizeNumOfChallenges(this.opts.numOfChallenges),this._uiSfxReady=!1,this._uiSfxSynth=null,this._uiSfxNoise=null,this._uiTimerSfxSynth=null,this.$staffEl=$(this.opts.staffEl),this.$accidentals=$("#accidentals"),this.$controls=$("#controls"),this.$feedback=$("#feedback-success"),this.$bonusBadge=this.$feedback.find(".bonus"),this.$points=$("#points"),this.$increment=$("#increment"),this.$checkBtn=$("#check button"),this.$skipWrap=$("#skip"),this.$skipBtn=this.$skipWrap.find("button"),this.$finalOverlay=$("#final-overlay"),this.$doublePoints=$("#double-points"),this.$checkWrap=this.$checkBtn.parent(),this.$progressBar=$("#progress-bar"),this.$progressCounter=$("#progress-counter"),this.$helpBtn=$("#help"),this.$timeupMessage=$("#timeup-message"),this.$timer=$("#timer"),this.$timerBox=this.$timer.children("div").first(),this.$timerText=this.$timer.find("span"),this.successPhrases=this.opts.successPhrases,this.maxUserNotes=Number(this.opts.maxUserNotes),this.numOfChallenges=this.opts.numOfChallenges,this.levelName=this.opts.levelName,this.points=0,this._madeMistakeThisRound=!1,this._madeAnyMistake=!1,this._continueBound=!1,this._usedHintThisRound=!1,this._correctStreak=0,this._stats={checksTotal:0,checksCorrect:0,finishedAtMs:null},this._timerTimeoutId=null,this._timerRemainingSec=0,this._audioUnlockArmed=!1,this._timerEndsAtMs=0,this.staff=new b(this.$staffEl,{clef:this.opts.initialClef||"treble",clefUrls:this.opts.clefUrls||window.__clefUrls,autoClef:!1,getMaxUserNotes:function(){return Number.isFinite(n.maxUserNotes)?n.maxUserNotes:1/0},sound:!!this.opts.sound}),this.showLetterNames=!!this.opts.showLetterNames,this.$staffEl.toggleClass("show-letternames",this.showLetterNames),this._fixedNote={letterWithAcc:"?",letterOnly:"?"},this._fixedState=null,this.$increment.hide(),this.$bonusBadge.hide(),null===(e=this.$doublePoints)||void 0===e||null===(i=e.hide)||void 0===i||i.call(e),this.$points.text(String(this.points))}return e=t,i=[{key:"_normalizeNumOfChallenges",value:function(e){var i,n,a=Number(e),r=Number(null!==(i=null===(n=this.opts)||void 0===n?void 0:n.numOfChallenges)&&void 0!==i?i:10),s=Number.isFinite(a)?Math.trunc(a):Number.isFinite(r)?Math.trunc(r):10,o=t.MIN_CHALLENGES,l=t.MAX_CHALLENGES;return s<o?o:s>l?l:s}},{key:"setSoundEnabled",value:function(t){if(this.opts.sound=!!t,this.staff.setSoundEnabled(!!t),!this.opts.sound&&window.Tone){try{this._uiSfxSynth&&this._uiSfxSynth.releaseAll&&this._uiSfxSynth.releaseAll()}catch(t){}try{this._uiSfxSynth&&this._uiSfxSynth.dispose&&this._uiSfxSynth.dispose()}catch(t){}try{this._uiSfxNoise&&this._uiSfxNoise.dispose&&this._uiSfxNoise.dispose()}catch(t){}try{this._uiTimerSfxSynth&&this._uiTimerSfxSynth.dispose&&this._uiTimerSfxSynth.dispose()}catch(t){}this._uiSfxSynth=null,this._uiSfxNoise=null,this._uiTimerSfxSynth=null,this._uiSfxReady=!1;try{Tone.context&&Tone.context.suspend&&Tone.context.suspend()}catch(t){}}return this}},{key:"isSoundEnabled",value:function(){return this.staff.isSoundEnabled()}},{key:"_ensureUiSfxAudio",value:(a=w().m(function t(){return w().w(function(t){for(;;)switch(t.p=t.n){case 0:if(this.isSoundEnabled()){t.n=1;break}return t.a(2);case 1:if(!this._uiSfxReady){t.n=2;break}return t.a(2);case 2:if(window.Tone){t.n=3;break}return t.a(2);case 3:return t.p=3,t.n=4,Tone.start();case 4:t.n=6;break;case 5:return t.p=5,t.v,t.a(2);case 6:this._uiSfxSynth=new Tone.PolySynth(Tone.Synth,{oscillator:{type:"triangle"},envelope:{attack:.005,decay:.12,sustain:0,release:.25}}).toDestination(),this._uiSfxNoise=new Tone.NoiseSynth({noise:{type:"pink"},envelope:{attack:.001,decay:.08,sustain:0,release:.06}}).toDestination(),this._uiTimerSfxSynth=new Tone.Synth({oscillator:{type:"square"},envelope:{attack:.001,decay:.03,sustain:0,release:.06}}).toDestination(),this._uiSfxReady=!0;case 7:return t.a(2)}},t,this,[[3,5]])}),r=function(){var t=this,e=arguments;return new Promise(function(i,n){var r=a.apply(t,e);function s(t){x(r,i,n,s,o,"next",t)}function o(t){x(r,i,n,s,o,"throw",t)}s(void 0)})},function(){return r.apply(this,arguments)})},{key:"_armUiSfxOnFirstGesture",value:function(){var t=this;if(!this._audioUnlockArmed&&this.isSoundEnabled()&&window.Tone){this._audioUnlockArmed=!0;var e=".uiSfxUnlock.".concat(this.ns);$(document).off(e).one("pointerdown".concat(e," keydown").concat(e," touchstart").concat(e),function(){t._ensureUiSfxAudio().finally(function(){$(document).off(e)})})}}},{key:"_playSuccessSfxBasic",value:function(){var t=this;this.isSoundEnabled()&&window.Tone&&this._ensureUiSfxAudio().then(function(){if(t._uiSfxSynth){var e=Tone.now(),i=[["C6","E6","G6"],["D6","F#6","A6"],["E6","G6","B6"],["G5","B5","D6","G6"],["A5","C6","E6","A6"],["C6","D6","G6"],["F5","A5","C6","F6"],["E6","A6","C7"],["B5","D6","G6"],["C6","G6","E7"]];i[Math.floor(Math.random()*i.length)].forEach(function(i,n){t._uiSfxSynth.triggerAttackRelease(i,.07,e+.05*n,.42)})}})}},{key:"_playSuccessSfxBonus",value:function(){var t=this;this.isSoundEnabled()&&window.Tone&&this._ensureUiSfxAudio().then(function(){var e;if(t._uiSfxSynth){var i=Tone.now(),n=T({},t._uiSfxSynth.get().envelope),a=null===(e=t._uiSfxSynth.get().oscillator)||void 0===e?void 0:e.type;try{t._uiSfxSynth.set({oscillator:{type:"sine"},envelope:{attack:.004,decay:.12,sustain:.15,release:.65}})}catch(t){}var r=Math.max(1,Math.min(24,Number(t._correctStreak)||1))-1,s=function(t){return Tone.Frequency(t,"midi").toNote()},o=[62,66,69,73,74].map(function(t){return s(t+r)}),l=[62,69,74,78].map(function(t){return s(t+r)});o.forEach(function(e,n){t._uiSfxSynth.triggerAttackRelease(e,.06,i+.045*n,.45)}),l.forEach(function(e){t._uiSfxSynth.triggerAttackRelease(e,.12,i+.26,.3)}),setTimeout(function(){try{t._uiSfxSynth.set({oscillator:{type:a||"triangle"},envelope:n})}catch(t){}},600)}})}},{key:"_playFailSfx",value:function(){var t=this;this.isSoundEnabled()&&window.Tone&&this._ensureUiSfxAudio().then(function(){var e=Tone.now();t._uiSfxNoise&&t._uiSfxNoise.triggerAttackRelease(.06,e,.1),t._uiSfxSynth&&(t._uiSfxSynth.triggerAttackRelease("A2",.1,e+.01,.1),t._uiSfxSynth.triggerAttackRelease("G2",.12,e+.08,10.1))})}},{key:"_playFinalSfx",value:function(){var t=this;this.isSoundEnabled()&&window.Tone&&this._ensureUiSfxAudio().then(function(){var e;if(t._uiSfxSynth){var i=T({},t._uiSfxSynth.get().envelope),n=null===(e=t._uiSfxSynth.get().oscillator)||void 0===e?void 0:e.type;t._uiSfxSynth.set({oscillator:{type:"sine"},envelope:{attack:.02,decay:.25,sustain:.35,release:.9}});var a=Tone.now(),r=[function(){["C4","G4","C5","E5"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.9,a,.6)}),["G5","A5","B5","C6","D6","E6","G6"].forEach(function(e,i){t._uiSfxSynth.triggerAttackRelease(e,.08,a+.25+.06*i,.35)})},function(){["C5","E5","G5","B5","D6","G6"].forEach(function(e,i){t._uiSfxSynth.triggerAttackRelease(e,.11,a+.08*i,.44)}),["C6","E6","G6"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.28,a+.62,.5)})},function(){["A3","E4","A4","C5"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.45,a,.45)}),["F4","A4","C5","F5"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.52,a+.35,.48)}),["C5","F5","A5"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.24,a+.78,.4)})},function(){["E5","G5","A5","B5","D6","E6","G6","A6"].forEach(function(e,i){t._uiSfxSynth.triggerAttackRelease(e,.075,a+.055*i,.34)}),["A5","A6","C7"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.2,a+.52,.42)})},function(){["D4","A4","D5","F#5"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.36,a,.45)}),["D5","F#5","A5","D6","F#6"].forEach(function(e,i){t._uiSfxSynth.triggerAttackRelease(e,.095,a+.2+.065*i,.4)})},function(){["G3","D4","G4","B4"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.4,a,.4)}),["C4","E4","G4","C5"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.44,a+.32,.46)}),["E5","G5","C6"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.22,a+.72,.4)})},function(){["C6","D6","E6","G6","A6","G6","E6","C7"].forEach(function(e,i){t._uiSfxSynth.triggerAttackRelease(e,.06,a+.048*i,.3)}),["G6","C7"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.2,a+.48,.38)})},function(){["F4","C5","A5"].forEach(function(e,i){t._uiSfxSynth.triggerAttackRelease(e,.16,a+.06*i,.45)}),["G4","D5","B5"].forEach(function(e,i){t._uiSfxSynth.triggerAttackRelease(e,.16,a+.28+.06*i,.48)}),["C5","E5","G5","C6"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.26,a+.54,.44)})},function(){["A6","G6","E6","D6","C6"].forEach(function(e,i){t._uiSfxSynth.triggerAttackRelease(e,.08,a+.06*i,.34)}),["E6","G6","C7"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.24,a+.4,.42)})},function(){["C4","E4","G4","C5"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.34,a,.48)}),["E5","G5","B5","D6","E6"].forEach(function(e,i){t._uiSfxSynth.triggerAttackRelease(e,.09,a+.18+.055*i,.38)}),["C6","E6","G6","C7"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.3,a+.58,.5)})}];(0,r[Math.floor(Math.random()*r.length)])(),setTimeout(function(){try{t._uiSfxSynth.set({oscillator:{type:n||"triangle"},envelope:i})}catch(t){}},1700)}})}},{key:"_playPerfectGameBonusSfx",value:function(){var t=this;this.isSoundEnabled()&&window.Tone&&this._ensureUiSfxAudio().then(function(){var e;if(t._uiSfxSynth){var i=T({},t._uiSfxSynth.get().envelope),n=null===(e=t._uiSfxSynth.get().oscillator)||void 0===e?void 0:e.type;try{t._uiSfxSynth.set({oscillator:{type:"triangle"},envelope:{attack:.01,decay:.18,sustain:.25,release:.8}})}catch(t){}var a=Tone.now();["C5","E5","G5","C6","E6","G6","C7"].forEach(function(e,i){t._uiSfxSynth.triggerAttackRelease(e,.09,a+.06*i,.62)}),["C6","G6","C7","E7"].forEach(function(e){return t._uiSfxSynth.triggerAttackRelease(e,.35,a+.48,.46)}),setTimeout(function(){try{t._uiSfxSynth.set({oscillator:{type:n||"triangle"},envelope:i})}catch(t){}},1400)}})}},{key:"_isTimerEnabled",value:function(){var t=this.opts.timer,e=String(t||"").trim().toLowerCase();return!0===t||"true"===e||"on"===e}},{key:"_formatTimerDisplay",value:function(t){var e=Math.max(0,Math.floor(Number(t)||0)),i=String(Math.floor(e/60)).padStart(2,"0"),n=String(e%60).padStart(2,"0");return"".concat(i,":").concat(n)}},{key:"_renderTimerDisplay",value:function(){var t;null!==(t=this.$timerText)&&void 0!==t&&t.length&&(this.$timerText.text(this._formatTimerDisplay(this._timerRemainingSec)),this._syncTimerWarningStyle())}},{key:"_syncTimerWarningStyle",value:function(){var t;if(null!==(t=this.$timerBox)&&void 0!==t&&t.length){var e=this._timerRemainingSec<=5;this.$timerBox.toggleClass("bg-red",e),this.$timerBox.toggleClass("bg-primary",!e)}}},{key:"_setTimedOutInteractivityDisabled",value:function(t){var e=!!t,i=$("#staff"),n=$("#staff-wrapper"),a=$("#accidentals");e?(i.attr("disabled","disabled"),n.attr("disabled","disabled"),a.attr("disabled","disabled"),i.attr("aria-disabled","true"),n.attr("aria-disabled","true"),a.attr("aria-disabled","true"),i.css("pointer-events","none"),n.css("pointer-events","none"),a.css("pointer-events","none")):(i.removeAttr("disabled"),n.removeAttr("disabled"),a.removeAttr("disabled"),i.removeAttr("aria-disabled"),n.removeAttr("aria-disabled"),a.removeAttr("aria-disabled"),i.css("pointer-events",""),n.css("pointer-events",""),a.css("pointer-events",""))}},{key:"_showSkipRoundButton",value:function(){var t;null!==(t=this.$skipWrap)&&void 0!==t&&t.length&&this.$skipWrap.show()}},{key:"_hideSkipRoundButton",value:function(){var t;null!==(t=this.$skipWrap)&&void 0!==t&&t.length&&this.$skipWrap.hide()}},{key:"_hideTimeUpMessage",value:function(){var t;null!==(t=this.$timeupMessage)&&void 0!==t&&t.length&&this.$timeupMessage.removeClass("animate__animated animate__flash").hide()}},{key:"_showTimeUpMessage",value:function(){var t;null!==(t=this.$timeupMessage)&&void 0!==t&&t.length&&(this.$timeupMessage.removeClass("animate__animated animate__flash").show(),this.$timeupMessage[0]&&this.$timeupMessage[0].offsetWidth,this.$timeupMessage.addClass("animate__animated animate__flash"))}},{key:"_wouldReachLastRoundAfterAdvance",value:function(){if(this._isPracticeMode())return!1;var t=100/Math.max(1,this.numOfChallenges||1);return(parseFloat(this.$progressBar.data("progress"))||0)+t>=100}},{key:"_finishRoundAsTimedOut",value:function(){var t=this;if(this._correctStreak=0,this._madeAnyMistake=!0,this._madeMistakeThisRound=!0,this._stats.checksTotal+=1,this._updateProgressBar()>=100&&!this._isPracticeMode())return this._stats.finishedAtMs=Date.now(),this.$checkBtn.text("Final results, let's see…"),void setTimeout(function(){return t._showFinalResults()},1600);this._setTimedOutInteractivityDisabled(!1),this._hideTimeUpMessage(),this._hideSkipRoundButton(),$("#interval").removeClass("text-red").addClass("text-blue"),this._resetRoundTimerIfEnabled(),this.newChallenge(),this._armUiGates({resetInstructions:!1}),this.$checkBtn.enable()}},{key:"_pulseTimerWarning",value:function(){var t;null!==(t=this.$timer)&&void 0!==t&&t.length&&(this.$timer.removeClass("animate__animated animate__pulse"),this.$timer[0]&&this.$timer[0].offsetWidth,this.$timer.addClass("animate__animated animate__pulse"))}},{key:"_playTimerWarningBeep",value:function(){if(this.isSoundEnabled()&&window.Tone&&this._uiSfxReady&&this._uiTimerSfxSynth){var t=Tone.now();this._uiTimerSfxSynth.triggerAttackRelease("C6",.06,t,.5)}}},{key:"_playTimerTimeUpSfx",value:function(){if(this.isSoundEnabled()&&window.Tone&&this._uiSfxReady&&this._uiTimerSfxSynth){var t=Tone.now();this._uiSfxNoise&&this._uiSfxNoise.triggerAttackRelease(.12,t,.2),this._uiTimerSfxSynth.triggerAttackRelease("G4",.11,t,.72),this._uiTimerSfxSynth.triggerAttackRelease("E4",.13,t+.1,.76),this._uiTimerSfxSynth.triggerAttackRelease("C4",.18,t+.22,.82)}}},{key:"_stopGameTimer",value:function(){var t,e;null!=this._timerTimeoutId&&(clearTimeout(this._timerTimeoutId),this._timerTimeoutId=null),this._timerEndsAtMs=0,this._timerRemainingSec=0,this._syncTimerWarningStyle(),null===(t=this.$timer)||void 0===t||null===(e=t.removeClass)||void 0===e||e.call(t,"animate__animated animate__pulse")}},{key:"_pauseGameTimer",value:function(){var t,e;null!=this._timerTimeoutId&&(clearTimeout(this._timerTimeoutId),this._timerTimeoutId=null),this._timerEndsAtMs=0,null===(t=this.$timer)||void 0===t||null===(e=t.removeClass)||void 0===e||e.call(t,"animate__animated animate__pulse")}},{key:"_runGameTimerTick",value:function(){var t=this;if(this._timerEndsAtMs){var e=this._timerRemainingSec,i=this._timerEndsAtMs-Date.now(),n=Math.max(0,Math.ceil(i/1e3));if(this._timerRemainingSec=n,this._renderTimerDisplay(),n>0&&n<=5&&n!==e?(this._pulseTimerWarning(),this._playTimerWarningBeep()):0===n&&0!==e&&($("#check").hide(),this.$helpBtn.hide(),this._setTimedOutInteractivityDisabled(!0),this._pulseTimerWarning(),this._playTimerTimeUpSfx(),this._showTimeUpMessage(),this.$checkBtn.disable(),this._wouldReachLastRoundAfterAdvance()?(this._hideSkipRoundButton(),this._finishRoundAsTimedOut()):this._showSkipRoundButton()),n<=0)this._stopGameTimer();else{var a=this._timerEndsAtMs-1e3*(n-1),r=Math.max(16,a-Date.now());this._timerTimeoutId=setTimeout(function(){return t._runGameTimerTick()},r)}}}},{key:"_startGameTimer",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:10;this._stopGameTimer();var e=Math.max(0,Math.floor(Number(t)||0));this._timerEndsAtMs=Date.now()+1e3*e,this._timerRemainingSec=e,this._renderTimerDisplay(),this._runGameTimerTick()}},{key:"_timerLimitSeconds",value:function(){var t=Number(null!=this.opts.timeLimit?this.opts.timeLimit:this.opts.timerLimit);return Number.isFinite(t)?Math.max(0,Math.floor(t)):10}},{key:"_resetRoundTimerIfEnabled",value:function(){this._isTimerEnabled()&&(this.$timer.show(),this._startGameTimer(this._timerLimitSeconds()))}},{key:"start",value:function(){this._madeAnyMistake=!1,$("#instructions").show(),$("#controls").show(),this._instructionsRemoved=!1,this._wireAccidentalPalette(),this._wireStaffTools(),this._wireControls(),this._resetProgress(),this._setTimedOutInteractivityDisabled(!1),this._hideTimeUpMessage(),this._hideSkipRoundButton(),this._isTimerEnabled()?(this.$timer.show(),this._armUiSfxOnFirstGesture(),this._resetRoundTimerIfEnabled()):(this._stopGameTimer(),this.$timer.hide()),this.newChallenge(),this._armUiGates({resetInstructions:!0}),$("#page-wrapper").fadeIn("fast")}},{key:"newChallenge",value:function(){throw new Error("newChallenge() not implemented")}},{key:"_onCheck",value:function(){throw new Error("_onCheck() not implemented")}},{key:"_wireAccidentalPalette",value:function(){$("#accidentals .music-font__doublesharp, #accidentals .music-font__doubleflat").addClass("d-none")}},{key:"_wireStaffTools",value:function(){var t=this;this.staff.enableNoteDragAndClickDelete(),this.staff.enableGhostClickCreate(),this.staff.enableAccidentalDrag($("#accidentals .music-font__sharp, #accidentals .music-font__flat, #accidentals .music-font__natural")),this.staff.enableAccidentalDropOnStaff(),this.$staffEl.off("staff:noteState._log.".concat(this.ns)).on("staff:noteState._log.".concat(this.ns),function(e,i){var n,a=d(t.staff,i.step,i.accidentalClass),r=a.replace(/\d+$/,"");t.showLetterNames&&t.$staffEl.find('.note[data-note-id="'.concat(i.noteId,'"] .lettername')).text(r),"fixed"===i.source&&(t._fixedNote={letterWithAcc:r,letterOnly:r.replace(/[#b]+$/,"")},t._fixedState={step:i.step,accidentalClass:i.accidentalClass||null,midi:i.midi},null===(n=t._onFixedNoteState)||void 0===n||n.call(t,i,a,r)),console.log("fixed"===i.source?"Fixed note:":"User note:",a,{midi:i.midi,noteId:i.noteId,step:i.step,clef:t.staff.getClef()})})}},{key:"_wireControls",value:function(){var t=this;$("#clear").off("click.".concat(this.ns)).on("click.".concat(this.ns),function(){return t.staff.clearNotes()}),this.$checkBtn.off("click.".concat(this.ns)).on("click.".concat(this.ns),function(){return t._onCheck()}),this.$helpBtn.off("click.".concat(this.ns,"Help")).on("click.".concat(this.ns,"Help"),function(){t._usedHintThisRound=!0,t._showHintNote()}),this.$skipBtn.off("click.".concat(this.ns,"Skip")).on("click.".concat(this.ns,"Skip"),function(e){e.preventDefault(),t._finishRoundAsTimedOut()}),this._continueBound||(this._continueBound=!0,$("#continue button").off("click.".concat(this.ns)).on("click.".concat(this.ns),function(){$("#continue").hide(),t._hideSkipRoundButton(),t._hideTimeUpMessage(),t._setTimedOutInteractivityDisabled(!1),t._resetRoundTimerIfEnabled(),t.newChallenge(),t._armUiGates({resetInstructions:!1}),t.$checkBtn.enable()}))}},{key:"_instructionsAfterUserNotes",value:function(){var t=Number(this.opts.instructionsAfterUserNotes);return Number.isFinite(t)&&t>=0?Math.floor(t):1}},{key:"_checkAfterUserNotes",value:function(){var t=Number(this.opts.checkAfterUserNotes);return Number.isFinite(t)&&t>=0?Math.floor(t):1}},{key:"_armUiGates",value:function(){var t=this,e=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).resetInstructions,i=this._instructionsAfterUserNotes(),n=this._checkAfterUserNotes();e&&(this._instructionsRemoved=!1),$("#check").show().addClass("invisible"),this._userNotesSinceGate=0,this.$staffEl.off("staff:userNoteAdded._uiGate.".concat(this.ns)).on("staff:userNoteAdded._uiGate.".concat(this.ns),function(){t._userNotesSinceGate+=1,!t._instructionsRemoved&&t._userNotesSinceGate>=i&&($("#instructions").remove(),t._instructionsRemoved=!0),t._userNotesSinceGate>=n&&($("#check").removeClass("invisible"),t.$staffEl.off("staff:userNoteAdded._uiGate.".concat(t.ns)))})}},{key:"_initialNoteRangeIndex",value:function(){var t=null!=this.opts.initialNoteRange?this.opts.initialNoteRange:null!=this.opts.range?this.opts.range:void 0;if(null==t)throw new Error("[BaseStaffGame] Missing required option: initialNoteRange (0=narrow, 1=wide, 2=full).");var e=Number(t);if(!Number.isFinite(e))throw new Error("[BaseStaffGame] initialNoteRange must be a number (0, 1, or 2). Got: ".concat(String(t)));var i=Math.trunc(e);return 0===i||1===i||2===i?i:(console.warn("[BaseStaffGame] initialNoteRange out of range; defaulting to 2 (full).",{value:t}),2)}},{key:"_clefMainLineStep",value:function(t){switch(String(t||"").trim().toLowerCase()){case"bass":case"tenor":return 6;case"alto":return 4;default:return 2}}},{key:"_initialFixedStepBounds",value:function(){var t=this.staff.minStepAllowed(),e=this.staff.maxStepAllowed(),i=this._initialNoteRangeIndex();if(2===i)return{min:t,max:e};var n=this._clefMainLineStep(this.staff.getClef()),a=2*(0===i?1:2);return{min:Math.max(t,n-a),max:Math.min(e,n+a)}}},{key:"_isStepInInitialFixedRange",value:function(t){if(!Number.isFinite(t))return!1;var e=this._initialFixedStepBounds(),i=e.min,n=e.max;return t>=i&&t<=n}},{key:"_randomInitialFixedStep",value:function(){var t=this._initialFixedStepBounds(),e=t.min,i=t.max;return Math.floor(Math.random()*(i-e+1))+e}},{key:"_computeHintAnswer",value:function(){return null}},{key:"_computeHintAnswers",value:function(){var t=this._computeHintAnswer();return t?[t]:[]}},{key:"_removeAllHintNotes",value:function(){var t=this;(Array.isArray(this._activeHintIds)?this._activeHintIds:[]).forEach(function(e){return t.staff.removeNote(e)}),this._activeHintIds=[]}},{key:"_randomFreeStep",value:function(){for(var t=this.staff.minStepAllowed(),e=this.staff.maxStepAllowed(),i=0;i<50;i++){var n=Math.floor(Math.random()*(e-t+1))+t;if(!this.staff._isStepOccupied(n,null))return n}return null}},{key:"_attachHintBlinkRemoval",value:function(t){var e=this,i=this.$staffEl.find('.note[data-note-id="'.concat(t,'"]'));i.length&&i.off("animationend.hint.".concat(t," webkitAnimationEnd.hint.").concat(t)).one("animationend.hint.".concat(t," webkitAnimationEnd.hint.").concat(t),function(){e.staff.removeNote(t),e._activeHintIds=(e._activeHintIds||[]).filter(function(e){return e!==t})})}},{key:"_showHintNote",value:function(){this._removeAllHintNotes();var t=this._computeHintAnswers(),e=Array.isArray(t)&&t.length?t:[{step:null,accidentalClass:null}];this._activeHintIds=[];for(var i=0;i<e.length;i++){var n=e[i]||{},a=n.id||(1===e.length?"hint":"hint".concat(i+1)),r=Number.isFinite(n.step)?Number(n.step):null,s=n.accidentalClass||null;null==r&&(r=this._randomFreeStep()),null!=r&&this.staff.addNote({id:a,step:r,className:"hint blink",allowOccupied:!0,skipResolve:!0})&&(this._activeHintIds.push(a),s&&(this.staff.attachAccidentalToNote(a,s),this.$staffEl.find('.accidental[data-for-note-id="'.concat(a,'"]')).addClass("hint blink")),this.$staffEl.find('.ledger[data-for-note-id="'.concat(a,'"]')).addClass("hint blink"),this._attachHintBlinkRemoval(a))}}},{key:"_isPracticeMode",value:function(){var t=this.opts.practiceMode;return!0===t||"on"===String(t||"").trim().toLowerCase()}},{key:"_syncPracticeUi",value:function(){var t=this._isPracticeMode(),e=$("#score");t?(e.hide(),this.$progressBar.parent().addClass("opacity-1")):(e.show(),this.$progressBar.parent().removeClass("opacity-1"))}},{key:"_successAnimation",value:function(){(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).isBonus?this._playSuccessSfxBonus():this._playSuccessSfxBasic(),this.$helpBtn.hide(),this.$accidentals.addClass("invisible"),this.$feedback.find(".message span").text(s(this.successPhrases)),this.$feedback.stop(!0,!0).fadeIn("fast")}},{key:"_showIncrement",value:function(t){var e=this.$increment;e&&e.length&&(e.stop(!0,!0),e.text("+".concat(t)).show(),e.animateCSS?e.animateCSS("fadeOutUp").then(function(){return e.hide()}):setTimeout(function(){return e.hide()},800))}},{key:"_showBonusBadge",value:function(t){this.$bonusBadge&&this.$bonusBadge.length&&(!t||t<=0?this.$bonusBadge.hide():(this.$bonusBadge.text("+".concat(t," BONUS")).show(),this.$bonusBadge.animateCSS&&this.$bonusBadge.animateCSS("tada")))}},{key:"_awardPointsForCorrect",value:function(){if(this._isPracticeMode())return this.$points.text("0"),this._showBonusBadge(0),{earned:0,firstTry:!1,bonusEarned:0};if(this._usedHintThisRound)return this._showBonusBadge(0),{earned:0,firstTry:!1,bonusEarned:0};var t=!this._madeMistakeThisRound,e=Number.isFinite(this.opts.basePoints)?this.opts.basePoints:1,i=Number.isFinite(this.opts.firstTryBonus)?this.opts.firstTryBonus:0,n=t?e+i:e,a=t?i:0;return t&&(this._correctStreak+=1,this._correctStreak<=1?console.log("[BaseStaffGame] Correct answer. No streak yet."):console.log("[BaseStaffGame] Streak ".concat(this._correctStreak,"x"))),this.points+=n,this.$points.text(String(this.points)),this._showBonusBadge(a),{earned:n,firstTry:t,bonusEarned:a}}},{key:"getCorrectStreak",value:function(){return Math.max(0,Number(this._correctStreak)||0)}},{key:"_resetProgress",value:function(){this._syncPracticeUi(),this._correctStreak=0,this._madeAnyMistake=!1,this.$progressBar.data("progress",0),this.$progressBar.css({width:"0%"}),this._isPracticeMode()?this.$progressCounter.text("Practice"):this.$progressCounter.text("")}},{key:"_updateProgressBar",value:function(){if(this._isPracticeMode())return this.$progressBar.data("progress",0),this.$progressBar.css({width:"0%"}),this.$progressCounter.text("Practice"),0;var t=Math.max(1,this.numOfChallenges||1),e=100/t,i=parseFloat(this.$progressBar.data("progress"))||0;i=Math.min(100,i+e),this.$progressBar.data("progress",i),this.$progressBar.css({width:"".concat(i,"%")});var n=Math.min(t,Math.max(0,Math.round(i/e)));return this.$progressCounter.text("".concat(n," of ").concat(t)),i}},{key:"_failAnimation",value:function(t){var e=this;this._correctStreak=0,this._playFailSfx();var i=t||this.$checkWrap;i.removeClass("animate__animated animate__shakeX"),i[0]&&i[0].offsetWidth,i.addClass("animate__animated animate__shakeX"),i.off("animationend._fail.".concat(this.ns," webkitAnimationEnd._fail.").concat(this.ns," oAnimationEnd._fail.").concat(this.ns," MSAnimationEnd._fail.").concat(this.ns)).one("animationend._fail.".concat(this.ns," webkitAnimationEnd._fail.").concat(this.ns," oAnimationEnd._fail.").concat(this.ns," MSAnimationEnd._fail.").concat(this.ns),function(){i.removeClass("animate__animated animate__shakeX"),e.$checkBtn.enable()})}},{key:"_showFinalResults",value:function(){var t,e,i,n,a=this;if(!this._isPracticeMode()){var r=Math.max(0,null!==(t=this._stats.checksTotal)&&void 0!==t?t:0),s=Math.max(0,null!==(e=this._stats.checksCorrect)&&void 0!==e?e:0),o=r?Math.round(s/r*100):0,l=null!==(i=this._stats.finishedAtMs)&&void 0!==i?i:Date.now(),c=Math.max(0,Math.floor((l-M)/1e3)),u=r>0&&!this._madeAnyMistake,f=u?2*this.points:this.points;u?(setTimeout(function(){var t,e;null===(t=a.$doublePoints)||void 0===t||null===(e=t.show)||void 0===e||e.call(t),a._playPerfectGameBonusSfx()},1750),console.log("[BaseStaffGame] Perfect game! 2x bonus applied.",{basePoints:this.points,finalPoints:f})):console.log("[BaseStaffGame] No perfect-game bonus.",{basePoints:this.points,finalPoints:f,madeAnyMistake:this._madeAnyMistake});var h=null===(n=window)||void 0===n||null===(n=n.CountUp)||void 0===n?void 0:n.CountUp,d=function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=a.$finalOverlay.find(t)[0];if(n)if(h){var r=new h(n,e,T({duration:3.5},i));r.error||r.start()}else n.textContent=String(i.formattingFn?i.formattingFn(e):e)+(i.suffix||"")};d('span[name="rounds"]',this.numOfChallenges),d('span[name="score"]',f),d('span[name="accuracy"]',o,{suffix:"%"}),d('span[name="duration"]',c,{formattingFn:function(t){var e=Math.max(0,Math.floor(t)),i=String(Math.floor(e/60)).padStart(2,"0"),n=String(e%60).padStart(2,"0");return"".concat(i,":").concat(n)}});var p=this.$finalOverlay.find("#result-greeting"),v=p.find("h1"),_=p.find("h6");o<50?(v.text("Keep going!"),_.text("That round was tough, but your next one can be much better.")):(v.text("Great job!"),_.text("It's not about getting the most points, but if it was...")),this._playFinalSfx(),this.$finalOverlay.show()}}}],i&&N(e.prototype,i),n&&N(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e;var e,i,n,a,r}();function F(t){return 2===t?"music-font__doublesharp":1===t?"music-font__sharp":0===t?"music-font__natural":-1===t?"music-font__flat":-2===t?"music-font__doubleflat":null}function P(t,e){var i=function(t){var e=String(t||"").trim().match(/^([A-Ga-g])((?:#{1,2})|(?:b{1,2})|)?(\d+)$/);if(!e)return null;var i=e[1].toUpperCase(),n=e[2]||"",a="##"===n?2:"#"===n?1:"bb"===n?-2:"b"===n?-1:0;return{midi:12*(parseInt(e[3],10)+1)+{C:0,D:2,E:4,F:5,G:7,A:9,B:11}[i]+a,accOffset:a,accidentalClass:F(a)}}(e);if(!i)return null;for(var n=i.midi,a=i.accOffset,r=i.accidentalClass,s=t.minStepAllowed();s<=t.maxStepAllowed();s+=1){if(t._stepToMidi(s)+a===n)return{step:s,accidentalClass:r}}for(var o=null,l=t.minStepAllowed();l<=t.maxStepAllowed();l+=1){var c=t._stepToMidi(l),u=Math.abs(c+a-n);(!o||u<o.dist)&&(o={step:l,dist:u})}return o?{step:o.step,accidentalClass:r}:null}function B(t){return B="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},B(t)}function D(t,e){var i="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!i){if(Array.isArray(t)||(i=G(t))||e&&t&&"number"==typeof t.length){i&&(t=i);var n=0,a=function(){};return{s:a,n:function(){return n>=t.length?{done:!0}:{done:!1,value:t[n++]}},e:function(t){throw t},f:a}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,s=!0,o=!1;return{s:function(){i=i.call(t)},n:function(){var t=i.next();return s=t.done,t},e:function(t){o=!0,r=t},f:function(){try{s||null==i.return||i.return()}finally{if(o)throw r}}}}function I(t){return function(t){if(Array.isArray(t))return j(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||G(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function G(t,e){if(t){if("string"==typeof t)return j(t,e);var i={}.toString.call(t).slice(8,-1);return"Object"===i&&t.constructor&&(i=t.constructor.name),"Map"===i||"Set"===i?Array.from(t):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?j(t,e):void 0}}function j(t,e){(null==e||e>t.length)&&(e=t.length);for(var i=0,n=Array(e);i<e;i++)n[i]=t[i];return n}function U(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)}return i}function L(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?U(Object(i),!0).forEach(function(e){q(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):U(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function Y(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,V(n.key),n)}}function W(t,e,i){return e=Q(e),function(t,e){if(e&&("object"==B(e)||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}(t,H()?Reflect.construct(e,i||[],Q(t).constructor):e.apply(t,i))}function H(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){}))}catch(t){}return(H=function(){return!!t})()}function Q(t){return Q=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},Q(t)}function X(t,e){return X=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},X(t,e)}function q(t,e,i){return(e=V(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function V(t){var e=function(t,e){if("object"!=B(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=B(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==B(e)?e:e+""}E(R,"MIN_CHALLENGES",2),E(R,"MAX_CHALLENGES",12);var z=function(t){function e(){var t,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e);var n={staffEl:"#staff",basePoints:1,firstTryBonus:2,namespace:"chordsChallenge",instructionsAfterUserNotes:2,checkAfterUserNotes:2,allowInversions:!1,initialRoot:!0},a=L(L(L({},n),i),{},{accidentalWeights:L(L({},n.accidentalWeights||{}),i.accidentalWeights||{}),triadQualities:Array.isArray(i.triadQualities)&&i.triadQualities.length?i.triadQualities.slice():Object.keys(e.TRIAD_QUALITY_FULL_NAME_MAP)}),r=function(t){for(var e=(Array.isArray(t)?t:null!=t?[t]:["treble","bass"]).map(function(t){return c(t)}).filter(Boolean),i=[],n=0;n<e.length;n+=1)i.includes(e[n])||i.push(e[n]);return i.length?i:["treble","bass"]}(null!=a.clefs?a.clefs:a.clef);return(t=W(this,e,[L(L({},a),{},{initialClef:r&&r[0]?r[0]:"treble"})]))._clefPool=r,t.$interval=$("#interval"),t.$intervalLabel=t.$interval.find("label"),t.$intervalFull=t.$interval.find("div"),t._currentTriadQuality=null,t._currentSeventhType=null,t._requiredUserNotesThisRound=2,t._triadRootState=null,t._triadBassState=null,t._triadRootLetterWithAcc=null,t}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&X(t,e)}(e,t),i=e,n=[{key:"_setTriadUI",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;this._currentTriadQuality=String(t||"").trim(),this._currentSeventhType=e?String(e).trim():null,this.$interval.removeClass("text-red").addClass("text-blue"),this._refreshTriadUILabels()}},{key:"_escapeHtml",value:function(t){return String(t).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")}},{key:"_formatShortLabelHtml",value:function(t){return this._escapeHtml(t).replaceAll("ø","<sup>ø</sup>").replace(/(^[A-G](?:bb|b|##|#)?)o(?=\d|$)/,"$1<sup>o</sup>")}},{key:"_triadShortName",value:function(t,i){var n,a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=String(t||"").trim(),s=String(i||"").trim();if("diminished"===s&&a)return"".concat(r,"dim7"===a?"°":"ø");var o=null!==(n=e.TRIAD_QUALITY_SHORT_SUFFIX_MAP[s])&&void 0!==n?n:"",l="".concat(r).concat(o);return a?"".concat(l,"maj7"===a?"maj7":"7"):l}},{key:"_triadFullName",value:function(t,i){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,a=String(t||"").trim(),r=String(i||"").trim(),s=e.TRIAD_QUALITY_FULL_NAME_MAP[r]||r;if("diminished"===r&&n)return"".concat(a," ").concat("dim7"===n?"fully diminished":"half diminished").trim();if(!n)return"".concat(a," ").concat(s).trim();var o="maj7"===n?"M7":"m7";return"".concat(a," ").concat(s," with a ").concat(o).trim()}},{key:"_refreshTriadUILabels",value:function(){var t,i,n=this._currentTriadQuality,a=this._triadRootLetterWithAcc||(this._fixedNote&&this._fixedNote.letterWithAcc&&"?"!==this._fixedNote.letterWithAcc?this._fixedNote.letterWithAcc:null),r=a?this._triadShortName(a,n,this._currentSeventhType):n,s=a?this._triadFullName(a,n,this._currentSeventhType):e.TRIAD_QUALITY_FULL_NAME_MAP[n]||n;null!==(t=this.$intervalLabel)&&void 0!==t&&t.length&&this.$intervalLabel.html(this._formatShortLabelHtml(r)),null!==(i=this.$intervalFull)&&void 0!==i&&i.length&&this.$intervalFull.text(s)}},{key:"_onFixedNoteState",value:function(){this._refreshTriadUILabels()}},{key:"_resetTriadContext",value:function(){this._triadRootState=null,this._triadBassState=null,this._triadRootLetterWithAcc=null}},{key:"_triadExpectedSemisForQuality",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=String(t||"").trim();if(!e)return{major:[4,7],minor:[3,7],augmented:[4,8],diminished:[3,6]}[i]||null;if("augmented"===i)return"7"!==e?null:[4,8,10];if("maj7"===e&&"major"!==i)return null;if("dim7"===e&&"diminished"!==i)return null;var n="maj7"===e?11:"dim7"===e?9:10,a={major:[4,7],minor:[3,7],diminished:[3,6]}[i];return a?[a[0],a[1],n]:null}},{key:"_toneAccidentalClass",value:function(t,e,i){for(var n=t+i-this.staff._stepToMidi(e);n>6;)n-=12;for(;n<-6;)n+=12;var a=F(n);return null==a&&0!==n?null:a}},{key:"_stepAboveBass",value:function(t,e){for(var i=t;i<=e;)i+=7;return i}},{key:"_pickRootAndBassForTriad",value:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,i=this._triadExpectedSemisForQuality(t,e);if(!i)return null;var n=this.staff.minStepAllowed(),a=this.staff.maxStepAllowed(),c=void 0===this.opts.initialRoot||!!this.opts.initialRoot,u=!!this.opts.allowInversions||!c,f=l(this.opts.fixedNotes).filter(Boolean);if(u&&f.length){var h=this._pickFixedNote();if(!h)return null;var d,p=this.staff._accidentalClassToOffset(h.accidentalClass),v=this.staff._stepToMidi(h.step)+p,_=[{rootStep:h.step,roleSemis:0},{rootStep:h.step-2,roleSemis:i[0]},{rootStep:h.step-4,roleSemis:i[1]}].concat(I(3===i.length?[{rootStep:h.step-6,roleSemis:i[2]}]:[])).filter(function(t){return t.rootStep>=n&&t.rootStep<=a}),m=[],g=D(_);try{for(g.s();!(d=g.n()).done;){var y=d.value,S=v-y.roleSemis,b=S-this.staff._stepToMidi(y.rootStep),k=F(b);if(null!=k||0===b){var w=y.rootStep+2,A=y.rootStep+4,x=3===i.length?y.rootStep+6:null;if(!(w<n||w>a||A<n||A>a||null!=x&&(x<n||x>a))){var C=this._toneAccidentalClass(S,w,i[0]),T=this._toneAccidentalClass(S,A,i[1]),$=null!=x?this._toneAccidentalClass(S,x,i[2]):null;null!=C&&null!=T&&(null!=x&&null==$||m.push({root:{step:y.rootStep,accidentalClass:k},bass:{step:h.step,accidentalClass:h.accidentalClass||null}}))}}}}catch(t){g.e(t)}finally{g.f()}if(m.length)return s(m)}var N=3===i.length?6:4,E=n,O=Math.max(n,a-N);if(O<E)return null;var M=this._initialFixedStepBounds(),R=null,P=0;if(u){for(var B=3===i.length?[0,1,2,3]:[0,1,2],G=0;G<80;G+=1){var j=r(E,O),U=s(B),L=j+2,Y=j+4,W=3===i.length?j+6:null,H=0===U?j:1===U?L:2===U?Y:W;if(this._isStepInInitialFixedRange(H)){R=j,P=U;break}}null==R&&(R=r(E,O),P=s(B))}else{var Q=Math.max(E,M.min),X=Math.min(O,M.max);if(X<Q)return null;R=r(Q,X)}var q=this.opts.accidentalWeights||{},V=o([{value:null,weight:Number(q.natural)||0},{value:"music-font__sharp",weight:Number(q.sharp)||0},{value:"music-font__flat",weight:Number(q.flat)||0}]),z=this.staff._stepToMidi(R)+this.staff._accidentalClassToOffset(V),K=R+2,J=R+4,Z=3===i.length?R+6:null,tt=this._toneAccidentalClass(z,K,i[0]),et=this._toneAccidentalClass(z,J,i[1]),it=null!=Z?this._toneAccidentalClass(z,Z,i[2]):null;if(null==tt||null==et)return null;if(null!=Z&&null==it)return null;var nt=0===P?R:1===P?K:2===P?J:Z,at=0===P?0:1===P?i[0]:2===P?i[1]:i[2],rt=this._toneAccidentalClass(z,nt,at);return null==rt&&0!==at?null:{root:{step:R,accidentalClass:V},bass:{step:nt,accidentalClass:rt}}}},{key:"newChallenge",value:function(){var t,e;this.$helpBtn.hide(),this._fixedState=null,this._resetTriadContext();var i,n,a=(i=this._clefPool,1===(n=Array.isArray(i)&&i.length?i:["treble","bass"]).length?n[0]:n[Math.floor(Math.random()*n.length)]);a&&a!==this.staff.getClef()&&this.staff.setClef(a),this._madeMistakeThisRound=!1,this._usedHintThisRound=!1,this.$bonusBadge.hide(),null===(t=this.$doublePoints)||void 0===t||null===(e=t.hide)||void 0===e||e.call(t);for(var r=null,s=null,o=null,l=0;l<40;l+=1){var c=this._pickChordSpec();if(r=c.quality,s=c.seventhType,(o=this._pickRootAndBassForTriad(r,s))&&("diminished"!==r||"dim7"!==s||"music-font__flat"!==o.root.accidentalClass&&"music-font__doubleflat"!==o.root.accidentalClass||(s="7",o=this._pickRootAndBassForTriad(r,s))))break}if(o||(r="major",s=null,o=this._pickRootAndBassForTriad(r,s))){this._requiredUserNotesThisRound=this._requiredUserNotesForChord(s),this.opts.instructionsAfterUserNotes=this._requiredUserNotesThisRound,this.opts.checkAfterUserNotes=this._requiredUserNotesThisRound,this.opts.maxUserNotes=this._requiredUserNotesThisRound,this.staff.clearNotes(),this.$accidentals.removeClass("invisible"),this.$feedback.hide(),this.$interval.show(),this._setTriadUI(r,s);var u=this.staff._stepToMidi(o.root.step)+this.staff._accidentalClassToOffset(o.root.accidentalClass);this._triadRootState={step:o.root.step,accidentalClass:o.root.accidentalClass||null,midi:u},this._triadBassState={step:o.bass.step,accidentalClass:o.bass.accidentalClass||null,midi:this.staff._stepToMidi(o.bass.step)+this.staff._accidentalClassToOffset(o.bass.accidentalClass)};var f=d(this.staff,o.root.step,o.root.accidentalClass);this._triadRootLetterWithAcc=String(f||"").replace(/\d+$/,"")||null;var h="music-font__natural"===o.bass.accidentalClass?null:o.bass.accidentalClass||null,p=this.staff.addFixedNote({step:o.bass.step,accidentalClass:h});p&&this.staff._emitNoteState(p,"fixed"),$("#continue").hide()}}},{key:"_pickChordSpec",value:function(){if(!this.opts.only7thChords)return{quality:this._pickTriadQuality(),seventhType:null};var t=Array.isArray(this.opts.triadQualities)&&this.opts.triadQualities.length?this.opts.triadQualities:Object.keys(e.TRIAD_QUALITY_FULL_NAME_MAP),i=t.length?t:["major","minor","diminished","augmented"],n=i[Math.floor(Math.random()*i.length)];return"major"===n?{quality:n,seventhType:s(["7","maj7"])}:"minor"===n?{quality:n,seventhType:"7"}:"diminished"===n?{quality:n,seventhType:s(["7","dim7"])}:"augmented"===n?{quality:n,seventhType:"7"}:{quality:n,seventhType:null}}},{key:"_requiredUserNotesForChord",value:function(t){return t?3:2}},{key:"_pickTriadQuality",value:function(){var t=Array.isArray(this.opts.triadQualities)&&this.opts.triadQualities.length?this.opts.triadQualities:["major"];return t[Math.floor(Math.random()*t.length)]}},{key:"_pickFixedNote",value:function(){var t=l(this.opts.fixedNotes).filter(Boolean);if(t.length){var e=s(t);return P(this.staff,e)}var i=this.opts.accidentalWeights||{},n=o([{value:null,weight:Number(i.natural)||0},{value:"music-font__sharp",weight:Number(i.sharp)||0},{value:"music-font__flat",weight:Number(i.flat)||0}]);return{step:this._randomInitialFixedStep(),accidentalClass:n}}},{key:"_notesOnStaffOrdered",value:function(){var t=this,e=this.$staffEl.find(".note").not(".preview").not(".hint").toArray().map(function(e){var i=e.getAttribute("data-note-id"),n=t.staff._stepOfNoteEl(e),a=t.staff._getAttachedAccidentalClass(i);return{id:i,step:n,accOff:t.staff._accidentalClassToOffset(a),fixed:e.classList.contains("fixed")}});return e.sort(function(t,e){return t.step-e.step}),e}},{key:"_onCheck",value:function(){var t=this,e=this._notesOnStaffOrdered();this.$checkBtn.disable(),this._stats.checksTotal+=1;var i=this._triadExpectedSemisForQuality(this._currentTriadQuality,this._currentSeventhType),n=this._triadRootState,a=this._requiredUserNotesThisRound+1;if(e.length!==a)return this._madeAnyMistake=!0,this._madeMistakeThisRound=!0,this.$interval.removeClass("text-blue").addClass("text-red"),this._failAnimation(this.$checkWrap),this.$checkBtn[0]&&this.$checkBtn[0].blur&&this.$checkBtn[0].blur(),void this.$helpBtn.show();if(!i||!n)return this._madeAnyMistake=!0,this._madeMistakeThisRound=!0,void this.$helpBtn.show();var r,s=n.step,o=n.midi,l=3===i.length?{0:0,2:i[0],4:i[1],6:i[2]}:{0:0,2:i[0],4:i[1]},c=new Set,u=!0,f=D(e);try{for(f.s();!(r=f.n()).done;){var h=r.value,d=((h.step-s)%7+7)%7;if(!(3===i.length?0===d||2===d||4===d||6===d:0===d||2===d||4===d)){u=!1;break}if(c.has(d)){u=!1;break}c.add(d);var p=(this.staff._stepToMidi(h.step)+(h.accOff||0)-o)%12;if(p<0&&(p+=12),p!==l[d]){u=!1;break}}}catch(t){f.e(t)}finally{f.f()}if(u){this._stats.checksCorrect+=1,this._pauseGameTimer();var v=this._awardPointsForCorrect(),_=v.earned,m=v.bonusEarned;this._successAnimation({isBonus:m>0}),this.$interval.hide(),$("#score").animateCSS&&$("#score").animateCSS("heartBeat"),_>0&&this._showIncrement(_),this._updateProgressBar()>=100?(this._stats.finishedAtMs=Date.now(),this.$checkBtn.text("Final results, let's see…"),setTimeout(function(){return t._showFinalResults()},1600)):($("#check").hide(),$("#continue").show())}else this._madeAnyMistake=!0,this._madeMistakeThisRound=!0,this.$interval.removeClass("text-blue").addClass("text-red"),this._failAnimation(this.$checkWrap),this.$checkWrap.off("animationend._failRestore.".concat(this.ns," webkitAnimationEnd._failRestore.").concat(this.ns)).one("animationend._failRestore.".concat(this.ns," webkitAnimationEnd._failRestore.").concat(this.ns),function(){t.$interval.removeClass("text-red").addClass("text-blue")}),this.$helpBtn.show()}},{key:"_computeHintAnswers",value:function(){var t=this,e=this._notesOnStaffOrdered();if(e.length<1)return[];var i=this._triadExpectedSemisForQuality(this._currentTriadQuality,this._currentSeventhType),n=this._triadRootState,a=this._triadBassState;if(!i||!n||!a)return[];var r,s=n.step,o=n.midi,l=a.step,c=new Set,u=D(e);try{for(u.s();!(r=u.n()).done;){var f=r.value,h=((f.step-s)%7+7)%7;if(3===i.length?0===h||2===h||4===h||6===h:0===h||2===h||4===h){var d=(this.staff._stepToMidi(f.step)+(f.accOff||0)-o)%12;d<0&&(d+=12),d===(0===h?0:2===h?i[0]:4===h?i[1]:i[2])&&c.add(h)}}}catch(t){u.e(t)}finally{u.f()}var p,v=this.staff.minStepAllowed(),_=this.staff.maxStepAllowed(),m=function(e,i,n){if(i<v||i>_)return null;var a=t._toneAccidentalClass(o,i,n);return null==a&&0!==n?null:{id:e,step:i,accidentalClass:a}},g=[],y=D([{role:0,id:"hintR",baseStep:s,semis:0},{role:2,id:"hint3",baseStep:s+2,semis:i[0]},{role:4,id:"hint5",baseStep:s+4,semis:i[1]}].concat(I(3===i.length?[{role:6,id:"hint7",baseStep:s+6,semis:i[2]}]:[])));try{for(y.s();!(p=y.n()).done;){var S=p.value;if(!c.has(S.role)){var b=this._stepAboveBass(S.baseStep,l);b>_&&(b=S.baseStep);var k=m(S.id,b,S.semis);k&&g.push(k)}}}catch(t){y.e(t)}finally{y.f()}return g.slice(0,this._requiredUserNotesThisRound)}}],n&&Y(i.prototype,n),a&&Y(i,a),Object.defineProperty(i,"prototype",{writable:!1}),i;var i,n,a}(R);function K(t){return K="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},K(t)}function J(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),i.push.apply(i,n)}return i}function Z(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{};e%2?J(Object(i),!0).forEach(function(e){tt(t,e,i[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):J(Object(i)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))})}return t}function tt(t,e,i){return(e=function(t){var e=function(t,e){if("object"!=K(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var n=i.call(t,e||"default");if("object"!=K(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==K(e)?e:e+""}(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}q(z,"TRIAD_QUALITY_FULL_NAME_MAP",{major:"major",minor:"minor",augmented:"augmented",diminished:"diminished"}),q(z,"TRIAD_QUALITY_SHORT_SUFFIX_MAP",{major:"",minor:"m",augmented:"aug",diminished:"°"});var et=readGlobal("__challengeOptions")||{},it=readGlobal("__clefUrls")||null;new z(Z(Z({},et),{},{clefUrls:it})).start()})();